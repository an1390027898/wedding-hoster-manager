<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="婚礼主持管家">
    <meta name="format-detection" content="telephone=no">
    <title>婚礼主持管家 - 专业高级版</title>
    <style>
        :root {
            --primary: #e91e63;
            --primary-light: #f8bbd9;
            --primary-dark: #c2185b;
            --secondary: #7b1fa2;
            --light: #f5f5f5;
            --dark: #333;
            --gray: #757575;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196f3;
        }
        
        /* 选中卡片样式 */
        .content-card.active {
            border: 2px solid var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.2) !important;
            background-color: rgba(233, 30, 99, 0.05) !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 头部样式 */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .app-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .app-title h1 {
            font-size: 1.8rem;
        }
        
        .app-subtitle {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        /* 导航样式 */
        .app-nav {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* 模拟手机UI */
        .phone-mockup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 375px;
            height: 812px;
            background-color: #fff;
            border: 20px solid #333;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 2000;
            overflow: hidden;
        }
        
        .phone-mockup.active {
            display: block;
        }
        
        .phone-screen {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 0;
            background-color: #f9f9f9;
        }
        
        .phone-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            z-index: 10;
        }
        
        .phone-content {
            padding: 64px 16px 16px;
            height: 100%;
            overflow-y: auto;
        }
        
        /* 关闭手机模拟按钮 */
        .close-phone-mockup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 2100;
        }
        
        /* 切换手机模拟按钮 */
        .toggle-phone-mockup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(233,30,99,0.3);
            z-index: 1999;
            transition: all 0.3s ease;
        }
        
        .toggle-phone-mockup:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
        }
        
        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--gray);
            border-bottom: 3px solid transparent;
        }
        
        .nav-item.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: rgba(233, 30, 99, 0.05);
        }
        
        .nav-item:hover:not(.active) {
            background-color: rgba(0,0,0,0.02);
        }
        
        /* 主内容区 */
        .main-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* 页脚 */
        .app-footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 36px;
            min-width: 36px;
            -webkit-tap-highlight-color: transparent;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-height: 36px;
            min-width: 36px;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e68900;
        }
        
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #0b7dda;
        }
        
        /* 工具条 */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .toolbar-title {
            font-size: 1.4rem;
            color: var(--dark);
        }
        
        /* 视图切换按钮 */
        .view-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin-left: 15px;
        }
        
        .view-btn {
            padding: 8px 15px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .view-btn.active {
            background-color: var(--primary);
            color: white;
        }
        
        /* 年份切换 */
        .year-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin-left: 15px;
        }
        
        .year-btn {
            padding: 8px 15px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .year-btn.active {
            background-color: var(--info);
            color: white;
        }
        
        /* 统计图表容器 */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .chart-container {
            height: 250px;
            position: relative;
        }
        
        .chart-bar {
            display: flex;
            align-items: flex-end;
            height: 200px;
            margin-top: 20px;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
        }
        
        .bar {
            width: 30px;
            background: linear-gradient(to top, var(--primary), var(--secondary));
            border-radius: 3px 3px 0 0;
            transition: height 0.5s;
            position: relative;
        }
        
        .bar-income {
            background: linear-gradient(to top, var(--success), #8bc34a);
        }
        
        .bar-label {
            margin-top: 5px;
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* 日历视图容器 - 修改：互斥显示 */
        .calendar-view {
            display: none;
        }
        
        .list-view-container {
            display: none;
        }
        
        .calendar-view.active-view {
            display: block;
        }
        
        .list-view-container.active-view {
            display: block;
        }
        
        /* 日历样式 */
        .calendar-container {
            width: 100%;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #eee;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background-color: #f5f5f5;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: var(--gray);
        }
        
        .calendar-day {
            background-color: white;
            padding: 10px;
            min-height: 120px;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .calendar-day:hover {
            background-color: #fafafa;
        }
        
        .calendar-day.empty {
            background-color: #fafafa;
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .day-reminder {
            background-color: var(--warning);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: help;
        }
        
        .event-indicator {
            display: block;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .event-wedding {
            background-color: rgba(233, 30, 99, 0.15);
            color: var(--primary-dark);
            border-left: 3px solid var(--primary);
        }
        
        .event-intent {
            background-color: rgba(255, 152, 0, 0.15);
            color: #e65100;
            border-left: 3px solid var(--warning);
        }
        
        .event-other {
            background-color: rgba(33, 150, 243, 0.15);
            color: #0d47a1;
            border-left: 3px solid #2196f3;
        }
        
        /* 列表视图样式 - 添加月份分隔线 */
        .events-list {
            list-style: none;
        }
        
        .month-divider {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            padding: 8px 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .event-list-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 100px 100px 1fr 150px 150px;
            gap: 15px;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .event-list-item:hover {
            background-color: #f9f9f9;
        }
        
        .event-list-item:last-child {
            border-bottom: none;
        }
        
        .event-list-date {
            font-weight: 600;
            color: var(--dark);
        }
        
        .event-list-type {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
        }
        
        .event-list-title {
            font-weight: 600;
            color: var(--dark);
        }
        
        .event-list-location {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .event-list-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            min-height: 44px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
            background-color: white;
        }
        
        /* 选择框样式 */
        select.form-control {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            padding-right: 45px;
        }
        
        /* 移动端选择框特殊处理 */
        @media (max-width: 768px) {
            select.form-control {
                padding-right: 40px;
                background-size: 18px;
                background-position: right 12px center;
            }
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 4px solid var(--primary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.2rem;
            color: var(--dark);
        }
        
        /* 数据列表 */
        .data-list {
            list-style: none;
        }
        
        .data-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .data-item:hover {
            background-color: #f9f9f9;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .item-info h4 {
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .item-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
        }
        
        /* 标签样式 */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-primary {
            background-color: rgba(233, 30, 99, 0.15);
            color: var(--primary-dark);
        }
        
        .badge-success {
            background-color: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }
        
        .badge-warning {
            background-color: rgba(255, 152, 0, 0.15);
            color: #e65100;
        }
        
        .badge-info {
            background-color: rgba(33, 150, 243, 0.15);
            color: #0d47a1;
        }
        
        .badge-danger {
            background-color: rgba(244, 67, 54, 0.15);
            color: #c62828;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            
            .app-header {
                padding: 15px;
            }
            
            .app-title {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .app-title h1 {
                font-size: 1.4rem;
            }
            
            /* 优化头部按钮 */
            .app-title {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .app-title h1 {
                font-size: 1.2rem;
            }
            
            .app-title div {
                display: flex;
                gap: 6px;
                width: 100%;
                flex-wrap: wrap;
            }
            
            .app-title .btn {
                flex: 1;
                min-width: 100px;
                padding: 6px 10px;
                font-size: 0.8rem;
                min-height: 34px;
            }
            
            /* 优化导航菜单 - 增强横向滚动体验 */
            .app-nav {
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                padding: 8px 0;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            .app-nav::-webkit-scrollbar {
                display: none;
            }
            
            .nav-item {
                flex-shrink: 0;
                padding: 14px 20px;
                font-size: 0.95rem;
                text-align: center;
                border-bottom: 3px solid transparent;
                transition: all 0.3s ease;
                cursor: pointer;
                min-width: fit-content;
                -webkit-tap-highlight-color: rgba(233, 30, 99, 0.1);
            }
            
            .nav-item:active {
                background-color: rgba(233, 30, 99, 0.1);
                transform: translateY(1px);
            }
            
            .nav-item.active {
                color: var(--primary);
                border-bottom-color: var(--primary);
                background-color: rgba(233, 30, 99, 0.05);
                font-weight: 600;
            }
            
            /* 优化按钮大小 */
            .btn {
                padding: 6px 12px;
                font-size: 0.8rem;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                min-height: 32px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 0.75rem;
                min-height: 28px;
            }
            
            /* 表单优化 */
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            /* 日历优化 */
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                font-size: 0.75rem;
                gap: 1px;
            }
            
            .calendar-header {
                font-size: 0.8rem;
                padding: 8px 2px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 3px;
                font-size: 0.8rem;
            }
            
            .event-indicator {
                font-size: 0.65rem;
                padding: 1px 3px;
                margin: 1px 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .calendar-nav {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
            }
            
            /* 优化上月下月按钮 */
            .calendar-nav .btn {
                width: auto;
                padding: 6px 12px;
                font-size: 0.85rem;
                min-height: 36px;
            }
            
            #currentMonth {
                margin: 0;
                font-size: 0.9rem;
            }
            
            /* 列表项优化 */
            .event-list-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            /* 工具栏优化 */
            .toolbar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .toolbar-title {
                font-size: 1.2rem;
            }
            
            /* 网格布局优化 */
            .music-layout {
                grid-template-columns: 1fr;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            /* 统计卡片优化 */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-card {
                padding: 8px;
                border-radius: 6px;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            /* 优化数据备份区域 */
            .backup-section {
                padding: 15px;
            }
            
            .backup-buttons {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .backup-buttons .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
                min-height: 40px;
            }
            
            /* 模态框优化 */
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            /* 修复苹果手机上的滚动问题 */
            body {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* 苹果手机特定优化 */
        @media only screen and (max-device-width: 480px) and (-webkit-min-device-pixel-ratio: 2) {
            .app-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .app-title button {
                width: 100%;
                margin-bottom: 5px;
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .nav-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 18px;
                font-size: 0.95rem;
            }
            
            .calendar-day {
                min-height: 70px;
            }
            
            /* 优化苹果手机上的触摸体验 */
            * {
                -webkit-tap-highlight-color: transparent;
            }
            
            .music-item, .template-card, .category-card {
                padding: 12px;
            }
            
            /* 优化统计卡片 */
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* 优化视图切换按钮 */
            .view-toggle, .year-toggle {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }
            
            /* 优化选择框大小 */
            select.form-control {
                padding: 12px 15px;
                font-size: 1rem;
            }
            
            /* 优化按钮大小 */
            .btn {
                padding: 12px 24px;
                font-size: 1rem;
            }
            
            .btn-small {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
        
        /* 模拟手机UI */
        .phone-mockup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 375px;
            height: 812px;
            background-color: #fff;
            border: 20px solid #333;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 2000;
            overflow: hidden;
        }
        
        .phone-mockup.active {
            display: block;
        }
        
        .phone-screen {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 0;
            background-color: #f9f9f9;
        }
        
        .phone-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            z-index: 10;
        }
        
        .phone-content {
            padding: 64px 16px 16px;
            height: 100%;
            overflow-y: auto;
        }
        
        /* 关闭手机模拟按钮 */
        .close-phone-mockup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 2100;
        }
        
        /* 切换手机模拟按钮 */
        .toggle-phone-mockup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(233,30,99,0.3);
            z-index: 1999;
            transition: all 0.3s ease;
        }
        
        .toggle-phone-mockup:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
        }
        
        /* 移动端导航容器 */
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .mobile-nav-overlay.active {
            display: block;
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        /* 选项卡 */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 时间轴 - 支持拖拽 */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--primary-light);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            border: 1px solid #eee;
            transition: all 0.3s;
            cursor: move;
        }
        
        .timeline-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .timeline-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary);
            z-index: 2;
        }
        
        .timeline-time {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .timeline-time-input {
            display: inline-block;
            width: 120px;
            padding: 3px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .timeline-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .custom-timeline-item {
            position: relative;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid var(--info);
            cursor: move;
        }
        
        .custom-timeline-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .custom-timeline-item::before {
            content: '✎';
            position: absolute;
            left: -25px;
            top: 15px;
            width: 20px;
            height: 20px;
            background-color: var(--info);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            z-index: 2;
        }
        
        .custom-timeline-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .custom-timeline-actions {
            display: flex;
            gap: 5px;
        }
        
        /* 音乐列表 - 修改：新的样式设计 */
        .music-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .music-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            border: 2px solid #eee;
            cursor: pointer;
        }
        
        .music-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .music-item.playing {
            background-color: rgba(76, 175, 80, 0.15);
            border-color: var(--success);
        }
        
        .music-item.paused {
            background-color: rgba(244, 67, 54, 0.08);
            border-color: var(--danger);
        }
        
        .music-item.inactive {
            background-color: white;
        }
        
        .music-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .music-artist {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .music-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .music-tag {
            background-color: rgba(233, 30, 99, 0.1);
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        /* 新的音乐播放器控件 */
        .music-player-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .music-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
            transition: background-color 0.3s;
        }
        
        .music-item.playing .music-status-indicator {
            background-color: var(--success);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
            animation: pulse 1.5s infinite;
        }
        
        .music-item.paused .music-status-indicator {
            background-color: var(--danger);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .music-progress {
            flex-grow: 1;
            height: 4px;
            background-color: #ddd;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .music-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.1s;
        }
        
        .music-time {
            font-size: 0.8rem;
            color: var(--gray);
            min-width: 40px;
            text-align: center;
        }
        
        .music-actions {
            display: flex;
            gap: 5px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        /* 多场次音乐播放系统 - 修改：与音乐库并列 */
        .music-session-system {
            margin-top: 0;
            border-top: none;
            padding-top: 0;
        }
        
        .session-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .session-select {
            flex: 1;
            max-width: 300px;
        }
        
        .session-playlist {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .session-track {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: move;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .session-track:hover {
            background-color: #f0f0f0;
        }
        
        .session-track.active {
            background-color: rgba(33, 150, 243, 0.1);
        }
        
        .session-track.playing {
            background-color: rgba(76, 175, 80, 0.15);
        }
        
        .session-track-number {
            width: 30px;
            font-weight: 600;
            color: var(--gray);
        }
        
        .session-track-info {
            flex: 1;
        }
        
        .session-track-title {
            font-weight: 500;
            color: var(--dark);
        }
        
        .session-track-artist {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .session-track-duration {
            font-size: 0.85rem;
            color: var(--gray);
            margin-left: 10px;
        }
        
        .session-track-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        /* 问卷模板管理 */
        .questionnaire-templates {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .template-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #eee;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .template-card.active {
            border-color: var(--primary);
            background-color: rgba(233, 30, 99, 0.03);
        }
        
        .template-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .template-desc {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .template-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .template-tag {
            background-color: #f0f0f0;
            color: var(--gray);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        /* 费用状态 */
        .fee-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .fee-paid {
            background-color: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }
        
        .fee-deposit {
            background-color: rgba(255, 152, 0, 0.15);
            color: #e65100;
        }
        
        .fee-unpaid {
            background-color: rgba(244, 67, 54, 0.15);
            color: #c62828;
        }
        
        /* 详情面板 - 优化布局 */
        .detail-panel {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-section:last-child {
            margin-bottom: 0;
        }
        
        .detail-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
            color: var(--dark);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 12px;
            align-items: start;
        }
        
        .detail-label {
            font-weight: 500;
            color: var(--gray);
            padding: 5px 0;
        }
        
        .detail-value {
            color: var(--dark);
            padding: 5px 0;
        }
        
        /* 数据备份区域 */
        .backup-section {
            background-color: #f0f7ff;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .backup-section h3 {
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .backup-section p {
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        
        .backup-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .backup-buttons .btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            min-height: 36px;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* 数据统计 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        /* 本地文件上传 */
        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(233, 30, 99, 0.02);
        }
        
        .file-upload-area.dragover {
            border-color: var(--primary);
            background-color: rgba(233, 30, 99, 0.05);
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-upload-label:hover {
            background-color: var(--primary-dark);
        }
        
        .local-files-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .local-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .local-file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            color: var(--primary);
        }
        
        /* 问卷自定义内容 */
        .custom-question-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .custom-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-type-select {
            width: 150px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* 拖拽占位符 */
        .drag-placeholder {
            border: 2px dashed var(--info);
            background-color: rgba(33, 150, 243, 0.05);
            height: 60px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        /* 搜索框样式 */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-box .form-control {
            padding-left: 40px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        /* 音乐页面布局 - 修改：音乐库和播放系统并列 */
        .music-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .music-layout .card {
            margin-bottom: 0;
        }
        
        /* 优化：音乐视图切换按钮样式 */
        .music-view-toggle-optimized {
            display: flex;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin-right: 15px;
        }
        
        .music-view-btn-optimized {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .music-view-btn-optimized.active {
            background-color: var(--primary);
            color: white;
        }
        
        @media (max-width: 992px) {
            .music-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* 提醒设置样式 */
        .reminder-settings {
            background-color: rgba(255, 152, 0, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        /* 优化：可编辑的音乐分类标签 */
        .music-category-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background-color: rgba(233, 30, 99, 0.1);
            color: var(--primary);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .music-category-tag:hover {
            background-color: rgba(233, 30, 99, 0.2);
        }
        
        .music-category-tag .edit-icon {
            opacity: 0.7;
            font-size: 0.7rem;
        }
        
        /* 移动端表单和按钮优化 */
        @media (max-width: 768px) {
            /* 优化表单元素大小 */
            form .form-control {
                padding: 15px;
                font-size: 1.1rem;
                border-radius: 8px;
            }
            
            form .form-label {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            /* 优化选择框样式 */
            select.form-control {
                background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 15px center;
                background-size: 20px;
                padding-right: 45px;
            }
            
            /* 优化移动端按钮大小 */
            .btn {
                padding: 12px 24px;
                font-size: 1.1rem;
                border-radius: 8px;
            }
            
            .btn-small {
                padding: 8px 16px;
                font-size: 0.95rem;
            }
            
            /* 优化卡片间距 */
            .card {
                margin-bottom: 15px;
                border-radius: 8px;
            }
            
            /* 优化模态框 */
            .modal-content {
                width: 95%;
                max-height: 95vh;
                border-radius: 10px;
            }
            
            /* 优化文本区域 */
            textarea.form-control {
                min-height: 150px;
                resize: vertical;
            }
            
            /* 优化工具栏 */
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .toolbar > div {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                align-items: center;
            }
            
            /* 优化视图切换和年份切换按钮 */
            .view-toggle, .year-toggle {
                margin: 0;
                flex: 1;
                min-width: 120px;
            }
            
            .view-btn, .year-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            /* 优化添加档期按钮 */
            #addEventBtn {
                padding: 8px 16px;
                font-size: 0.85rem;
                min-height: 38px;
            }
            
            /* 优化列表项 */
            .event-list-item, .client-list-item, .music-list-item {
                padding: 15px;
                gap: 15px;
            }
            
            /* 音乐管理模块移动端优化 */
            /* 优化遥控器按钮大小和间距 */
            .remote-control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .remote-control-panel {
                gap: 8px;
                margin: 15px 0;
            }
            
            /* 优化播放列表 */
            .session-playlist {
                max-height: 300px !important;
                font-size: 0.9rem;
            }
            
            .playlist-item {
                padding: 10px;
                gap: 10px;
            }
            
            /* 优化音乐分类标签 */
            .music-category-tag {
                padding: 6px 12px;
                font-size: 0.85rem;
                margin: 3px 0;
            }
            
            /* 优化音乐视图切换 */
            .music-view-toggle {
                flex-direction: column;
                width: 100%;
                margin: 10px 0;
            }
            
            .music-view-btn {
                width: 100%;
                padding: 10px;
                justify-content: center;
            }
            
            /* 优化本地音乐上传区域 */
            .file-upload-area {
                padding: 20px 15px;
            }
            
            /* 优化场次控制按钮 */
            .session-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .session-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* 优化场次选择框 */
            .session-select {
                width: 100%;
                margin-bottom: 8px;
            }
        }
        
        /* 优化：问卷分享链接样式 */
        .share-link-container {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .share-link {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .share-link input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        /* 优化：问卷导入导出按钮 */
        .questionnaire-import-export {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 优化：客户选择搜索框 */
        .client-search-container {
            position: relative;
            min-width: 300px;
        }
        
        .client-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        
        .client-search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #eee;
        }
        
        .client-search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .client-search-result-item:last-child {
            border-bottom: none;
        }
        
        .client-search-result-item.active {
            background-color: rgba(233, 30, 99, 0.1);
        }
        
        /* 遥控器控制面板 */
        .remote-control-panel {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .remote-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .remote-control-btn:hover {
            background-color: #f0f0f0;
            border-color: var(--primary);
        }
        
        .remote-control-btn.primary {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .remote-control-btn.primary:hover {
            background-color: var(--primary-dark);
        }
        
        .remote-control-info {
            text-align: center;
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        /* 主持人工具箱样式 */
        .toolkit-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            background: #f0f0f0;
            padding: 8px;
            border-radius: 6px;
            flex-wrap: wrap;
        }
        
        .toolkit-nav .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            min-height: 34px;
        }
        
        .toolkit-section {
            display: none;
        }
        
        .toolkit-section.active {
            display: block;
        }
        
        /* 台词分类样式 */
        .lines-categories {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 12px;
        }
        
        .category-card {
            background: white;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #eee;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .category-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        
        .category-card.active {
            border-color: var(--primary);
            background-color: rgba(233, 30, 99, 0.05);
        }
        
        .category-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .category-desc {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .category-count {
            background-color: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* 优化分类卡片内的按钮布局 */
        .category-card .btn {
            padding: 6px 12px;
            font-size: 0.75rem;
            min-height: 32px;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        .category-card > div {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        /* 合同、游戏、发言稿列表样式 */
        .contracts-list, .games-list, .speeches-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .content-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #eee;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .content-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        
        .content-card.active {
            border-color: var(--primary);
            background-color: rgba(233, 30, 99, 0.05);
        }
        
        .content-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .content-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .content-preview {
            color: var(--dark);
            font-size: 0.9rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 编辑表单样式 */
        .edit-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .toolkit-nav {
                flex-direction: column;
                gap: 5px;
            }
            
            .toolkit-nav button {
                padding: 12px;
                font-size: 0.95rem;
            }
            
            .lines-categories, .contracts-list, .games-list, .speeches-list {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            /* 优化主持人工具箱的卡片样式 */
            .toolkit-section {
                margin-bottom: 15px;
            }
            
            .toolkit-section h4 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            /* 优化环节规划模块 */
            .planning-toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .planning-toolbar .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* 优化时间轴步骤 */
            .timeline-step {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .step-content {
                gap: 8px;
            }
            
            /* 优化时间编辑模态框 */
            .time-edit-modal .form-group {
                margin-bottom: 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- 应用头部 -->
        <header class="app-header">
            <div class="app-title">
                <h1><i class="fas fa-heart"></i> 婚礼主持管家 - 专业高级版</h1>
                <div>
                    <button class="btn btn-info" id="exportBtn">
                        <i class="fas fa-file-export"></i> 导出
                    </button>
                    <button class="btn btn-primary" id="backupBtn">
                        <i class="fas fa-download"></i> 备份数据
                    </button>
                    <button class="btn btn-secondary" id="restoreBtn">
                        <i class="fas fa-upload"></i> 恢复数据
                    </button>
                </div>
            </div>
            <p class="app-subtitle">专业婚礼主持人单机工作平台 - 档期管理、客户信息、婚礼策划一站式解决方案</p>
        </header>
        
        <!-- 导航菜单 -->
        <nav class="app-nav" id="appNav">
            <div class="nav-item active" data-tab="calendar">
                <i class="fas fa-calendar-alt"></i> 档期管理
            </div>
            <div class="nav-item" data-tab="clients">
                <i class="fas fa-users"></i> 客户管理
            </div>
            <div class="nav-item" data-tab="questionnaire">
                <i class="fas fa-clipboard-list"></i> 婚礼问卷
            </div>
            <div class="nav-item" data-tab="planning">
                <i class="fas fa-project-diagram"></i> 环节规划
            </div>
            <div class="nav-item" data-tab="music">
                <i class="fas fa-music"></i> 音乐管理
            </div>
            <div class="nav-item" data-tab="toolkit">
                <i class="fas fa-toolbox"></i> 主持人工具箱
            </div>
        </nav>
        
        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 档期日历页面 -->
            <div class="tab-content active" id="calendar-tab">
                <div class="toolbar">
                    <h2 class="toolbar-title">档期管理</h2>
                    <div style="display: flex; align-items: center;">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="calendar">
                                <i class="fas fa-calendar-alt"></i> 日历视图
                            </button>
                            <button class="view-btn" data-view="list">
                                <i class="fas fa-list"></i> 列表视图
                            </button>
                        </div>
                        <div class="year-toggle" style="margin-left: 15px;">
                            <button class="year-btn active" data-year="current">
                                本年
                            </button>
                            <button class="year-btn" data-year="prev">
                                往年记录
                            </button>
                        </div>
                        <button class="btn btn-primary" id="addEventBtn" style="margin-left: 15px;">
                            <i class="fas fa-plus"></i> 添加档期
                        </button>
                    </div>
                </div>
                
                <!-- 本年视图 -->
                <div class="current-year-view">
                    <!-- 日历视图 -->
                    <div class="calendar-view active-view">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="legend">
                                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                                        <span class="event-wedding" style="width: 15px; height: 15px; display: inline-block; margin-right: 5px;"></span>
                                        已预订
                                    </span>
                                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                                        <span class="event-intent" style="width: 15px; height: 15px; display: inline-block; margin-right: 5px;"></span>
                                        意向客户
                                    </span>
                                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                                        <span class="event-other" style="width: 15px; height: 15px; display: inline-block; margin-right: 5px;"></span>
                                        其他活动
                                    </span>
                                    <span style="display: inline-flex; align-items: center;">
                                        <span class="day-reminder" style="margin-right: 5px;"></span>
                                        有提醒
                                    </span>
                                </div>
                                <div class="calendar-nav">
                                    <button class="btn btn-secondary" id="prevMonth">
                                        <i class="fas fa-chevron-left"></i> 上月
                                    </button>
                                    <span id="currentMonth" style="margin: 0 15px; font-weight: 600;">2026年1月</span>
                                    <button class="btn btn-secondary" id="nextMonth">
                                        下月 <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="calendar-grid" id="calendarGrid">
                                <!-- 日历将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 列表视图 -->
                    <div class="list-view-container" id="listViewContainer">
                        <div class="events-list" id="eventsList">
                            <!-- 事件列表将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 档期详情面板 -->
                    <div class="detail-panel" id="eventDetailPanel" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title">档期详情</h3>
                            <button class="btn btn-small btn-secondary" id="closeDetailBtn">
                                <i class="fas fa-times"></i> 关闭
                            </button>
                        </div>
                        
                        <div id="eventDetailContent">
                            <!-- 档期详情将通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card" id="monthEventsCard" data-filter-type="all">
                            <div class="stat-value" id="totalEvents">0</div>
                            <div class="stat-label">本月活动</div>
                        </div>
                        <div class="stat-card" id="confirmedEventsCard" data-filter-type="wedding">
                            <div class="stat-value" id="confirmedEvents">0</div>
                            <div class="stat-label">已确认婚礼</div>
                        </div>
                        <div class="stat-card" id="intentEventsCard" data-filter-type="intent">
                            <div class="stat-value" id="intentEvents">0</div>
                            <div class="stat-label">意向客户</div>
                        </div>
                        <div class="stat-card" id="revenueCard">
                            <div class="stat-value" id="revenue">¥0</div>
                            <div class="stat-label">本月收入</div>
                        </div>
                    </div>
                </div>
                
                <!-- 往年记录视图 -->
                <div class="prev-year-view" style="display: none;">
                    <div class="stats-container">
                        <div class="chart-card">
                            <div class="chart-title">往年婚礼数量统计</div>
                            <div class="chart-container">
                                <div class="chart-bar" id="prevYearEventsChart">
                                    <!-- 往年事件图表将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">往年收入统计</div>
                            <div class="chart-container">
                                <div class="chart-bar" id="prevYearIncomeChart">
                                    <!-- 往年收入图表将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h3 class="card-title">往年档期记录</h3>
                            <div class="year-toggle">
                                <button class="year-btn" data-prev-year="2025">
                                    2025年
                                </button>
                                <button class="year-btn" data-prev-year="2024">
                                    2024年
                                </button>
                                <button class="year-btn" data-prev-year="2023">
                                    2023年
                                </button>
                            </div>
                        </div>
                        
                        <div id="prevYearEventsList">
                            <!-- 往年事件列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 客户管理页面 -->
            <div class="tab-content" id="clients-tab">
                <div class="toolbar">
                    <h2 class="toolbar-title">客户管理</h2>
                    <button class="btn btn-primary" id="addClientBtn">
                        <i class="fas fa-plus"></i> 添加客户
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">总客户数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalRevenue">¥0</div>
                        <div class="stat-label">总收入</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgFee">¥0</div>
                        <div class="stat-label">平均费用</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="paidClients">0</div>
                        <div class="stat-label">已付款客户</div>
                    </div>
                </div>
                
                <div id="clientsList">
                    <!-- 客户列表将通过JS动态生成 -->
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <h3>暂无客户信息</h3>
                        <p>点击上方"添加客户"按钮开始记录</p>
                    </div>
                </div>
            </div>
            
            <!-- 婚礼问卷页面 -->
            <div class="tab-content" id="questionnaire-tab">
                <div class="toolbar">
                    <h2 class="toolbar-title">婚礼问卷</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <!-- 优化：客户选择搜索框 -->
                        <div class="client-search-container" style="width: 300px;">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="form-control" id="clientSearchInput" placeholder="搜索客户..." autocomplete="off">
                            </div>
                            <div class="client-search-results" id="clientSearchResults"></div>
                        </div>
                        <button class="btn btn-info" id="manageTemplatesBtn">
                            <i class="fas fa-cog"></i> 模板管理
                        </button>
                        <button class="btn btn-primary" id="newQuestionnaireBtn">
                            <i class="fas fa-file-alt"></i> 新建问卷
                        </button>
                        <!-- 新增：问卷操作按钮 -->
                        <button class="btn btn-secondary" id="editQuestionnaireBtn" style="display: none;">
                            <i class="fas fa-edit"></i> 编辑问卷
                        </button>
                        <button class="btn btn-warning" id="deleteQuestionnaireBtn" style="display: none;">
                            <i class="fas fa-trash"></i> 删除问卷
                        </button>
                        <button class="btn btn-success" id="shareQuestionnaireBtn" style="display: none;">
                            <i class="fas fa-share-alt"></i> 分享问卷
                        </button>
                        <button class="btn btn-secondary" id="importQuestionnaireBtnGlobal">
                            <i class="fas fa-file-import"></i> 导入问卷
                        </button>
                    </div>
                </div>
                
                <!-- 问卷模板选择 -->
                <div class="card" id="templateSelectionCard">
                    <div class="card-header">
                        <h3 class="card-title">选择问卷模板</h3>
                        <span class="badge badge-primary">专业版</span>
                    </div>
                    <p>选择适合的问卷模板开始填写，您也可以创建自定义模板。</p>
                    
                    <div class="questionnaire-templates" id="questionnaireTemplates">
                        <!-- 问卷模板将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 新建问卷内容区域 -->
                <div id="newQuestionnaireContent" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">新建自定义问卷</h3>
                            <button class="btn btn-small btn-secondary" id="backToTemplatesBtn">
                                <i class="fas fa-arrow-left"></i> 返回模板选择
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">问卷标题</label>
                            <input type="text" class="form-control" id="questionnaireTitle" placeholder="请输入问卷标题">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">关联客户</label>
                            <div class="client-search-container">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="form-control" id="questionnaireClientSearch" placeholder="搜索客户..." autocomplete="off">
                                </div>
                                <div class="client-search-results" id="questionnaireClientSearchResults"></div>
                            </div>
                        </div>
                        
                        <div id="customQuestionsContainer">
                            <div class="custom-question-item">
                                <div class="custom-question-header">
                                    <input type="text" class="form-control question-text" placeholder="问题1：请输入问题内容">
                                    <select class="question-type-select">
                                        <option value="text">文本</option>
                                        <option value="textarea">长文本</option>
                                        <option value="select">单选</option>
                                        <option value="checkbox">多选</option>
                                    </select>
                                </div>
                                <div class="question-options" style="display: none;">
                                    <input type="text" class="form-control" placeholder="选项，用逗号分隔（例如：选项1,选项2,选项3）" style="margin-top: 10px;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-secondary" id="addQuestionBtn">
                                <i class="fas fa-plus"></i> 添加问题
                            </button>
                            <button class="btn btn-primary" id="saveCustomQuestionnaireBtn">
                                <i class="fas fa-save"></i> 保存问卷
                            </button>
                            <button class="btn btn-info" id="saveAsTemplateBtn">
                                <i class="fas fa-file-export"></i> 保存为模板
                            </button>
                            <button class="btn btn-secondary" id="cancelCustomQuestionnaireBtn">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 问卷内容区域 -->
                <div id="questionnaireContent" style="display: none;">
                    <!-- 问卷内容将通过JS动态生成 -->
                </div>
                
                <!-- 问卷分享链接区域 -->
                <div id="questionnaireShareSection" style="display: none;">
                    <div class="share-link-container">
                        <h4><i class="fas fa-share-alt"></i> 问卷分享</h4>
                        <p>将问卷分享给客户填写，客户填写后您可以导入其答案</p>
                        <div class="share-link">
                            <input type="text" id="shareLinkInput" readonly placeholder="生成分享链接...">
                            <button class="btn btn-primary" id="generateShareLinkBtn">
                                <i class="fas fa-link"></i> 生成链接
                            </button>
                            <button class="btn btn-secondary" id="copyShareLinkBtn">
                                <i class="fas fa-copy"></i> 复制链接
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 环节规划页面 -->
            <div class="tab-content" id="planning-tab">
                <div class="toolbar">
                    <h2 class="toolbar-title" id="planningTitle">婚礼时间轴规划</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <!-- 优化：客户选择搜索框 -->
                        <div class="client-search-container" style="width: 300px;">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="form-control" id="planClientSearchInput" placeholder="搜索客户..." autocomplete="off">
                            </div>
                            <div class="client-search-results" id="planClientSearchResults"></div>
                        </div>
                        <button class="btn btn-secondary" id="clearPlanningBtn">
                            <i class="fas fa-undo"></i> 返回初始
                        </button>
                        <button class="btn btn-primary" id="addCustomStepBtn">
                            <i class="fas fa-plus"></i> 添加自定义环节
                        </button>
                        <button class="btn btn-info" id="saveTimelineBtn">
                            <i class="fas fa-save"></i> 保存时间轴
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" id="planningClientTitle">婚礼时间轴规划</h3>
                        <span class="badge badge-success">可拖拽排序</span>
                    </div>
                    
                    <p style="margin-bottom: 15px; color: var(--gray);">
                        <i class="fas fa-info-circle"></i> 提示：您可以拖拽环节调整顺序，点击时间可编辑
                    </p>
                    
                    <div class="timeline" id="weddingTimeline">
                        <!-- 标准时间轴 - 可拖拽 -->
                        <div class="timeline-item" data-step-id="step-1" data-step-type="standard">
                            <div class="timeline-time">
                                <span>15:00 - 15:30</span>
                                <button class="btn btn-small btn-secondary" onclick="editTimelineTime('step-1')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <h4>迎宾与签到</h4>
                            <p>主持人迎宾，引导宾客签到，暖场音乐播放。</p>
                            <div class="timeline-actions">
                                <button class="btn btn-small btn-secondary" onclick="editTimelineContent('step-1')">
                                    <i class="fas fa-edit"></i> 编辑内容
                                </button>
                            </div>
                        </div>
                        <div class="timeline-item" data-step-id="step-2" data-step-type="standard">
                            <div class="timeline-time">
                                <span>15:30 - 15:40</span>
                                <button class="btn btn-small btn-secondary" onclick="editTimelineTime('step-2')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <h4>开场白与宾客欢迎</h4>
                            <p>主持人开场，介绍婚礼主题，欢迎所有来宾。</p>
                            <div class="timeline-actions">
                                <button class="btn btn-small btn-secondary" onclick="editTimelineContent('step-2')">
                                    <i class="fas fa-edit"></i> 编辑内容
                                </button>
                            </div>
                        </div>
                        <div class="timeline-item" data-step-id="step-3" data-step-type="standard">
                            <div class="timeline-time">
                                <span>15:40 - 15:50</span>
                                <button class="btn btn-small btn-secondary" onclick="editTimelineTime('step-3')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <h4>新郎入场</h4>
                            <p>新郎登场，与主持人简短互动。</p>
                            <div class="timeline-actions">
                                <button class="btn btn-small btn-secondary" onclick="editTimelineContent('step-3')">
                                    <i class="fas fa-edit"></i> 编辑内容
                                </button>
                            </div>
                        </div>
                        
                        <!-- 自定义环节容器 -->
                        <div id="customStepsContainer"></div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label">主持词要点</label>
                        <textarea class="form-control" id="hostScript" rows="5" placeholder="记录针对这场婚礼的主持词要点、个性化台词、互动环节设计等..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- 音乐管理页面 -->
            <div class="tab-content" id="music-tab">
                <div class="toolbar">
                    <h2 class="toolbar-title">音乐管理</h2>
                    <div style="display: flex; align-items: center;">
                        <!-- 优化：音乐视图切换按钮样式 -->
                        <div class="music-view-toggle-optimized">
                            <button class="music-view-btn-optimized active" data-music-view="library">
                                <i class="fas fa-music"></i> 音乐库
                            </button>
                            <button class="music-view-btn-optimized" data-music-view="local">
                                <i class="fas fa-folder-open"></i> 本地音乐
                            </button>
                            <button class="music-view-btn-optimized" data-music-view="session">
                                <i class="fas fa-list-ol"></i> 播放系统
                            </button>
                        </div>
                        <button class="btn btn-primary" id="addMusicBtn" style="margin-left: 15px;">
                            <i class="fas fa-plus"></i> 添加音乐
                        </button>
                    </div>
                </div>
                
                <!-- 音乐库视图 -->
                <div id="musicLibraryView" class="music-view active-view">
                    <div class="music-layout">
                        <!-- 音乐库 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">按环节分类音乐推荐</h3>
                                <div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;" id="musicCategoriesContainer">
                                        <!-- 音乐分类标签将通过JS动态生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="music-list" id="musicLibrary">
                                <!-- 音乐列表将通过JS动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 多场次音乐播放系统 -->
                        <div class="card music-session-system">
                            <div class="card-header">
                                <h3 class="card-title">多场次音乐播放系统</h3>
                                <span class="badge badge-info">拖拽排序</span>
                            </div>
                            
                            <p style="color: var(--gray); margin-bottom: 15px; font-size: 0.9rem;">
                                从左侧音乐库拖动音乐到此处添加，拖动歌曲可调整顺序
                            </p>
                            
                            <div class="session-controls">
                                <select class="form-control session-select" id="sessionSelect">
                                    <option value="">选择播放列表...</option>
                                </select>
                                <button class="btn btn-small btn-primary" id="createSessionBtn">
                                    <i class="fas fa-plus"></i> 新建
                                </button>
                                <button class="btn btn-small btn-secondary" id="editSessionBtn">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-small btn-secondary" id="clearSessionBtn">
                                    <i class="fas fa-trash"></i> 清空
                                </button>
                            </div>
                            
                            <!-- 遥控器控制面板 -->
                            <div class="remote-control-panel">
                                <div class="remote-control-btn" id="remotePrevBtn" title="上一曲 (左箭头键)">
                                    <i class="fas fa-step-backward"></i>
                                </div>
                                <div class="remote-control-btn primary" id="remotePlayPauseBtn" title="播放/暂停 (空格键)">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div class="remote-control-btn" id="remoteNextBtn" title="下一曲 (右箭头键)">
                                    <i class="fas fa-step-forward"></i>
                                </div>
                                <div class="remote-control-btn" id="remoteStopBtn" title="停止 (S键)">
                                    <i class="fas fa-stop"></i>
                                </div>
                                <div class="remote-control-btn" id="remoteVolumeUpBtn" title="音量增大 (上箭头键)">
                                    <i class="fas fa-volume-up"></i>
                                </div>
                                <div class="remote-control-btn" id="remoteVolumeDownBtn" title="音量减小 (下箭头键)">
                                    <i class="fas fa-volume-down"></i>
                                </div>
                            </div>
                            <div class="remote-control-info">
                                提示：可使用键盘快捷键控制播放 - 空格: 播放/暂停, 左右箭头: 上一曲/下一曲
                            </div>
                            
                            <div class="session-playlist" id="sessionPlaylist">
                                <!-- 播放列表将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 本地音乐视图 -->
                <div id="localMusicView" class="music-view">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">本地音乐文件管理</h3>
                        </div>
                        
                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                            <h4>上传音乐文件</h4>
                            <p>支持 MP3、WAV、M4A 等常见音频格式，文件大小不超过 50MB</p>
                            <input type="file" id="musicFileInput" class="file-input" accept="audio/*" multiple>
                            <label for="musicFileInput" class="file-upload-label">
                                <i class="fas fa-upload"></i> 选择音乐文件
                            </label>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);">
                                或直接将文件拖拽到此处
                            </p>
                        </div>
                        
                        <div id="localMusicList">
                            <h4 style="margin: 20px 0 10px 0;">已上传的本地音乐</h4>
                            <ul class="local-files-list" id="localFilesList">
                                <!-- 本地文件列表将通过JS动态生成 -->
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 播放系统视图 -->
                <div id="sessionOnlyView" class="music-view">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">多场次音乐播放系统</h3>
                            <span class="badge badge-info">拖拽排序</span>
                        </div>
                        
                        <p style="color: var(--gray); margin-bottom: 15px; font-size: 0.9rem;">
                            从音乐库拖动音乐到此处添加，拖动歌曲可调整顺序
                        </p>
                        
                        <div class="session-controls">
                            <select class="form-control session-select" id="sessionSelect2">
                                <option value="">选择播放列表...</option>
                            </select>
                            <button class="btn btn-small btn-primary" id="createSessionBtn2">
                                <i class="fas fa-plus"></i> 新建列表
                            </button>
                            <button class="btn btn-small btn-secondary" id="editSessionBtn2">
                                <i class="fas fa-edit"></i> 编辑列表
                            </button>
                            <button class="btn btn-small btn-secondary" id="clearSessionBtn2">
                                <i class="fas fa-trash"></i> 清空
                            </button>
                        </div>
                        
                        <!-- 遥控器控制面板 -->
                        <div class="remote-control-panel">
                            <div class="remote-control-btn" id="remotePrevBtn2" title="上一曲 (左箭头键)">
                                <i class="fas fa-step-backward"></i>
                            </div>
                            <div class="remote-control-btn primary" id="remotePlayPauseBtn2" title="播放/暂停 (空格键)">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="remote-control-btn" id="remoteNextBtn2" title="下一曲 (右箭头键)">
                                <i class="fas fa-step-forward"></i>
                            </div>
                            <div class="remote-control-btn" id="remoteStopBtn2" title="停止 (S键)">
                                <i class="fas fa-stop"></i>
                            </div>
                            <div class="remote-control-btn" id="remoteVolumeUpBtn2" title="音量增大 (上箭头键)">
                                <i class="fas fa-volume-up"></i>
                            </div>
                            <div class="remote-control-btn" id="remoteVolumeDownBtn2" title="音量减小 (下箭头键)">
                                <i class="fas fa-volume-down"></i>
                            </div>
                        </div>
                        <div class="remote-control-info">
                            提示：可使用键盘快捷键控制播放 - 空格: 播放/暂停, 左右箭头: 上一曲/下一曲
                        </div>
                        
                        <div class="session-playlist" id="sessionPlaylist2" style="max-height: 500px;">
                            <!-- 播放列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 主持人工具箱页面 -->
            <div class="tab-content" id="toolkit-tab">
                <div class="toolbar">
                    <h2 class="toolbar-title">主持人工具箱</h2>
                </div>
                
                <!-- 工具箱导航 -->
                <div class="toolkit-nav" style="display: flex; gap: 10px; margin-bottom: 20px; background: #f0f0f0; padding: 10px; border-radius: 8px;">
                    <button class="btn btn-primary active" data-toolkit-section="lines">
                        <i class="fas fa-comments"></i> 台词分类
                    </button>
                    <button class="btn btn-secondary" data-toolkit-section="contracts">
                        <i class="fas fa-file-contract"></i> 活动合同
                    </button>
                    <button class="btn btn-secondary" data-toolkit-section="games">
                        <i class="fas fa-gamepad"></i> 互动游戏
                    </button>
                    <button class="btn btn-secondary" data-toolkit-section="speeches">
                        <i class="fas fa-microphone"></i> 婚礼发言稿
                    </button>
                </div>
                
                <!-- 台词分类部分 -->
                <div class="toolkit-section active" id="lines-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">台词分类管理</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="addLineCategoryBtn">
                                    <i class="fas fa-plus"></i> 添加分类
                                </button>
                                <button class="btn btn-secondary" id="editLineCategoryBtn">
                                    <i class="fas fa-edit"></i> 编辑选中分类
                                </button>
                                <button class="btn btn-info" id="importLineFileBtn">
                                    <i class="fas fa-file-import"></i> 导入文件
                                </button>
                                <button class="btn btn-secondary" id="addDirectoryBtn">
                                    <i class="fas fa-folder-plus"></i> 添加目录
                                </button>
                            </div>
                        </div>
                        
                        <!-- 文件导入区域 -->
                        <div class="file-import-section" style="margin: 20px 0; padding: 15px; background: #f0f7ff; border-radius: 8px; display: none;">
                            <h4><i class="fas fa-file-import"></i> 导入台词文件</h4>
                            <p style="margin: 10px 0; color: var(--gray);">支持导入.txt、.docx格式文件，自动提取内容添加到选中分类</p>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="file" id="lineFileInput" accept=".txt,.docx" style="display: none;">
                                <label for="lineFileInput" class="btn btn-primary" style="cursor: pointer;">
                                    <i class="fas fa-file"></i> 选择文件
                                </label>
                                <button class="btn btn-secondary" id="cancelImportBtn">
                                    <i class="fas fa-times"></i> 取消
                                </button>
                            </div>
                            <div id="importProgress" style="margin-top: 15px; display: none;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>正在导入文件...</span>
                                </div>
                                <div style="margin-top: 10px; height: 5px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                                    <div id="importProgressBar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lines-categories" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                            <!-- 台词分类将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 活动合同部分 -->
                <div class="toolkit-section" id="contracts-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">活动合同管理</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="addContractBtn">
                                    <i class="fas fa-plus"></i> 添加合同
                                </button>
                                <button class="btn btn-secondary" id="editContractBtn">
                                    <i class="fas fa-edit"></i> 编辑选中合同
                                </button>
                            </div>
                        </div>
                        
                        <div class="contracts-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <!-- 合同列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 互动游戏部分 -->
                <div class="toolkit-section" id="games-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">演出互动游戏</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="addGameBtn">
                                    <i class="fas fa-plus"></i> 添加游戏
                                </button>
                                <button class="btn btn-secondary" id="editGameBtn">
                                    <i class="fas fa-edit"></i> 编辑选中游戏
                                </button>
                            </div>
                        </div>
                        
                        <div class="games-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <!-- 游戏列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 婚礼发言稿部分 -->
                <div class="toolkit-section" id="speeches-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">婚礼发言稿</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="addSpeechBtn">
                                    <i class="fas fa-plus"></i> 添加发言稿
                                </button>
                                <button class="btn btn-secondary" id="editSpeechBtn">
                                    <i class="fas fa-edit"></i> 编辑选中发言稿
                                </button>
                            </div>
                        </div>
                        
                        <div class="speeches-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            <!-- 发言稿列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- 数据备份区域 -->
            <div class="backup-section">
                <h3><i class="fas fa-database"></i> 数据备份与恢复</h3>
                <p>所有数据存储在你的浏览器本地，为防止数据丢失，请定期备份。备份文件可导入到其他设备使用。</p>
                <div class="backup-buttons">
                    <button class="btn btn-primary" id="exportDataBtn">
                        <i class="fas fa-file-export"></i> 导出所有数据
                    </button>
                    <button class="btn btn-secondary" id="importDataBtn">
                        <i class="fas fa-file-import"></i> 导入数据文件
                    </button>
                    <button class="btn btn-secondary" id="clearDataBtn">
                        <i class="fas fa-trash-alt"></i> 清空所有数据
                    </button>
                </div>
                <p style="margin-top: 10px; font-size: 0.85rem; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> 当前数据状态：<span id="dataStatus">已保存 0 个客户，0 个档期</span>
                </p>
            </div>
        </main>
        
        <!-- 内容查看模态框 -->
        <div class="modal" id="contentViewModal">
            <div class="modal-content" style="max-width: 90%; width: 1000px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="contentViewTitle">内容查看</h3>
                    <button class="close-modal" onclick="closeModal('contentViewModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 搜索区域 -->
                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <input type="text" id="contentSearchInput" placeholder="输入关键词进行搜索..." 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <button id="clearSearchBtn" class="btn btn-secondary" style="white-space: nowrap;">
                            <i class="fas fa-times"></i> 清除
                        </button>
                    </div>
                    
                    <!-- 内容查看区域 -->
                    <div id="contentViewArea" style="background: #fafafa; padding: 20px; border-radius: 8px; min-height: 300px; font-family: 'Microsoft YaHei', serif;">
                        <!-- 内容将通过JS动态生成 -->
                    </div>
                    
                    <!-- 目录导航 -->
                    <div id="contentViewToc" style="margin-top: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px; display: none;">
                        <h4>目录</h4>
                        <ul id="contentViewTocList" style="list-style: none; padding-left: 10px; margin: 10px 0;">
                            <!-- 目录项将通过JS动态生成 -->
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('contentViewModal')">关闭</button>
                    <button class="btn btn-primary" onclick="exportCurrentContent()">导出内容</button>
                </div>
            </div>
        </div>
        
        <!-- 添加内容模态框 -->
        <div class="modal" id="addContentModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="addContentTitle">添加内容</h3>
                    <button class="close-modal" onclick="closeModal('addContentModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 添加内容表单 -->
                    <form id="addContentForm">
                        <div class="form-group">
                            <label for="contentTitle" class="form-label">标题</label>
                            <input type="text" id="contentTitle" class="form-control" placeholder="请输入内容标题" required>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="contentText" class="form-label">内容</label>
                            <textarea id="contentText" class="form-control" rows="15" placeholder="请输入内容" required style="font-family: 'Microsoft YaHei', serif;"></textarea>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="contentCategory" class="form-label">分类</label>
                            <select id="contentCategory" class="form-control">
                                <!-- 分类选项将通过JS动态生成 -->
                            </select>
                        </div>
                        <div class="form-group" style="margin-top: 15px; display: none;" id="directorySelectGroup">
                            <label for="contentDirectory" class="form-label">目录</label>
                            <select id="contentDirectory" class="form-control">
                                <option value="">不选择目录</option>
                                <!-- 目录选项将通过JS动态生成 -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('addContentModal')">取消</button>
                    <button class="btn btn-primary" onclick="saveContent()">保存</button>
                </div>
            </div>
        </div>
        
        <!-- 活动合同编辑模态框 -->
        <div class="modal" id="editContractModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="editContractTitle">编辑合同</h3>
                    <button class="close-modal" onclick="closeModal('editContractModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 合同编辑表单 -->
                    <form id="editContractForm">
                        <div class="form-group">
                            <label for="editContractName" class="form-label">合同名称</label>
                            <input type="text" id="editContractName" class="form-control" placeholder="请输入合同名称" required>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">合同类型</label>
                            <div class="form-radio-group" style="margin-top: 10px;">
                                <label style="margin-right: 20px;">
                                    <input type="radio" name="editContractType" value="wedding" checked>
                                    婚礼合同
                                </label>
                                <label>
                                    <input type="radio" name="editContractType" value="business">
                                    商务合同
                                </label>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="editContractContent" class="form-label">合同内容</label>
                            <textarea id="editContractContent" class="form-control" rows="15" placeholder="请输入合同内容" required style="font-family: 'Microsoft YaHei', serif;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('editContractModal')">取消</button>
                    <button class="btn btn-primary" onclick="saveEditContract()">保存</button>
                </div>
            </div>
        </div>
        
        <!-- 互动游戏编辑模态框 -->
        <div class="modal" id="editGameModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="editGameTitle">编辑游戏</h3>
                    <button class="close-modal" onclick="closeModal('editGameModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 游戏编辑表单 -->
                    <form id="editGameForm">
                        <div class="form-group">
                            <label for="editGameName" class="form-label">游戏名称</label>
                            <input type="text" id="editGameName" class="form-control" placeholder="请输入游戏名称" required>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="editGameDescription" class="form-label">游戏描述</label>
                            <textarea id="editGameDescription" class="form-control" rows="5" placeholder="请输入游戏描述" required></textarea>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="editGameInstructions" class="form-label">游戏规则</label>
                            <textarea id="editGameInstructions" class="form-control" rows="15" placeholder="请输入游戏规则" required style="font-family: 'Microsoft YaHei', serif;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('editGameModal')">取消</button>
                    <button class="btn btn-primary" onclick="saveEditGame()">保存</button>
                </div>
            </div>
        </div>
        
        <!-- 婚礼发言稿编辑模态框 -->
        <div class="modal" id="editSpeechModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="editSpeechTitle">编辑发言稿</h3>
                    <button class="close-modal" onclick="closeModal('editSpeechModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 发言稿编辑表单 -->
                    <form id="editSpeechForm">
                        <div class="form-group">
                            <label for="editSpeechName" class="form-label">发言稿名称</label>
                            <input type="text" id="editSpeechName" class="form-control" placeholder="请输入发言稿名称" required>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="editSpeechRole" class="form-label">发言角色</label>
                            <input type="text" id="editSpeechRole" class="form-control" placeholder="请输入发言角色" required>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="editSpeechContent" class="form-label">发言稿内容</label>
                            <textarea id="editSpeechContent" class="form-control" rows="15" placeholder="请输入发言稿内容" required style="font-family: 'Microsoft YaHei', serif;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('editSpeechModal')">取消</button>
                    <button class="btn btn-primary" onclick="saveEditSpeech()">保存</button>
                </div>
            </div>
        </div>
        
        <footer class="app-footer">
            <p>婚礼主持管家 - 专为婚礼主持人设计的单机工作平台 | 数据本地存储，无需网络 | © 2026</p>
            <p style="font-size: 0.8rem; margin-top: 5px;">提示：定期备份数据以防丢失，建议每周备份一次。</p>
        </footer>
    </div>
    
    <!-- 添加档期模态框（增强版） -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加/编辑档期</h3>
                <button class="close-modal" id="closeEventModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">活动日期 <span class="required">*</span></label>
                            <input type="date" class="form-control" id="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">时间选择 <span class="required">*</span></label>
                            <select class="form-control" id="eventTimeSlot" required>
                                <option value="morning">上午</option>
                                <option value="noon">中午</option>
                                <option value="afternoon">下午</option>
                                <option value="evening">晚上</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">活动类型 <span class="required">*</span></label>
                            <select class="form-control" id="eventType" required>
                                <option value="wedding">婚礼主持</option>
                                <option value="intent">意向客户</option>
                                <option value="other">其他活动</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">开始时间 <span class="required">*</span></label>
                            <input type="time" class="form-control" id="eventStartTime" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">结束时间 <span class="required">*</span></label>
                            <input type="time" class="form-control" id="eventEndTime" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">活动名称/客户姓名 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="eventTitle" placeholder="例如：张明&李丽婚礼" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">合作方/婚庆公司</label>
                            <input type="text" class="form-control" id="eventPartner" placeholder="例如：甜蜜蜜婚庆">
                        </div>
                        <div class="form-group">
                            <label class="form-label">活动地点</label>
                            <input type="text" class="form-control" id="eventLocation" placeholder="例如：XX酒店宴会厅">
                        </div>
                    </div>
                    
                    <!-- 提醒设置 -->
                    <div class="reminder-settings">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="eventReminder" checked> 设置提醒
                            </label>
                            <div class="form-row" id="reminderOptions" style="margin-top: 10px;">
                                <div class="form-group">
                                    <label class="form-label">提前天数</label>
                                    <input type="number" class="form-control" id="reminderDays" min="1" max="30" value="7">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">提醒时间</label>
                                    <input type="time" class="form-control" id="reminderTime" value="09:00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 费用信息 -->
                    <div class="card" style="margin-bottom: 20px; border-left-color: var(--success);">
                        <div class="card-header">
                            <h4 class="card-title" style="font-size: 1rem;">费用信息</h4>
                        </div>
                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">总费用 (元)</label>
                                <input type="number" class="form-control" id="eventFee" placeholder="例如：3000" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">费用类型</label>
                                <select class="form-control" id="feeType">
                                    <option value="full">全款</option>
                                    <option value="deposit">定金</option>
                                    <option value="installment">分期</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">支付状态</label>
                                <select class="form-control" id="paymentStatus">
                                    <option value="unpaid">未支付</option>
                                    <option value="deposit-paid">定金已付</option>
                                    <option value="partial">部分支付</option>
                                    <option value="paid">已结清</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">活动环节链接</label>
                        <input type="text" class="form-control" id="eventPlanLink" placeholder="可链接到环节规划页面">
                        <small class="form-text" style="color: var(--gray); font-size: 0.85rem;">
                            可填写环节规划页面的客户ID或备注信息，方便快速跳转
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">备注信息</label>
                        <textarea class="form-control" id="eventNotes" rows="3" placeholder="活动特殊要求、注意事项等"></textarea>
                    </div>
                    
                    <input type="hidden" id="eventId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEventBtn">取消</button>
                <button class="btn btn-primary" id="saveEventBtn">保存档期</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加合同模态框 -->
<div class="modal" id="addContractModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title" id="addContractTitle">添加合同</h3>
            <button class="close-modal" onclick="closeModal('addContractModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- 添加合同表单 -->
            <form id="addContractForm">
                <div class="form-group">
                    <label for="addContractName" class="form-label">合同名称</label>
                    <input type="text" id="addContractName" class="form-control" placeholder="请输入合同名称" required>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">合同类型</label>
                    <div class="form-radio-group" style="margin-top: 10px;">
                        <label style="margin-right: 20px;">
                            <input type="radio" name="addContractType" value="wedding" checked>
                            婚礼合同
                        </label>
                        <label>
                            <input type="radio" name="addContractType" value="business">
                            商务合同
                        </label>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="addContractContent" class="form-label">合同内容</label>
                    <textarea id="addContractContent" class="form-control" rows="15" placeholder="请输入合同内容" required style="font-family: 'Microsoft YaHei', serif;"></textarea>
                </div>
                <div class="modal-footer" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addContractModal')">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveAddContract()">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 添加游戏模态框 -->
<div class="modal" id="addGameModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title" id="addGameTitle">添加互动游戏</h3>
            <button class="close-modal" onclick="closeModal('addGameModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- 添加游戏表单 -->
            <form id="addGameForm">
                <div class="form-group">
                    <label for="addGameName" class="form-label">游戏名称</label>
                    <input type="text" id="addGameName" class="form-control" placeholder="请输入游戏名称" required>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="addGameDescription" class="form-label">游戏描述</label>
                    <textarea id="addGameDescription" class="form-control" rows="5" placeholder="请输入游戏描述" required></textarea>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="addGameInstructions" class="form-label">游戏规则</label>
                    <textarea id="addGameInstructions" class="form-control" rows="15" placeholder="请输入游戏规则" required style="font-family: 'Microsoft YaHei', serif;"></textarea>
                </div>
                <div class="modal-footer" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addGameModal')">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveAddGame()">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 添加发言稿模态框 -->
<div class="modal" id="addSpeechModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title" id="addSpeechTitle">添加婚礼发言稿</h3>
            <button class="close-modal" onclick="closeModal('addSpeechModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- 添加发言稿表单 -->
            <form id="addSpeechForm">
                <div class="form-group">
                    <label for="addSpeechName" class="form-label">发言稿名称</label>
                    <input type="text" id="addSpeechName" class="form-control" placeholder="请输入发言稿名称" required>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="addSpeechRole" class="form-label">角色</label>
                    <input type="text" id="addSpeechRole" class="form-control" placeholder="请输入角色（如：新郎、新娘、父亲等）" required>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="addSpeechContent" class="form-label">发言稿内容</label>
                    <textarea id="addSpeechContent" class="form-control" rows="15" placeholder="请输入发言稿内容" required style="font-family: 'Microsoft YaHei', serif;"></textarea>
                </div>
                <div class="modal-footer" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSpeechModal')">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveAddSpeech()">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>    
    <!-- 添加客户模态框（增强版） -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加/编辑客户信息</h3>
                <button class="close-modal" id="closeClientModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">新郎姓名 <span class="required">*</span></label>
                            <input type="text" class="form-control" id="groomName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">新娘姓名 <span class="required">*</span></label>
                            <input type="text" class="form-control" id="brideName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">联系电话 <span class="required">*</span></label>
                            <input type="tel" class="form-control" id="clientPhone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">婚礼日期 <span class="required">*</span></label>
                            <input type="date" class="form-control" id="weddingDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">活动时间 <span class="required">*</span></label>
                            <select class="form-control" id="eventTimeSlot" required>
                                <option value="morning">上午</option>
                                <option value="noon">中午</option>
                                <option value="afternoon">下午</option>
                                <option value="evening">晚上</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">婚礼场地</label>
                        <input type="text" class="form-control" id="weddingVenue" placeholder="酒店/餐厅/户外场地等">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">仪式开始时间</label>
                            <input type="time" class="form-control" id="ceremonyTime">
                        </div>
                        <div class="form-group">
                            <label class="form-label">宴会开始时间</label>
                            <input type="time" class="form-control" id="receptionTime">
                        </div>
                    </div>
                    
                    <!-- 客户费用信息 -->
                    <div class="card" style="margin-bottom: 20px; border-left-color: var(--success);">
                        <div class="card-header">
                            <h4 class="card-title" style="font-size: 1rem;">费用信息</h4>
                        </div>
                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">合同费用 (元) <span class="required">*</span></label>
                                <input type="number" class="form-control" id="clientFee" placeholder="例如：3000" min="0" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">已收费用 (元)</label>
                                <input type="number" class="form-control" id="paidAmount" placeholder="例如：1500" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">支付状态</label>
                                <select class="form-control" id="clientPaymentStatus">
                                    <option value="unpaid">未支付</option>
                                    <option value="deposit">定金已付</option>
                                    <option value="partial">部分支付</option>
                                    <option value="paid">已结清</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">特别要求/备注</label>
                        <textarea class="form-control" id="clientNotes" rows="4" placeholder="记录客户的特殊要求、偏好、禁忌等信息"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">合同状态</label>
                        <select class="form-control" id="contractStatus">
                            <option value="pending">待签约</option>
                            <option value="signed">已签约</option>
                            <option value="deposit">已付定金</option>
                            <option value="paid">已付全款</option>
                        </select>
                    </div>
                    
                    <input type="hidden" id="clientId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" id="viewClientSummaryBtn" style="margin-right: auto;">
                    <i class="fas fa-info-circle"></i> 查看综合信息
                </button>
                <button class="btn btn-secondary" id="cancelClientBtn">取消</button>
                <button class="btn btn-primary" id="saveClientBtn">保存客户</button>
            </div>
        </div>
    </div>
    
    <!-- 客户综合信息模态框 -->
    <div class="modal" id="clientSummaryModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>客户综合信息</h3>
                <button class="close-modal" id="closeClientSummaryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="clientSummaryContent">
                    <!-- 客户综合信息将通过JS动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeClientSummaryBtn">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 添加音乐模态框 -->
    <div class="modal" id="musicModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加婚礼音乐</h3>
                <button class="close-modal" id="closeMusicModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="musicForm">
                    <div class="form-group">
                        <label class="form-label">歌曲名称 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="musicTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">演唱者/演奏者</label>
                        <input type="text" class="form-control" id="musicArtist">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">适用环节 <span class="required">*</span></label>
                        <select class="form-control" id="musicCategory" required>
                            <option value="entrance">新娘入场</option>
                            <option value="ceremony">仪式环节</option>
                            <option value="recessional">新人退场</option>
                            <option value="reception">宴会背景</option>
                            <option value="first-dance">第一支舞</option>
                            <option value="parent-dance">父母舞蹈</option>
                            <option value="other">其他环节</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">音乐链接/来源</label>
                        <input type="text" class="form-control" id="musicSource" placeholder="例如：网易云音乐/QQ音乐链接，或本地文件位置">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">备注/推荐理由</label>
                        <textarea class="form-control" id="musicNotes" rows="3" placeholder="这首音乐的特点、适合的婚礼风格、使用建议等"></textarea>
                    </div>
                    
                    <!-- 本地文件上传选项 -->
                    <div class="form-group">
                        <label class="form-label">使用本地音乐文件</label>
                        <select class="form-control" id="musicFileType">
                            <option value="link">使用链接/在线音乐</option>
                            <option value="local">使用本地音乐文件</option>
                        </select>
                    </div>
                    
                    <div id="localFileSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">选择本地音乐文件</label>
                            <select class="form-control" id="localFileSelect">
                                <option value="">请选择已上传的本地文件</option>
                            </select>
                            <small class="form-text" style="color: var(--gray); font-size: 0.85rem;">
                                需要在"本地音乐"页面先上传文件
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelMusicBtn">取消</button>
                <button class="btn btn-primary" id="saveMusicBtn">保存音乐</button>
            </div>
        </div>
    </div>
    
    <!-- 问卷模板管理模态框 -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>问卷模板管理</h3>
                <button class="close-modal" id="closeTemplateModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="toolbar" style="margin-bottom: 20px; padding-bottom: 10px;">
                    <h4>现有模板</h4>
                    <button class="btn btn-primary" id="addTemplateBtn">
                        <i class="fas fa-plus"></i> 新建模板
                    </button>
                </div>
                
                <div id="templatesList">
                    <!-- 模板列表将通过JS动态生成 -->
                </div>
                
                <!-- 模板编辑器 -->
                <div id="templateEditor" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">模板编辑器</h4>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">模板名称</label>
                            <input type="text" class="form-control" id="templateName" placeholder="例如：西式教堂婚礼问卷">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">模板描述</label>
                            <textarea class="form-control" id="templateDescription" rows="2" placeholder="描述此模板的适用场景和特点"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">模板标签（用逗号分隔）</label>
                            <input type="text" class="form-control" id="templateTags" placeholder="例如：教堂,西式,庄重">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">自定义问题</label>
                            <div id="customQuestionsContainer">
                                <!-- 自定义问题将通过JS动态添加 -->
                            </div>
                            <button type="button" class="btn btn-small btn-secondary" id="addTemplateQuestionBtn">
                                <i class="fas fa-plus"></i> 添加问题
                            </button>
                        </div>
                        
                        <input type="hidden" id="templateId">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelTemplateBtn">关闭</button>
                <button class="btn btn-primary" id="saveTemplateBtn" style="display: none;">保存模板</button>
            </div>
        </div>
    </div>
    
    <!-- 添加自定义环节模态框 -->
    <div class="modal" id="customStepModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加自定义环节</h3>
                <button class="close-modal" id="closeCustomStepModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customStepForm">
                    <div class="form-group">
                        <label class="form-label">环节名称 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="stepName" placeholder="例如：First Look、特殊仪式等" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">大致时间</label>
                            <input type="text" class="form-control" id="stepTime" placeholder="例如：仪式后、宴会前">
                        </div>
                        <div class="form-group">
                            <label class="form-label">预估时长（分钟）</label>
                            <input type="number" class="form-control" id="stepDuration" placeholder="例如：10" min="1" max="120">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">环节描述</label>
                        <textarea class="form-control" id="stepDescription" rows="4" placeholder="详细描述此环节的内容、流程、注意事项等"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">关联客户</label>
                        <select class="form-control" id="stepClient">
                            <option value="">不关联特定客户（通用环节）</option>
                        </select>
                    </div>
                    
                    <input type="hidden" id="stepId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCustomStepBtn">取消</button>
                <button class="btn btn-primary" id="saveCustomStepBtn">保存环节</button>
            </div>
        </div>
    </div>
    
    <!-- 导出功能模态框 -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>导出功能</h3>
                <button class="close-modal" id="closeExportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options" style="display: flex; flex-direction: column; gap: 15px; padding: 20px;">
                    <button class="btn btn-primary export-option-btn" id="exportScreenshotBtn" style="padding: 15px; font-size: 16px;">
                        <i class="fas fa-camera" style="margin-right: 10px;"></i> 导出当前页截图
                    </button>
                    <button class="btn btn-primary export-option-btn" id="openExportClientsModalBtn" style="padding: 15px; font-size: 16px;">
                        <i class="fas fa-file-excel" style="margin-right: 10px;"></i> 导出客户信息Excel
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExportBtn">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 导出客户信息模态框 -->
    <div class="modal" id="exportClientsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>导出客户信息</h3>
                <button class="close-modal" id="closeExportClientsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">选择客户</label>
                    <div class="search-container" style="position: relative; margin-bottom: 10px;">
                        <input type="text" class="form-control" id="exportClientSearch" placeholder="搜索客户..." style="margin-bottom: 10px;">
                        <i class="fas fa-search search-icon" style="position: absolute; right: 15px; top: 15px; color: #6c757d;"></i>
                    </div>
                    <select class="form-control" id="exportClientSelect" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                        <option value="all">所有客户</option>
                        <!-- 客户选项将通过JS动态生成 -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">导出字段</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                        <label class="checkbox-label"><input type="checkbox" class="export-field" value="basic" checked> 基本信息</label>
                        <label class="checkbox-label"><input type="checkbox" class="export-field" value="contact" checked> 联系方式</label>
                        <label class="checkbox-label"><input type="checkbox" class="export-field" value="wedding" checked> 婚礼信息</label>
                        <label class="checkbox-label"><input type="checkbox" class="export-field" value="partner" checked> 婚礼合作商资料</label>
                        <label class="checkbox-label"><input type="checkbox" class="export-field" value="notes" checked> 备注信息</label>
                    </div>
                </div>
                <div class="alert alert-info" style="margin-top: 15px;">
                    <i class="fas fa-info-circle"></i> 提示：选择"所有客户"将导出所有客户的完整信息
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExportClientsBtn">取消</button>
                <button class="btn btn-primary" id="confirmExportClientsBtn">确认导出</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑时间轴时间模态框 -->
    <div class="modal" id="editTimeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑环节时间</h3>
                <button class="close-modal" id="closeEditTimeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editTimeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">开始时间</label>
                            <input type="text" class="form-control" id="editStartTime" placeholder="例如：15:00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">结束时间</label>
                            <input type="text" class="form-control" id="editEndTime" placeholder="例如：15:30">
                        </div>
                    </div>
                    <input type="hidden" id="editStepId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditTimeBtn">取消</button>
                <button class="btn btn-primary" id="saveEditTimeBtn">保存时间</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑时间轴内容模态框 -->
    <div class="modal" id="editContentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑环节内容</h3>
                <button class="close-modal" id="closeEditContentModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editContentForm">
                    <div class="form-group">
                        <label class="form-label">环节标题</label>
                        <input type="text" class="form-control" id="editStepTitle" placeholder="例如：迎宾与签到">
                    </div>
                    <div class="form-group">
                        <label class="form-label">环节描述</label>
                        <textarea class="form-control" id="editStepDescription" rows="4" placeholder="详细描述此环节的内容、流程、注意事项等"></textarea>
                    </div>
                    <input type="hidden" id="editContentStepId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditContentBtn">取消</button>
                <button class="btn btn-primary" id="saveEditContentBtn">保存内容</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑音乐分类模态框 -->
    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑音乐分类</h3>
                <button class="close-modal" id="closeEditCategoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <div class="form-group">
                        <label class="form-label">分类名称</label>
                            <input type="text" class="form-control" id="editCategoryName" placeholder="例如：新人入场音乐">
                    </div>
                    <div class="form-group">
                        <label class="form-label">分类标识</label>
                        <input type="text" class="form-control" id="editCategoryKey" placeholder="例如：entrance">
                        <small class="form-text" style="color: var(--gray); font-size: 0.85rem;">
                            用于内部标识，建议使用英文
                        </small>
                    </div>
                    <input type="hidden" id="editCategoryOriginalKey">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditCategoryBtn">取消</button>
                <button class="btn btn-primary" id="saveEditCategoryBtn">保存分类</button>
            </div>
        </div>
    </div>
    
    <!-- 导入问卷答案模态框 -->
    <div class="modal" id="importQuestionnaireModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>导入问卷答案</h3>
                <button class="close-modal" id="closeImportQuestionnaireModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">选择问卷文件</label>
                    <input type="file" class="form-control" id="questionnaireFileInput" accept=".json">
                    <small class="form-text" style="color: var(--gray); font-size: 0.85rem;">
                        选择客户填写后导出的问卷答案文件 (.json格式)
                    </small>
                </div>
                
                <div id="importPreview" style="margin-top: 20px; display: none;">
                    <h4>预览导入的数据</h4>
                    <div id="importPreviewContent" style="max-height: 300px; overflow-y: auto; padding: 15px; background-color: #f9f9f9; border-radius: 6px; margin-top: 10px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelImportQuestionnaireBtn">取消</button>
                <button class="btn btn-primary" id="confirmImportQuestionnaireBtn">导入答案</button>
            </div>
        </div>
    </div>
    
    <script>
        // 应用状态和数据
        const AppState = {
            currentTab: 'calendar',
            currentView: 'calendar', // 'calendar' 或 'list'
            currentYearView: 'current', // 'current' 或 'prev'
            selectedPrevYear: '2025',
            currentDate: new Date(2026, 0, 15), // 2026年1月15日
            events: [],
            clients: [],
            music: [],
            templates: [],
            customSteps: [],
            localMusicFiles: [],
            localAudioObjects: {}, // 存储本地音频对象
            timelineSteps: [], // 时间轴环节数据
            editingEvent: null,
            editingClient: null,
            editingMusic: null,
            editingTemplate: null,
            editingStep: null,
            editingTimeStep: null,
            editingContentStep: null,
            editingCategory: null,
            playingMusic: null,
            audioPlayer: null,
            isDragging: false,
            dragElement: null,
            // 主持人工具箱数据
            lineCategories: [
                { id: '1', name: '婚礼类', description: '婚礼相关台词', items: [] },
                { id: '2', name: '答谢宴', description: '答谢宴相关台词', items: [] },
                { id: '3', name: '回门宴', description: '回门宴相关台词', items: [] },
                { id: '4', name: '出阁礼', description: '出阁礼相关台词', items: [] },
                { id: '5', name: '订婚宴', description: '订婚宴相关台词', items: [] },
                { id: '6', name: '周岁宴', description: '周岁宴相关台词', items: [] },
                { id: '7', name: '升学宴', description: '升学宴相关台词', items: [] },
                { id: '8', name: '成人礼', description: '成人礼相关台词', items: [] },
                { id: '9', name: '寿宴', description: '寿宴相关台词', items: [] }
            ],
            contracts: [
                { id: '1', name: '商务合同', type: 'business', content: '商务合同模板内容...' },
                { id: '2', name: '婚礼合同', type: 'wedding', content: '婚礼合同模板内容...' }
            ],
            games: [
                { id: '1', name: '抢红包游戏', description: '互动抢红包游戏', instructions: '游戏规则...' },
                { id: '2', name: '猜歌名', description: '音乐猜歌名游戏', instructions: '游戏规则...' }
            ],
            speeches: [
                { id: '1', name: '新娘父亲致辞', role: 'father-of-bride', content: '尊敬的各位来宾...' },
                { id: '2', name: '新郎致辞', role: 'groom', content: '尊敬的各位长辈...' },
                { id: '3', name: '新娘致辞', role: 'bride', content: '感谢各位来宾...' },
                { id: '4', name: '伴郎致辞', role: 'best-man', content: '作为伴郎...' },
                { id: '5', name: '伴娘致辞', role: 'maid-of-honor', content: '作为伴娘...' }
            ],
            // 音乐分类
            musicCategories: [
                { key: 'entrance', name: '新娘入场' },
                { key: 'ceremony', name: '仪式环节' },
                { key: 'recessional', name: '新人退场' },
                { key: 'reception', name: '宴会背景' },
                { key: 'first-dance', name: '第一支舞' },
                { key: 'parent-dance', name: '父母舞蹈' },
                { key: 'other', name: '其他环节' }
            ],
            // 新增：多场次音乐播放系统数据
            musicSessions: [
                {
                    id: 'wedding-session-1',
                    name: '婚礼仪式播放列表',
                    description: '婚礼仪式环节音乐播放列表',
                    tracks: ['1', '2', '4']
                },
                {
                    id: 'wedding-session-2',
                    name: '宴会背景音乐列表',
                    description: '宴会用餐和互动环节背景音乐',
                    tracks: ['3', '5']
                },
                {
                    id: 'custom-session-1',
                    name: '自定义播放列表1',
                    description: '自定义音乐播放列表',
                    tracks: []
                }
            ],
            currentSession: null,
            sessionTrackIndex: 0,
            // 问卷数据
            questionnaires: [],
            selectedClientForQuestionnaire: null,
            currentQuestionnaire: null,
            // 新增：遥控器控制状态
            remoteControl: {
                volume: 0.7,
                isPlaying: false
            }
        };
        
        // 初始化数据
        function initData() {
            // 尝试从本地存储加载数据
            const savedEvents = localStorage.getItem('weddingHostEvents');
            const savedClients = localStorage.getItem('weddingHostClients');
            const savedMusic = localStorage.getItem('weddingHostMusic');
            const savedTemplates = localStorage.getItem('weddingHostTemplates');
            const savedSteps = localStorage.getItem('weddingHostSteps');
            const savedLocalFiles = localStorage.getItem('weddingHostLocalFiles');
            const savedTimeline = localStorage.getItem('weddingHostTimeline');
            const savedSessions = localStorage.getItem('weddingHostMusicSessions');
            const savedReminders = localStorage.getItem('weddingHostReminders');
            const savedCategories = localStorage.getItem('weddingHostMusicCategories');
            const savedQuestionnaires = localStorage.getItem('weddingHostQuestionnaires');
            // 主持人工具箱数据
            const savedLineCategories = localStorage.getItem('weddingHostLineCategories');
            const savedContracts = localStorage.getItem('weddingHostContracts');
            const savedGames = localStorage.getItem('weddingHostGames');
            const savedSpeeches = localStorage.getItem('weddingHostSpeeches');
            
            if (savedEvents) {
                AppState.events = JSON.parse(savedEvents);
            } else {
                // 初始化示例数据（包含往年数据）
                AppState.events = [
                    {
                        id: '1',
                        date: '2026-01-20',
                        type: 'wedding',
                        title: '张明&李丽婚礼',
                        startTime: '15:00',
                        endTime: '17:30',
                        location: '世纪大酒店宴会厅',
                        partner: '甜蜜蜜婚庆',
                        fee: 3000,
                        feeType: 'full',
                        paymentStatus: 'paid',
                        planLink: 'client-1',
                        notes: '新人喜欢浪漫风格，新娘入场需用《A Thousand Years》',
                        clientId: '1',
                        year: 2026,
                        reminder: {
                            enabled: true,
                            daysBefore: 7,
                            time: '09:00',
                            notified: false
                        }
                    },
                    {
                        id: '2',
                        date: '2026-01-25',
                        type: 'intent',
                        title: '王强&赵雪意向',
                        startTime: '14:00',
                        endTime: '15:00',
                        location: '星巴克咖啡',
                        partner: '',
                        fee: 0,
                        feeType: 'full',
                        paymentStatus: 'unpaid',
                        planLink: '',
                        notes: '初步沟通，需要下周确定细节',
                        clientId: '2',
                        year: 2026,
                        reminder: {
                            enabled: false,
                            daysBefore: 7,
                            time: '09:00',
                            notified: false
                        }
                    },
                    {
                        id: '3',
                        date: '2026-02-14',
                        type: 'wedding',
                        title: '陈东&刘芳婚礼',
                        startTime: '16:00',
                        endTime: '19:00',
                        location: '海滨度假村',
                        partner: '浪漫满屋婚庆',
                        fee: 4500,
                        feeType: 'deposit',
                        paymentStatus: 'deposit-paid',
                        planLink: 'client-3',
                        notes: '情人节主题婚礼，需要特别设计互动环节',
                        clientId: '3',
                        year: 2026,
                        reminder: {
                            enabled: true,
                            daysBefore: 7,
                            time: '09:00',
                            notified: false
                        }
                    },
                    // 往年示例数据
                    {
                        id: '4',
                        date: '2025-05-01',
                        type: 'wedding',
                        title: '刘伟&王芳婚礼',
                        startTime: '15:30',
                        endTime: '18:00',
                        location: '花园酒店',
                        partner: '幸福婚庆',
                        fee: 2800,
                        feeType: 'full',
                        paymentStatus: 'paid',
                        notes: '户外草坪婚礼',
                        clientId: null,
                        year: 2025
                    },
                    {
                        id: '5',
                        date: '2025-10-01',
                        type: 'wedding',
                        title: '陈刚&李娜婚礼',
                        startTime: '16:00',
                        endTime: '19:00',
                        location: '国际会议中心',
                        partner: '世纪婚庆',
                        fee: 5000,
                        feeType: 'full',
                        paymentStatus: 'paid',
                        notes: '大型婚礼，200人规模',
                        clientId: null,
                        year: 2025
                    },
                    {
                        id: '6',
                        date: '2024-03-08',
                        type: 'wedding',
                        title: '赵强&孙丽婚礼',
                        startTime: '14:00',
                        endTime: '17:00',
                        location: '教堂',
                        partner: '神圣婚庆',
                        fee: 3500,
                        feeType: 'full',
                        paymentStatus: 'paid',
                        notes: '教堂婚礼，庄重仪式',
                        clientId: null,
                        year: 2024
                    }
                ];
            }
            
            if (savedClients) {
                AppState.clients = JSON.parse(savedClients);
            } else {
                // 初始化示例客户数据（包含费用信息）
                AppState.clients = [
                    {
                        id: '1',
                        groomName: '张明',
                        brideName: '李丽',
                        phone: '13800138000',
                        weddingDate: '2026-01-20',
                        venue: '世纪大酒店宴会厅',
                        ceremonyTime: '15:30',
                        receptionTime: '17:30',
                        fee: 3000,
                        paidAmount: 3000,
                        paymentStatus: 'paid',
                        notes: '新人都是教师，喜欢简约温馨风格',
                        contractStatus: 'paid',
                        questionnaireId: null // 新增：问卷ID
                    },
                    {
                        id: '2',
                        groomName: '王强',
                        brideName: '赵雪',
                        phone: '13900139000',
                        weddingDate: '2026-05-01',
                        venue: '未定',
                        ceremonyTime: '',
                        receptionTime: '',
                        fee: 0,
                        paidAmount: 0,
                        paymentStatus: 'unpaid',
                        notes: '意向客户，预算中等，需要提供方案',
                        contractStatus: 'pending',
                        questionnaireId: null
                    },
                    {
                        id: '3',
                        groomName: '陈东',
                        brideName: '刘芳',
                        phone: '13700137000',
                        weddingDate: '2026-02-14',
                        venue: '海滨度假村',
                        ceremonyTime: '16:30',
                        receptionTime: '18:00',
                        fee: 4500,
                        paidAmount: 2000,
                        paymentStatus: 'deposit',
                        notes: '情人节主题，需要设计特别互动',
                        contractStatus: 'deposit',
                        questionnaireId: null
                    }
                ];
            }
            
            if (savedMusic) {
                AppState.music = JSON.parse(savedMusic);
            } else {
                // 初始化示例音乐数据
                AppState.music = [
                    {
                        id: '1',
                        title: 'A Thousand Years',
                        artist: 'Christina Perri',
                        category: 'entrance',
                        source: '网易云音乐 #123456',
                        notes: '适合新娘入场，浪漫唯美',
                        fileType: 'link'
                    },
                    {
                        id: '2',
                        title: 'Perfect',
                        artist: 'Ed Sheeran',
                        category: 'ceremony',
                        source: 'QQ音乐 #789012',
                        notes: '适合誓言环节，深情动人',
                        fileType: 'link'
                    },
                    {
                        id: '3',
                        title: 'Marry You',
                        artist: 'Bruno Mars',
                        category: 'recessional',
                        source: '网易云音乐 #345678',
                        notes: '适合新人退场，欢快活泼',
                        fileType: 'link'
                    },
                    {
                        id: '4',
                        title: 'Canon in D',
                        artist: 'Johann Pachelbel',
                        category: 'entrance',
                        source: '本地音乐库',
                        notes: '经典婚礼入场音乐，优雅庄重',
                        fileType: 'link'
                    },
                    {
                        id: '5',
                        title: 'How Long Will I Love You',
                        artist: 'Ellie Goulding',
                        category: 'ceremony',
                        source: 'QQ音乐 #901234',
                        notes: '适合交换戒指环节',
                        fileType: 'link'
                    }
                ];
            }
            
            if (savedTemplates) {
                AppState.templates = JSON.parse(savedTemplates);
            } else {
                // 初始化示例问卷模板
                AppState.templates = [
                    {
                        id: '1',
                        name: '标准婚礼问卷',
                        description: '适用于大多数传统婚礼的标准问卷',
                        tags: ['标准', '传统', '通用'],
                        questions: [
                            { id: 'q1', question: '新人爱情故事', type: 'textarea' },
                            { id: 'q2', question: '婚礼主题/风格', type: 'text' },
                            { id: 'q3', question: '婚礼色调', type: 'text' },
                            { id: 'q4', question: '特殊环节要求', type: 'textarea' },
                            { id: 'q5', question: '禁忌与注意事项', type: 'textarea' }
                        ],
                        isDefault: true
                    },
                    {
                        id: '2',
                        name: '西式教堂婚礼问卷',
                        description: '专门针对教堂婚礼的特殊问卷',
                        tags: ['教堂', '西式', '宗教'],
                        questions: [
                            { id: 'q1', question: '新人爱情故事', type: 'textarea' },
                            { id: 'q2', question: '教堂名称', type: 'text' },
                            { id: 'q3', question: '是否有宗教仪式要求', type: 'text' },
                            { id: 'q4', question: '牧师/神父的特殊要求', type: 'textarea' },
                            { id: 'q5', question: '教堂音乐限制', type: 'textarea' }
                        ],
                        isDefault: false
                    }
                ];
            }
            
            if (savedSteps) {
                AppState.customSteps = JSON.parse(savedSteps);
            } else {
                // 初始化示例自定义环节
                AppState.customSteps = [
                    {
                        id: '1',
                        name: 'First Look 环节',
                        time: '仪式前',
                        duration: 15,
                        description: '新郎第一次看到穿婚纱的新娘，营造惊喜感',
                        clientId: ''
                    }
                ];
            }
            
            if (savedLocalFiles) {
                AppState.localMusicFiles = JSON.parse(savedLocalFiles);
            } else {
                // 初始化示例本地文件
                AppState.localMusicFiles = [];
            }
            
            if (savedTimeline) {
                AppState.timelineSteps = JSON.parse(savedTimeline);
            } else {
                // 初始化时间轴数据
                AppState.timelineSteps = [
                    {
                        id: 'step-1',
                        type: 'standard',
                        time: '15:00 - 15:30',
                        title: '迎宾与签到',
                        description: '主持人迎宾，引导宾客签到，暖场音乐播放。'
                    },
                    {
                        id: 'step-2',
                        type: 'standard',
                        time: '15:30 - 15:40',
                        title: '开场白与宾客欢迎',
                        description: '主持人开场，介绍婚礼主题，欢迎所有来宾。'
                    },
                    {
                        id: 'step-3',
                        type: 'standard',
                        time: '15:40 - 15:50',
                        title: '新郎入场',
                        description: '新郎登场，与主持人简短互动。'
                    }
                ];
            }
            
            if (savedSessions) {
                AppState.musicSessions = JSON.parse(savedSessions);
            }
            
            if (savedCategories) {
                AppState.musicCategories = JSON.parse(savedCategories);
            }
            
            if (savedQuestionnaires) {
                AppState.questionnaires = JSON.parse(savedQuestionnaires);
            }
            
            // 加载主持人工具箱数据
            if (savedLineCategories) {
                AppState.lineCategories = JSON.parse(savedLineCategories);
            }
            
            if (savedContracts) {
                AppState.contracts = JSON.parse(savedContracts);
            }
            
            if (savedGames) {
                AppState.games = JSON.parse(savedGames);
            }
            
            if (savedSpeeches) {
                AppState.speeches = JSON.parse(savedSpeeches);
            }
            
            // 检查提醒
            checkReminders();
            
            // 初始化音频播放器
            AppState.audioPlayer = new Audio();
            AppState.audioPlayer.volume = AppState.remoteControl.volume;
            AppState.audioPlayer.addEventListener('timeupdate', updateMusicProgress);
            AppState.audioPlayer.addEventListener('ended', function() {
                // 如果有多场次播放，播放下一个
                if (AppState.currentSession && AppState.sessionTrackIndex < AppState.currentSession.tracks.length - 1) {
                    AppState.sessionTrackIndex++;
                    playSessionTrack(AppState.currentSession.id, AppState.sessionTrackIndex);
                } else {
                    AppState.playingMusic = null;
                    AppState.remoteControl.isPlaying = false;
                    updateRemoteControlButtons();
                    renderMusicLibrary();
                    renderSessionPlaylist();
                }
            });
            
            updateDataStatus();
            updateClientStats();
            renderCustomSteps();
            renderTimeline();
            renderSessionSelector();
            renderMusicCategories();
            
            // 初始化遥控器控制
            initRemoteControl();
        }
        
        // 检查提醒
        function checkReminders() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            AppState.events.forEach(event => {
                if (event.reminder && event.reminder.enabled && !event.reminder.notified) {
                    const eventDate = new Date(event.date);
                    const reminderDate = new Date(eventDate);
                    reminderDate.setDate(reminderDate.getDate() - event.reminder.daysBefore);
                    const reminderDateStr = reminderDate.toISOString().split('T')[0];
                    
                    if (reminderDateStr === todayStr) {
                        // 显示提醒
                        showReminderNotification(event);
                        event.reminder.notified = true;
                    }
                }
            });
            
            // 保存更新后的提醒状态
            saveData();
        }
        
        // 显示提醒通知
        function showReminderNotification(event) {
            // 使用浏览器通知API
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('婚礼主持提醒', {
                    body: `您有一个${event.type === 'wedding' ? '婚礼' : '活动'}即将举行：${event.title}\n日期：${event.date} ${event.startTime}\n地点：${event.location || '未指定'}`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/1077/1077035.png'
                });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showReminderNotification(event);
                    }
                });
            }
            
            // 也在页面上显示提醒
            setTimeout(() => {
                alert(`提醒：您有一个${event.type === 'wedding' ? '婚礼' : '活动'}即将举行\n${event.title}\n日期：${event.date} ${event.startTime}\n地点：${event.location || '未指定'}`);
            }, 1000);
        }
        
        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('weddingHostEvents', JSON.stringify(AppState.events));
            localStorage.setItem('weddingHostClients', JSON.stringify(AppState.clients));
            localStorage.setItem('weddingHostMusic', JSON.stringify(AppState.music));
            localStorage.setItem('weddingHostTemplates', JSON.stringify(AppState.templates));
            localStorage.setItem('weddingHostSteps', JSON.stringify(AppState.customSteps));
            localStorage.setItem('weddingHostLocalFiles', JSON.stringify(AppState.localMusicFiles));
            localStorage.setItem('weddingHostTimeline', JSON.stringify(AppState.timelineSteps));
            localStorage.setItem('weddingHostMusicSessions', JSON.stringify(AppState.musicSessions));
            localStorage.setItem('weddingHostMusicCategories', JSON.stringify(AppState.musicCategories));
            localStorage.setItem('weddingHostQuestionnaires', JSON.stringify(AppState.questionnaires));
            // 保存主持人工具箱数据
            localStorage.setItem('weddingHostLineCategories', JSON.stringify(AppState.lineCategories));
            localStorage.setItem('weddingHostContracts', JSON.stringify(AppState.contracts));
            localStorage.setItem('weddingHostGames', JSON.stringify(AppState.games));
            localStorage.setItem('weddingHostSpeeches', JSON.stringify(AppState.speeches));
            updateDataStatus();
            updateClientStats();
        }
        
        // 更新数据状态显示
        function updateDataStatus() {
            const eventCount = AppState.events.filter(e => {
                const eventYear = new Date(e.date).getFullYear();
                return eventYear === new Date().getFullYear();
            }).length;
            const clientCount = AppState.clients.length;
            const musicCount = AppState.music.length;
            const templateCount = AppState.templates.length;
            const stepCount = AppState.customSteps.length;
            const sessionCount = AppState.musicSessions.length;
            document.getElementById('dataStatus').textContent = 
                `已保存 ${clientCount} 个客户，${eventCount} 个档期，${musicCount} 首音乐，${templateCount} 个模板，${sessionCount} 个播放列表`;
        }
        
        // 更新客户统计
        function updateClientStats() {
            const totalClients = AppState.clients.length;
            let totalRevenue = 0;
            let totalFee = 0;
            let paidClients = 0;
            
            AppState.clients.forEach(client => {
                totalFee += client.fee || 0;
                if (client.paymentStatus === 'paid') {
                    totalRevenue += client.fee || 0;
                    paidClients++;
                } else if (client.paymentStatus === 'deposit' || client.paymentStatus === 'partial') {
                    totalRevenue += client.paidAmount || 0;
                }
            });
            
            const avgFee = totalClients > 0 ? Math.round(totalFee / totalClients) : 0;
            
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('totalRevenue').textContent = `¥${totalRevenue}`;
            document.getElementById('avgFee').textContent = `¥${avgFee}`;
            document.getElementById('paidClients').textContent = paidClients;
        }
        
        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // 导航切换
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    
                    // 更新活动状态
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 切换标签内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    document.getElementById(`${tab}-tab`).classList.add('active');
                    AppState.currentTab = tab;
                    
                    // 根据标签执行特定操作
                    switch(tab) {
                        case 'calendar':
                            if (AppState.currentYearView === 'current') {
                                if (AppState.currentView === 'calendar') {
                                    renderCalendar();
                                } else {
                                    renderEventsList();
                                }
                                updateCalendarStats();
                            } else {
                                renderPrevYearView();
                            }
                            break;
                        case 'clients':
                            renderClientsList();
                            break;
                        case 'questionnaire':
                            renderQuestionnaireTemplates();
                            // 显示/隐藏问卷操作按钮
                            updateQuestionnaireActionButtons();
                            break;
                        case 'planning':
                            renderCustomSteps();
                            break;
                        case 'music':
                            renderMusicLibrary();
                            renderSessionSelector();
                            renderSessionPlaylist();
                            // 更新遥控器按钮状态
                            updateRemoteControlButtons();
                            break;
                        case 'toolkit':
                            // 重新初始化主持人工具箱功能
                            setupToolkit();
                            break;
                    }
                });
            });
        }
        
        // 视图切换（日历/列表）- 修改：互斥显示
        function setupViewToggle() {
            const viewBtns = document.querySelectorAll('.view-btn');
            const calendarView = document.querySelector('.calendar-view');
            const listView = document.getElementById('listViewContainer');
            
            viewBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    
                    // 更新按钮状态
                    viewBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    AppState.currentView = view;
                    
                    // 切换视图显示 - 互斥显示
                    if (view === 'calendar') {
                        calendarView.classList.add('active-view');
                        listView.classList.remove('active-view');
                        renderCalendar();
                    } else {
                        calendarView.classList.remove('active-view');
                        listView.classList.add('active-view');
                        renderEventsList();
                    }
                });
            });
        }
        
        // 年份视图切换（本年/往年）
        function setupYearToggle() {
            const yearBtns = document.querySelectorAll('.year-btn[data-year]');
            const currentYearView = document.querySelector('.current-year-view');
            const prevYearView = document.querySelector('.prev-year-view');
            
            yearBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const yearView = this.getAttribute('data-year');
                    
                    // 更新按钮状态
                    yearBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    AppState.currentYearView = yearView;
                    
                    // 切换年份视图显示
                    if (yearView === 'current') {
                        currentYearView.style.display = 'block';
                        prevYearView.style.display = 'none';
                        if (AppState.currentView === 'calendar') {
                            renderCalendar();
                        } else {
                            renderEventsList();
                        }
                        updateCalendarStats();
                    } else {
                        currentYearView.style.display = 'none';
                        prevYearView.style.display = 'block';
                        renderPrevYearView();
                    }
                });
            });
            
            // 往年年份切换
            const prevYearBtns = document.querySelectorAll('.year-btn[data-prev-year]');
            prevYearBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const year = this.getAttribute('data-prev-year');
                    
                    // 更新按钮状态
                    prevYearBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    AppState.selectedPrevYear = year;
                    renderPrevYearView();
                });
            });
        }
        
        // 日历功能
        function setupCalendar() {
            renderCalendar();
            
            // 上月/下月按钮
            document.getElementById('prevMonth').addEventListener('click', function() {
                AppState.currentDate.setMonth(AppState.currentDate.getMonth() - 1);
                renderCalendar();
                updateCalendarStats();
            });
            
            document.getElementById('nextMonth').addEventListener('click', function() {
                AppState.currentDate.setMonth(AppState.currentDate.getMonth() + 1);
                renderCalendar();
                updateCalendarStats();
            });
            
            // 添加档期按钮
            document.getElementById('addEventBtn').addEventListener('click', function() {
                openEventModal();
            });
            
            // 关闭详情面板按钮
            document.getElementById('closeDetailBtn').addEventListener('click', function() {
                document.getElementById('eventDetailPanel').style.display = 'none';
            });
            
            // 统计卡片点击事件
            document.getElementById('monthEventsCard').addEventListener('click', function() {
                filterEventsByType('all');
            });
            
            document.getElementById('confirmedEventsCard').addEventListener('click', function() {
                filterEventsByType('wedding');
            });
            
            document.getElementById('intentEventsCard').addEventListener('click', function() {
                filterEventsByType('intent');
            });
            
            // 初始化日历统计
            updateCalendarStats();
        }
        
        // 按类型筛选事件
        function filterEventsByType(type) {
            // 切换到列表视图
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.view-btn[data-view="list"]').classList.add('active');
            
            const calendarView = document.querySelector('.calendar-view');
            const listView = document.getElementById('listViewContainer');
            calendarView.classList.remove('active-view');
            listView.classList.add('active-view');
            AppState.currentView = 'list';
            
            // 渲染筛选后的事件列表
            renderEventsList(type);
            
            // 显示筛选提示
            let filterText = '';
            switch(type) {
                case 'wedding':
                    filterText = '已确认婚礼';
                    break;
                case 'intent':
                    filterText = '意向客户';
                    break;
                default:
                    filterText = '本月活动';
            }
            
            // 在列表顶部显示筛选信息
            const eventsList = document.getElementById('eventsList');
            const filterInfo = document.createElement('div');
            filterInfo.className = 'month-divider';
            filterInfo.textContent = `筛选：${filterText}`;
            
            if (eventsList.firstChild && !eventsList.firstChild.classList.contains('month-divider')) {
                eventsList.insertBefore(filterInfo, eventsList.firstChild);
            }
        }
        
        // 渲染日历
        function renderCalendar() {
            const year = AppState.currentDate.getFullYear();
            const month = AppState.currentDate.getMonth();
            
            // 更新当前月份显示
            document.getElementById('currentMonth').textContent = 
                `${year}年${month + 1}月`;
            
            // 获取当月第一天和最后一天
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // 获取第一天是星期几（0=周日，1=周一，...）
            const firstDayOfWeek = firstDay.getDay();
            
            // 日历网格
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // 添加星期标题
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // 添加空白单元格（上个月的日期）
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // 添加当月日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.setAttribute('data-date', dateStr);
                
                // 日期数字
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                
                // 检查是否有提醒
                const dayEvents = AppState.events.filter(event => {
                    return event.date === dateStr && new Date(event.date).getFullYear() === year;
                });
                
                // 检查是否有设置提醒的事件
                const hasReminder = dayEvents.some(event => 
                    event.reminder && event.reminder.enabled && !event.reminder.notified
                );
                
                if (hasReminder) {
                    const reminderIcon = document.createElement('div');
                    reminderIcon.className = 'day-reminder';
                    reminderIcon.title = '有活动提醒';
                    reminderIcon.innerHTML = '<i class="fas fa-bell"></i>';
                    dayNumber.appendChild(reminderIcon);
                }
                
                dayElement.appendChild(dayNumber);
                
                // 添加当天的事件（只显示当前年份的事件）
                dayEvents.forEach(event => {
                    const eventIndicator = document.createElement('div');
                    eventIndicator.className = `event-indicator event-${event.type}`;
                    eventIndicator.textContent = event.title;
                    eventIndicator.setAttribute('data-event-id', event.id);
                    
                    eventIndicator.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const eventId = this.getAttribute('data-event-id');
                        showEventDetails(eventId);
                    });
                    
                    dayElement.appendChild(eventIndicator);
                });
                
                // 点击日期添加新事件
                dayElement.addEventListener('click', function() {
                    const date = this.getAttribute('data-date');
                    openEventModal(date);
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            // 更新统计信息
            updateCalendarStats();
        }
        
        // 渲染事件列表（带月份分隔线）
        function renderEventsList(filterType = 'all') {
            const eventsList = document.getElementById('eventsList');
            const currentYear = new Date().getFullYear();
            
            // 只显示当前年份的事件
            let currentYearEvents = AppState.events.filter(event => {
                const eventYear = new Date(event.date).getFullYear();
                return eventYear === currentYear;
            });
            
            // 应用筛选
            if (filterType !== 'all') {
                currentYearEvents = currentYearEvents.filter(event => event.type === filterType);
            }
            
            if (currentYearEvents.length === 0) {
                let emptyMessage = '暂无档期安排';
                if (filterType !== 'all') {
                    emptyMessage = filterType === 'wedding' ? '暂无已确认婚礼' : '暂无意向客户';
                }
                
                eventsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <h3>${emptyMessage}</h3>
                        <p>点击"添加档期"按钮开始记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期排序
            const sortedEvents = [...currentYearEvents].sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });
            
            let html = '';
            let currentMonth = null;
            
            sortedEvents.forEach(event => {
                // 格式化日期
                const eventDate = new Date(event.date);
                const eventMonth = eventDate.getMonth() + 1;
                
                // 添加月份分隔线
                if (currentMonth !== eventMonth) {
                    currentMonth = eventMonth;
                    html += `<div class="month-divider">${eventMonth}月</div>`;
                }
                
                const formattedDate = `${eventMonth}月${eventDate.getDate()}日`;
                
                // 事件类型标签
                let typeClass = '';
                let typeText = '';
                switch(event.type) {
                    case 'wedding':
                        typeClass = 'badge-primary';
                        typeText = '婚礼';
                        break;
                    case 'intent':
                        typeClass = 'badge-warning';
                        typeText = '意向';
                        break;
                    case 'other':
                        typeClass = 'badge-info';
                        typeText = '其他';
                        break;
                }
                
                // 费用状态
                let feeStatus = '';
                if (event.fee && event.fee > 0) {
                    if (event.paymentStatus === 'paid') {
                        feeStatus = `<span class="fee-status fee-paid">已结清 ¥${event.fee}</span>`;
                    } else if (event.paymentStatus === 'deposit-paid') {
                        feeStatus = `<span class="fee-status fee-deposit">定金已付</span>`;
                    } else {
                        feeStatus = `<span class="fee-status fee-unpaid">待支付 ¥${event.fee}</span>`;
                    }
                }
                
                // 提醒状态
                let reminderStatus = '';
                if (event.reminder && event.reminder.enabled) {
                    const reminderIcon = event.reminder.notified ? 'fas fa-bell-slash' : 'fas fa-bell';
                    reminderStatus = `<i class="${reminderIcon}" style="color: var(--warning); margin-left: 5px;" title="${event.reminder.notified ? '提醒已通知' : `提前${event.reminder.daysBefore}天提醒`}"></i>`;
                }
                
                // 时间选择文本
                const timeSlotMap = {
                    morning: '上午',
                    noon: '中午',
                    afternoon: '下午',
                    evening: '晚上'
                };
                const timeSlotText = event.timeSlot ? timeSlotMap[event.timeSlot] || '未指定' : '未指定';
                
                html += `
                    <li class="event-list-item" data-event-id="${event.id}" onclick="showEventDetails('${event.id}')" style="cursor: pointer;">
                        <div class="event-list-date">${formattedDate} ${reminderStatus}</div>
                        <div class="event-list-type ${typeClass}">${typeText}</div>
                        <div>
                            <div class="event-list-title">${event.title}</div>
                            <div class="event-list-location">${timeSlotText} · ${event.location || '地点待定'}</div>
                            ${event.partner ? `<div class="event-list-location">合作方：${event.partner}</div>` : ''}
                            ${feeStatus}
                        </div>
                        <div>${event.startTime} - ${event.endTime}</div>
                        <div class="event-list-actions">
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); editEvent('${event.id}')">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); deleteEvent('${event.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
            
            eventsList.innerHTML = html;
        }
        
        // 显示档期详情 - 优化布局
        function showEventDetails(eventId) {
            const event = AppState.events.find(e => e.id === eventId);
            if (!event) return;
            
            const detailPanel = document.getElementById('eventDetailPanel');
            const detailContent = document.getElementById('eventDetailContent');
            
            // 格式化日期
            const eventDate = new Date(event.date);
            const formattedDate = `${eventDate.getFullYear()}年${eventDate.getMonth() + 1}月${eventDate.getDate()}日`;
            
            // 事件类型文本
            let typeText = '';
            switch(event.type) {
                case 'wedding':
                    typeText = '婚礼主持';
                    break;
                case 'intent':
                    typeText = '意向客户';
                    break;
                case 'other':
                    typeText = '其他活动';
                    break;
            }
            
            // 时间选择文本
            const timeSlotMap = {
                morning: '上午',
                noon: '中午',
                afternoon: '下午',
                evening: '晚上'
            };
            const timeSlotText = event.timeSlot ? timeSlotMap[event.timeSlot] || '未指定' : '未指定';
            
            // 费用信息
            let feeInfo = '';
            if (event.fee && event.fee > 0) {
                let feeTypeText = '';
                switch(event.feeType) {
                    case 'full':
                        feeTypeText = '全款';
                        break;
                    case 'deposit':
                        feeTypeText = '定金';
                        break;
                    case 'installment':
                        feeTypeText = '分期';
                        break;
                }
                
                let paymentStatusText = '';
                let paymentStatusClass = '';
                switch(event.paymentStatus) {
                    case 'unpaid':
                        paymentStatusText = '未支付';
                        paymentStatusClass = 'fee-unpaid';
                        break;
                    case 'deposit-paid':
                        paymentStatusText = '定金已付';
                        paymentStatusClass = 'fee-deposit';
                        break;
                    case 'partial':
                        paymentStatusText = '部分支付';
                        paymentStatusClass = 'fee-deposit';
                        break;
                    case 'paid':
                        paymentStatusText = '已结清';
                        paymentStatusClass = 'fee-paid';
                        break;
                }
                
                feeInfo = `
                    <div class="detail-section">
                        <div class="detail-section-title">费用信息</div>
                        <div class="detail-grid">
                            <div class="detail-label">总费用</div>
                            <div class="detail-value">¥${event.fee}</div>
                            <div class="detail-label">费用类型</div>
                            <div class="detail-value">${feeTypeText}</div>
                            <div class="detail-label">支付状态</div>
                            <div class="detail-value"><span class="fee-status ${paymentStatusClass}">${paymentStatusText}</span></div>
                        </div>
                    </div>
                `;
            }
            
            // 提醒信息
            let reminderInfo = '';
            if (event.reminder) {
                const reminderIcon = event.reminder.notified ? 'fas fa-bell-slash' : 'fas fa-bell';
                const reminderStatus = event.reminder.notified ? '已通知' : '未通知';
                const reminderDate = new Date(eventDate);
                reminderDate.setDate(reminderDate.getDate() - event.reminder.daysBefore);
                const reminderDateStr = `${reminderDate.getMonth() + 1}月${reminderDate.getDate()}日 ${event.reminder.time}`;
                
                reminderInfo = `
                    <div class="detail-section">
                        <div class="detail-section-title">提醒设置</div>
                        <div class="detail-grid">
                            <div class="detail-label">提醒状态</div>
                            <div class="detail-value"><i class="${reminderIcon}"></i> ${reminderStatus}</div>
                            <div class="detail-label">提醒时间</div>
                            <div class="detail-value">${reminderDateStr} (提前${event.reminder.daysBefore}天)</div>
                        </div>
                    </div>
                `;
            }
            
            // 环节链接
            let planLinkHtml = '';
            if (event.planLink) {
                planLinkHtml = `
                    <div class="detail-label">环节规划链接</div>
                    <div class="detail-value">
                        <a href="#" onclick="goToPlanning('${event.planLink}')" style="color: var(--primary); text-decoration: none;">
                            <i class="fas fa-link"></i> 查看环节规划
                        </a>
                    </div>
                `;
            }
            
            // 添加编辑按钮到详情顶部
            const html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;color: var(--primary);">${event.title} - 档期详情</h3>
                    <button class="btn btn-primary" onclick="editEvent('${event.id}')">
                        <i class="fas fa-edit"></i> 编辑档期
                    </button>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">基本信息</div>
                    <div class="detail-grid">
                        <div class="detail-label">活动名称</div>
                        <div class="detail-value">${event.title}</div>
                        <div class="detail-label">活动日期</div>
                        <div class="detail-value">${formattedDate}</div>
                        <div class="detail-label">活动类型</div>
                        <div class="detail-value">${typeText}</div>
                        <div class="detail-label">时间选择</div>
                        <div class="detail-value">${timeSlotText}</div>
                        <div class="detail-label">具体时间</div>
                        <div class="detail-value">${event.startTime} - ${event.endTime}</div>
                        <div class="detail-label">活动地点</div>
                        <div class="detail-value">${event.location || '未指定'}</div>
                        <div class="detail-label">合作方</div>
                        <div class="detail-value">${event.partner || '无'}</div>
                        ${planLinkHtml}
                    </div>
                </div>
                ${feeInfo}
                ${reminderInfo}
                <div class="detail-section">
                    <div class="detail-section-title">备注信息</div>
                    <div style="padding: 15px; background-color: white; border-radius: 6px; border: 1px solid #eee;">
                        <div style="white-space: pre-wrap; line-height: 1.6;">${event.notes || '无'}</div>
                    </div>
                </div>
            `;
            
            detailContent.innerHTML = html;
            detailPanel.style.display = 'block';
            
            // 滚动到详情面板
            detailPanel.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 渲染往年记录视图
        function renderPrevYearView() {
            const year = parseInt(AppState.selectedPrevYear);
            const prevYearEvents = AppState.events.filter(event => {
                const eventYear = new Date(event.date).getFullYear();
                return eventYear === year;
            });
            
            // 渲染图表
            renderPrevYearCharts(year, prevYearEvents);
            
            // 渲染事件列表
            renderPrevYearEventsList(year, prevYearEvents);
        }
        
        // 渲染往年图表
        function renderPrevYearCharts(year, events) {
            const eventsChart = document.getElementById('prevYearEventsChart');
            const incomeChart = document.getElementById('prevYearIncomeChart');
            
            // 初始化月份数据
            const monthData = Array(12).fill(0).map((_, i) => ({
                month: i + 1,
                events: 0,
                income: 0
            }));
            
            // 统计每月数据
            events.forEach(event => {
                if (event.type === 'wedding') {
                    const eventDate = new Date(event.date);
                    const month = eventDate.getMonth();
                    
                    monthData[month].events++;
                    
                    if (event.paymentStatus === 'paid' && event.fee) {
                        monthData[month].income += event.fee;
                    } else if ((event.paymentStatus === 'deposit-paid' || event.paymentStatus === 'partial') && event.fee) {
                        monthData[month].income += event.fee * 0.5; // 假设定金为50%
                    }
                }
            });
            
            // 计算最大值用于比例
            const maxEvents = Math.max(...monthData.map(m => m.events), 1);
            const maxIncome = Math.max(...monthData.map(m => m.income), 1);
            
            // 渲染事件数量图表
            let eventsHtml = '';
            monthData.forEach(data => {
                const height = (data.events / maxEvents) * 180;
                const monthName = `${data.month}月`;
                
                eventsHtml += `
                    <div class="bar-item">
                        <div class="bar-value">${data.events}</div>
                        <div class="bar" style="height: ${height}px;"></div>
                        <div class="bar-label">${monthName}</div>
                    </div>
                `;
            });
            eventsChart.innerHTML = eventsHtml;
            
            // 渲染收入图表
            let incomeHtml = '';
            monthData.forEach(data => {
                const height = (data.income / maxIncome) * 180;
                const monthName = `${data.month}月`;
                const incomeText = data.income > 0 ? `¥${data.income}` : '0';
                
                incomeHtml += `
                    <div class="bar-item">
                        <div class="bar-value">${incomeText}</div>
                        <div class="bar bar-income" style="height: ${height}px;"></div>
                        <div class="bar-label">${monthName}</div>
                    </div>
                `;
            });
            incomeChart.innerHTML = incomeHtml;
        }
        
        // 渲染往年事件列表
        function renderPrevYearEventsList(year, events) {
            const container = document.getElementById('prevYearEventsList');
            
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <h3>${year}年暂无档期记录</h3>
                        <p>该年份没有找到档期记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期排序
            const sortedEvents = [...events].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            let html = '<ul class="data-list">';
            
            sortedEvents.forEach(event => {
                // 格式化日期
                const eventDate = new Date(event.date);
                const formattedDate = `${eventDate.getMonth() + 1}月${eventDate.getDate()}日`;
                
                // 事件类型标签
                let typeClass = '';
                let typeText = '';
                switch(event.type) {
                    case 'wedding':
                        typeClass = 'badge-primary';
                        typeText = '婚礼';
                        break;
                    case 'intent':
                        typeClass = 'badge-warning';
                        typeText = '意向';
                        break;
                    case 'other':
                        typeClass = 'badge-info';
                        typeText = '其他';
                        break;
                }
                
                // 费用状态
                let feeStatus = '';
                if (event.fee && event.fee > 0) {
                    if (event.paymentStatus === 'paid') {
                        feeStatus = `<span class="fee-status fee-paid">已结清 ¥${event.fee}</span>`;
                    } else if (event.paymentStatus === 'deposit-paid') {
                        feeStatus = `<span class="fee-status fee-deposit">定金已付</span>`;
                    } else {
                        feeStatus = `<span class="fee-status fee-unpaid">待支付 ¥${event.fee}</span>`;
                    }
                }
                
                html += `
                    <li class="data-item">
                        <div class="item-info">
                            <h4>${event.title}</h4>
                            <p>${formattedDate} | ${event.location || '地点未指定'} | ${event.startTime} - ${event.endTime}</p>
                            <span class="badge ${typeClass}">${typeText}</span>
                            ${feeStatus}
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-small btn-secondary" onclick="showEventDetails('${event.id}')">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            container.innerHTML = html;
        }
        
        // 更新日历统计
        function updateCalendarStats() {
            const year = AppState.currentDate.getFullYear();
            const month = AppState.currentDate.getMonth() + 1;
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            
            // 筛选当月事件
            const monthEvents = AppState.events.filter(event => event.date.startsWith(monthStr));
            const confirmedEvents = monthEvents.filter(event => event.type === 'wedding').length;
            const intentEvents = monthEvents.filter(event => event.type === 'intent').length;
            const totalEvents = monthEvents.length;
            
            // 计算当月收入
            let revenue = 0;
            monthEvents.forEach(event => {
                if (event.paymentStatus === 'paid' && event.fee) {
                    revenue += event.fee;
                } else if (event.paymentStatus === 'deposit-paid' && event.fee) {
                    // 假设定金为总费用的50%
                    revenue += event.fee * 0.5;
                }
            });
            
            // 更新显示
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('confirmedEvents').textContent = confirmedEvents;
            document.getElementById('intentEvents').textContent = intentEvents;
            document.getElementById('revenue').textContent = `¥${revenue}`;
        }
        
        // 打开事件模态框
        function openEventModal(date = null) {
            const modal = document.getElementById('eventModal');
            const form = document.getElementById('eventForm');
            
            // 重置表单
            form.reset();
            
            // 设置日期
            if (date) {
                document.getElementById('eventDate').value = date;
            } else {
                // 默认设为今天
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('eventDate').value = today;
            }
            
            // 设置时间（默认下午2点开始，4点结束）
            document.getElementById('eventStartTime').value = '14:00';
            document.getElementById('eventEndTime').value = '16:00';
            
            // 设置提醒选项
            document.getElementById('eventReminder').checked = true;
            document.getElementById('reminderDays').value = 7;
            document.getElementById('reminderTime').value = '09:00';
            
            // 清除编辑状态
            AppState.editingEvent = null;
            document.getElementById('eventId').value = '';
            
            modal.classList.add('active');
        }
        
        // 编辑事件
        function editEvent(eventId) {
            const event = AppState.events.find(e => e.id === eventId);
            if (!event) return;
            
            const modal = document.getElementById('eventModal');
            const form = document.getElementById('eventForm');
            
            // 填充表单
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTimeSlot').value = event.timeSlot || 'afternoon';
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventStartTime').value = event.startTime;
            document.getElementById('eventEndTime').value = event.endTime;
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventPartner').value = event.partner || '';
            document.getElementById('eventFee').value = event.fee || '';
            document.getElementById('feeType').value = event.feeType || 'full';
            document.getElementById('paymentStatus').value = event.paymentStatus || 'unpaid';
            document.getElementById('eventPlanLink').value = event.planLink || '';
            document.getElementById('eventNotes').value = event.notes || '';
            document.getElementById('eventId').value = event.id;
            
            // 设置提醒选项
            if (event.reminder) {
                document.getElementById('eventReminder').checked = event.reminder.enabled;
                document.getElementById('reminderDays').value = event.reminder.daysBefore;
                document.getElementById('reminderTime').value = event.reminder.time;
            } else {
                document.getElementById('eventReminder').checked = true;
                document.getElementById('reminderDays').value = 7;
                document.getElementById('reminderTime').value = '09:00';
            }
            
            // 设置编辑状态
            AppState.editingEvent = event;
            
            modal.classList.add('active');
        }
        
        // 保存事件
        function setupEventModal() {
            const modal = document.getElementById('eventModal');
            const closeBtn = document.getElementById('closeEventModal');
            const cancelBtn = document.getElementById('cancelEventBtn');
            const saveBtn = document.getElementById('saveEventBtn');
            
            // 关闭模态框
            function closeModal() {
                modal.classList.remove('active');
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 保存事件
            saveBtn.addEventListener('click', function() {
                const form = document.getElementById('eventForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const eventDate = new Date(document.getElementById('eventDate').value);
                const eventYear = eventDate.getFullYear();
                
                const eventData = {
                    id: document.getElementById('eventId').value || generateId(),
                    date: document.getElementById('eventDate').value,
                    type: document.getElementById('eventType').value,
                    timeSlot: document.getElementById('eventTimeSlot').value,
                    title: document.getElementById('eventTitle').value,
                    startTime: document.getElementById('eventStartTime').value,
                    endTime: document.getElementById('eventEndTime').value,
                    location: document.getElementById('eventLocation').value,
                    partner: document.getElementById('eventPartner').value,
                    fee: document.getElementById('eventFee').value ? parseInt(document.getElementById('eventFee').value) : 0,
                    feeType: document.getElementById('feeType').value,
                    paymentStatus: document.getElementById('paymentStatus').value,
                    planLink: document.getElementById('eventPlanLink').value,
                    notes: document.getElementById('eventNotes').value,
                    year: eventYear,
                    reminder: {
                        enabled: document.getElementById('eventReminder').checked,
                        daysBefore: parseInt(document.getElementById('reminderDays').value),
                        time: document.getElementById('reminderTime').value,
                        notified: false
                    }
                };
                
                // 检查是否已存在相同ID的事件
                const existingIndex = AppState.events.findIndex(e => e.id === eventData.id);
                
                if (existingIndex >= 0) {
                    // 更新现有事件
                    AppState.events[existingIndex] = eventData;
                } else {
                    // 添加新事件
                    AppState.events.push(eventData);
                }
                
                // 保存数据
                saveData();
                
                // 刷新视图
                if (AppState.currentYearView === 'current') {
                    if (AppState.currentView === 'calendar') {
                        renderCalendar();
                    } else {
                        renderEventsList();
                    }
                } else {
                    renderPrevYearView();
                }
                
                // 更新统计
                updateCalendarStats();
                
                // 关闭模态框
                closeModal();
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 删除事件
        window.deleteEvent = function(eventId) {
            if (confirm('确定要删除这个档期吗？')) {
                AppState.events = AppState.events.filter(event => event.id !== eventId);
                saveData();
                
                // 刷新视图
                if (AppState.currentYearView === 'current') {
                    if (AppState.currentView === 'calendar') {
                        renderCalendar();
                    } else {
                        renderEventsList();
                    }
                } else {
                    renderPrevYearView();
                }
                
                // 更新统计
                updateCalendarStats();
                
                // 隐藏详情面板
                document.getElementById('eventDetailPanel').style.display = 'none';
            }
        };
        
        // 客户管理功能
        function setupClientManagement() {
            // 添加客户按钮
            document.getElementById('addClientBtn').addEventListener('click', function() {
                openClientModal();
            });
            
            // 渲染初始客户列表
            renderClientsList();
        }
        
        // 打开客户模态框
        function openClientModal(clientId = null) {
            const modal = document.getElementById('clientModal');
            const form = document.getElementById('clientForm');
            
            // 重置表单
            form.reset();
            
            if (clientId) {
                // 编辑现有客户
                const client = AppState.clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('groomName').value = client.groomName;
                    document.getElementById('brideName').value = client.brideName;
                    document.getElementById('clientPhone').value = client.phone;
                    document.getElementById('weddingDate').value = client.weddingDate;
                    document.getElementById('eventTimeSlot').value = client.timeSlot || 'afternoon';
                    document.getElementById('weddingVenue').value = client.venue || '';
                    document.getElementById('ceremonyTime').value = client.ceremonyTime || '';
                    document.getElementById('receptionTime').value = client.receptionTime || '';
                    document.getElementById('clientFee').value = client.fee || '';
                    document.getElementById('paidAmount').value = client.paidAmount || '';
                    document.getElementById('clientPaymentStatus').value = client.paymentStatus || 'unpaid';
                    document.getElementById('clientNotes').value = client.notes || '';
                    document.getElementById('contractStatus').value = client.contractStatus || 'pending';
                    document.getElementById('clientId').value = client.id;
                    
                    AppState.editingClient = client;
                }
            } else {
                // 添加新客户
                AppState.editingClient = null;
                document.getElementById('clientId').value = '';
                
                // 设置默认婚礼日期为下个月的同一天
                const defaultDate = new Date();
                defaultDate.setMonth(defaultDate.getMonth() + 1);
                document.getElementById('weddingDate').value = defaultDate.toISOString().split('T')[0];
                
                // 设置默认费用为0
                document.getElementById('clientFee').value = '';
                document.getElementById('paidAmount').value = '';
                document.getElementById('clientPaymentStatus').value = 'unpaid';
            }
            
            modal.classList.add('active');
        }
        
        // 保存客户
        function setupClientModal() {
            const modal = document.getElementById('clientModal');
            const closeBtn = document.getElementById('closeClientModal');
            const cancelBtn = document.getElementById('cancelClientBtn');
            const saveBtn = document.getElementById('saveClientBtn');
            const viewSummaryBtn = document.getElementById('viewClientSummaryBtn');
            const clientSummaryModal = document.getElementById('clientSummaryModal');
            const closeClientSummaryBtn = document.getElementById('closeClientSummaryBtn');
            const closeClientSummaryXBtn = document.getElementById('closeClientSummaryModal');
            
            // 关闭模态框
            function closeModal() {
                modal.classList.remove('active');
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 保存客户
            saveBtn.addEventListener('click', function() {
                const form = document.getElementById('clientForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const clientData = {
                    id: document.getElementById('clientId').value || generateId(),
                    groomName: document.getElementById('groomName').value,
                    brideName: document.getElementById('brideName').value,
                    phone: document.getElementById('clientPhone').value,
                    weddingDate: document.getElementById('weddingDate').value,
                    timeSlot: document.getElementById('eventTimeSlot').value,
                    venue: document.getElementById('weddingVenue').value,
                    ceremonyTime: document.getElementById('ceremonyTime').value,
                    receptionTime: document.getElementById('receptionTime').value,
                    fee: document.getElementById('clientFee').value ? parseInt(document.getElementById('clientFee').value) : 0,
                    paidAmount: document.getElementById('paidAmount').value ? parseInt(document.getElementById('paidAmount').value) : 0,
                    paymentStatus: document.getElementById('clientPaymentStatus').value,
                    notes: document.getElementById('clientNotes').value,
                    contractStatus: document.getElementById('contractStatus').value,
                    questionnaireId: null
                };
                
                // 检查是否已存在相同ID的客户
                const existingIndex = AppState.clients.findIndex(c => c.id === clientData.id);
                
                if (existingIndex >= 0) {
                    // 更新现有客户
                    AppState.clients[existingIndex] = clientData;
                } else {
                    // 添加新客户
                    AppState.clients.push(clientData);
                }
                
                // 保存数据
                saveData();
                
                // 刷新客户列表
                renderClientsList();
                
                // 关闭模态框
                closeModal();
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // 查看客户综合信息
            function showClientSummary() {
                const clientId = document.getElementById('clientId').value;
                if (!clientId) return;
                
                const client = AppState.clients.find(c => c.id === clientId);
                if (!client) return;
                
                // 查找客户相关的问卷
                const questionnaire = AppState.questionnaires.find(q => q.clientId === clientId);
                
                // 查找客户相关的环节规划
                const clientEvents = AppState.events.filter(e => e.clientId === clientId);
                
                // 生成综合信息HTML
                let html = `
                    <div class="client-summary">
                        <h4 style="margin-bottom: 20px; color: var(--primary);">${client.groomName} & ${client.brideName} - 综合信息</h4>
                        
                        <div class="summary-section" style="margin-bottom: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h5 style="margin-bottom: 15px;"><i class="fas fa-user-tag"></i> 基本信息</h5>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <strong>新郎姓名：</strong>${client.groomName}<br>
                                    <strong>新娘姓名：</strong>${client.brideName}<br>
                                    <strong>联系电话：</strong>${client.phone}<br>
                                    <strong>婚礼日期：</strong>${client.weddingDate}<br>
                                </div>
                                <div>
                                    <strong>活动时间：</strong>${getEventTimeText(client.timeSlot)}<br>
                                    <strong>婚礼场地：</strong>${client.venue || '未指定'}<br>
                                    <strong>仪式时间：</strong>${client.ceremonyTime || '未指定'}<br>
                                    <strong>宴会时间：</strong>${client.receptionTime || '未指定'}<br>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-section" style="margin-bottom: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h5 style="margin-bottom: 15px;"><i class="fas fa-file-invoice-dollar"></i> 费用信息</h5>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <strong>总费用：</strong>¥${client.fee || 0}<br>
                                    <strong>已收费用：</strong>¥${client.paidAmount || 0}<br>
                                    <strong>支付状态：</strong>${getPaymentStatusText(client.paymentStatus)}<br>
                                </div>
                                <div>
                                    <strong>合同状态：</strong>${getContractStatusText(client.contractStatus)}<br>
                                    <strong>特别要求/备注：</strong>${client.notes || '无'}<br>
                                </div>
                            </div>
                        </div>
                `;
                
                // 添加问卷信息
                if (questionnaire) {
                    const template = AppState.templates.find(t => t.id === questionnaire.templateId);
                    if (template) {
                        html += `
                            <div class="summary-section" style="margin-bottom: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                <h5 style="margin-bottom: 15px;"><i class="fas fa-clipboard-list"></i> 问卷内容</h5>
                                <h6 style="margin-bottom: 10px; color: var(--secondary);">模板：${template.name}</h6>
                        `;
                        
                        if (questionnaire.answers) {
                            html += `<div style="margin-bottom: 10px;"><strong>问卷填写状态：</strong>已填写</div>`;
                            html += `<div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px;">`;
                            
                            template.questions.forEach(question => {
                                const answer = questionnaire.answers[question.id] || '未回答';
                                html += `
                                    <div style="margin-bottom: 15px;">
                                        <strong>${question.question}</strong><br>
                                        <div style="margin-top: 5px; padding-left: 15px; border-left: 3px solid var(--primary);">
                                            ${answer}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += `</div>`;
                        } else {
                            html += `<div style="color: #6c757d;">问卷尚未填写</div>`;
                        }
                        
                        html += `</div>`;
                    }
                } else {
                    html += `
                        <div class="summary-section" style="margin-bottom: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h5 style="margin-bottom: 15px;"><i class="fas fa-clipboard-list"></i> 问卷内容</h5>
                            <div style="color: #6c757d;">尚未创建问卷</div>
                        </div>
                    `;
                }
                
                // 添加环节规划
                if (clientEvents && clientEvents.length > 0) {
                    html += `
                        <div class="summary-section" style="margin-bottom: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h5 style="margin-bottom: 15px;"><i class="fas fa-calendar-check"></i> 环节规划</h5>
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px;">
                    `;
                    
                    clientEvents.forEach(event => {
                        html += `
                            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6;">
                                <h6>${event.title}</h6>
                                <p style="margin: 5px 0;">日期：${event.date} | 时间：${event.startTime} - ${event.endTime}</p>
                                <p style="margin: 5px 0;">地点：${event.location || '未指定'}</p>
                                <p style="margin: 5px 0;">类型：${event.type}</p>
                                ${event.notes ? `<p style="margin: 5px 0;">备注：${event.notes}</p>` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                } else {
                    html += `
                        <div class="summary-section" style="margin-bottom: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h5 style="margin-bottom: 15px;"><i class="fas fa-calendar-check"></i> 环节规划</h5>
                            <div style="color: #6c757d;">尚未创建环节规划</div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                // 设置内容
                document.getElementById('clientSummaryContent').innerHTML = html;
                
                // 打开模态框
                clientSummaryModal.classList.add('active');
            }
            
            // 关闭客户综合信息模态框
            function closeClientSummaryModal() {
                clientSummaryModal.classList.remove('active');
            }
            
            // 为查看综合信息按钮添加事件监听器
            if (viewSummaryBtn) {
                viewSummaryBtn.addEventListener('click', showClientSummary);
            }
            
            // 为关闭按钮添加事件监听器
            if (closeClientSummaryBtn) {
                closeClientSummaryBtn.addEventListener('click', closeClientSummaryModal);
            }
            
            if (closeClientSummaryXBtn) {
                closeClientSummaryXBtn.addEventListener('click', closeClientSummaryModal);
            }
        }
        
        // 辅助函数：获取事件时间文本
        function getEventTimeText(timeSlot) {
            const timeSlotMap = {
                morning: '上午',
                noon: '中午',
                afternoon: '下午',
                evening: '晚上'
            };
            return timeSlotMap[timeSlot] || '未指定';
        }
        
        // 辅助函数：获取支付状态文本
        function getPaymentStatusText(paymentStatus) {
            const statusMap = {
                unpaid: '未支付',
                deposit: '定金已付',
                partial: '部分支付',
                paid: '已结清'
            };
            return statusMap[paymentStatus] || '未指定';
        }
        
        // 辅助函数：获取合同状态文本
        function getContractStatusText(contractStatus) {
            const statusMap = {
                pending: '待签约',
                signed: '已签约',
                deposit: '已付定金',
                paid: '已付全款'
            };
            return statusMap[contractStatus] || '未指定';
        }
        
        // 渲染客户列表
        function renderClientsList() {
            const clientsList = document.getElementById('clientsList');
            
            if (AppState.clients.length === 0) {
                clientsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <h3>暂无客户信息</h3>
                        <p>点击上方"添加客户"按钮开始记录</p>
                    </div>
                `;
                return;
            }
            
            // 按婚礼日期排序
            const sortedClients = [...AppState.clients].sort((a, b) => {
                return new Date(a.weddingDate) - new Date(b.weddingDate);
            });
            
            let html = '<ul class="data-list">';
            
            sortedClients.forEach(client => {
                // 格式化日期
                const weddingDate = new Date(client.weddingDate);
                const formattedDate = `${weddingDate.getMonth() + 1}月${weddingDate.getDate()}日`;
                
                // 活动时间文本
                const timeSlotMap = {
                    morning: '上午',
                    noon: '中午',
                    afternoon: '下午',
                    evening: '晚上'
                };
                const timeSlotText = client.timeSlot ? timeSlotMap[client.timeSlot] || '未指定' : '未指定';
                
                // 费用信息
                let feeInfo = '';
                if (client.fee && client.fee > 0) {
                    let paymentStatusText = '';
                    let paymentStatusClass = '';
                    
                    switch(client.paymentStatus) {
                        case 'unpaid':
                            paymentStatusText = '未支付';
                            paymentStatusClass = 'fee-unpaid';
                            break;
                        case 'deposit':
                            paymentStatusText = '定金已付';
                            paymentStatusClass = 'fee-deposit';
                            break;
                        case 'partial':
                            paymentStatusText = '部分支付';
                            paymentStatusClass = 'fee-deposit';
                            break;
                        case 'paid':
                            paymentStatusText = '已结清';
                            paymentStatusClass = 'fee-paid';
                            break;
                    }
                    
                    feeInfo = `<div style="margin-top: 5px;"><span class="fee-status ${paymentStatusClass}">${paymentStatusText} ¥${client.fee}</span></div>`;
                }
                
                // 合同状态标签
                let contractBadge = '';
                if (client.contractStatus === 'paid') {
                    contractBadge = '<span class="badge badge-success">已付款</span>';
                } else if (client.contractStatus === 'deposit') {
                    contractBadge = '<span class="badge badge-warning">已付定金</span>';
                } else if (client.contractStatus === 'signed') {
                    contractBadge = '<span class="badge badge-primary">已签约</span>';
                } else {
                    contractBadge = '<span class="badge">待签约</span>';
                }
                
                // 问卷状态
                let questionnaireBadge = '';
                if (client.questionnaireId) {
                    const questionnaire = AppState.questionnaires.find(q => q.id === client.questionnaireId);
                    if (questionnaire) {
                        questionnaireBadge = `<span class="badge badge-info" style="margin-left: 5px;">已有问卷</span>`;
                    }
                }
                
                html += `
                    <li class="data-item" onclick="editClient('${client.id}')" style="cursor: pointer;">
                        <div class="item-info">
                            <h4>${client.groomName} & ${client.brideName}</h4>
                            <p>婚礼日期: ${formattedDate} ${timeSlotText} | 场地: ${client.venue || '未定'} | 电话: ${client.phone}</p>
                            ${feeInfo}
                            ${contractBadge}
                            ${questionnaireBadge}
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); editClient('${client.id}')">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); viewClientEvents('${client.id}')">
                                <i class="fas fa-calendar"></i> 档期
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); deleteClient('${client.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            clientsList.innerHTML = html;
        }
        
        // 编辑客户（全局函数，供按钮调用）
        window.editClient = function(clientId) {
            openClientModal(clientId);
        };
        
        // 查看客户事件（全局函数，供按钮调用）
        window.viewClientEvents = function(clientId) {
            // 切换到日历标签
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelector('.nav-item[data-tab="calendar"]').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('calendar-tab').classList.add('active');
            
            // 可以在这里添加高亮显示该客户事件的功能
            alert('已切换到档期管理页面，您可以在日历中查看该客户的档期安排');
        };
        
        // 删除客户（全局函数，供按钮调用）
        window.deleteClient = function(clientId) {
            if (confirm('确定要删除这个客户吗？相关档期信息和问卷也会被删除。')) {
                // 删除客户
                AppState.clients = AppState.clients.filter(client => client.id !== clientId);
                
                // 删除相关事件
                AppState.events = AppState.events.filter(event => {
                    // 这里假设事件通过clientId关联客户
                    // 在实际应用中，您需要确保事件数据结构包含clientId字段
                    return true; // 暂时保留所有事件
                });
                
                // 删除相关问卷
                AppState.questionnaires = AppState.questionnaires.filter(q => q.clientId !== clientId);
                
                // 保存数据
                saveData();
                
                // 刷新客户列表
                renderClientsList();
                
                // 刷新日历
                renderCalendar();
            }
        };
        
        // 优化：客户搜索功能 - 修复搜索框显示所有客户
        function setupClientSearch() {
            // 问卷页面的客户搜索
            const clientSearchInput = document.getElementById('clientSearchInput');
            const clientSearchResults = document.getElementById('clientSearchResults');
            
            if (clientSearchInput) {
                // 当搜索框获得焦点时显示所有客户
                clientSearchInput.addEventListener('focus', function() {
                    showAllClientsInSearchResults(clientSearchResults, 'questionnaire');
                });
                
                clientSearchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    if (searchTerm === '') {
                        showAllClientsInSearchResults(clientSearchResults, 'questionnaire');
                        return;
                    }
                    
                    // 搜索客户
                    const results = AppState.clients.filter(client => {
                        const groomName = client.groomName.toLowerCase();
                        const brideName = client.brideName.toLowerCase();
                        const phone = client.phone.toLowerCase();
                        const weddingDate = client.weddingDate;
                        
                        return groomName.includes(searchTerm) || 
                               brideName.includes(searchTerm) || 
                               phone.includes(searchTerm) ||
                               weddingDate.includes(searchTerm);
                    });
                    
                    if (results.length === 0) {
                        clientSearchResults.innerHTML = '<div class="client-search-result-item">未找到匹配的客户</div>';
                        clientSearchResults.style.display = 'block';
                        return;
                    }
                    
                    renderClientSearchResults(results, clientSearchResults, 'questionnaire');
                });
                
                // 点击页面其他区域关闭搜索结果
                document.addEventListener('click', function(e) {
                    if (!clientSearchInput.contains(e.target) && !clientSearchResults.contains(e.target)) {
                        clientSearchResults.style.display = 'none';
                    }
                });
            }
            
            // 新建问卷页面的客户搜索
            const questionnaireClientSearch = document.getElementById('questionnaireClientSearch');
            const questionnaireClientSearchResults = document.getElementById('questionnaireClientSearchResults');
            
            if (questionnaireClientSearch) {
                // 当搜索框获得焦点时显示所有客户
                questionnaireClientSearch.addEventListener('focus', function() {
                    showAllClientsInSearchResults(questionnaireClientSearchResults, 'newQuestionnaire');
                });
                
                questionnaireClientSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    if (searchTerm === '') {
                        showAllClientsInSearchResults(questionnaireClientSearchResults, 'newQuestionnaire');
                        return;
                    }
                    
                    // 搜索客户
                    const results = AppState.clients.filter(client => {
                        const groomName = client.groomName.toLowerCase();
                        const brideName = client.brideName.toLowerCase();
                        const phone = client.phone.toLowerCase();
                        const weddingDate = client.weddingDate;
                        
                        return groomName.includes(searchTerm) || 
                               brideName.includes(searchTerm) || 
                               phone.includes(searchTerm) ||
                               weddingDate.includes(searchTerm);
                    });
                    
                    if (results.length === 0) {
                        questionnaireClientSearchResults.innerHTML = '<div class="client-search-result-item">未找到匹配的客户</div>';
                        questionnaireClientSearchResults.style.display = 'block';
                        return;
                    }
                    
                    renderClientSearchResults(results, questionnaireClientSearchResults, 'newQuestionnaire');
                });
                
                // 点击页面其他区域关闭搜索结果
                document.addEventListener('click', function(e) {
                    if (!questionnaireClientSearch.contains(e.target) && !questionnaireClientSearchResults.contains(e.target)) {
                        questionnaireClientSearchResults.style.display = 'none';
                    }
                });
            }
            
            // 环节规划页面的客户搜索
            const planClientSearchInput = document.getElementById('planClientSearchInput');
            const planClientSearchResults = document.getElementById('planClientSearchResults');
            
            if (planClientSearchInput) {
                // 当搜索框获得焦点时显示所有客户
                planClientSearchInput.addEventListener('focus', function() {
                    showAllClientsInSearchResults(planClientSearchResults, 'planning');
                });
                
                planClientSearchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    if (searchTerm === '') {
                        showAllClientsInSearchResults(planClientSearchResults, 'planning');
                        return;
                    }
                    
                    // 搜索客户
                    const results = AppState.clients.filter(client => {
                        const groomName = client.groomName.toLowerCase();
                        const brideName = client.brideName.toLowerCase();
                        const phone = client.phone.toLowerCase();
                        const weddingDate = client.weddingDate;
                        
                        return groomName.includes(searchTerm) || 
                               brideName.includes(searchTerm) || 
                               phone.includes(searchTerm) ||
                               weddingDate.includes(searchTerm);
                    });
                    
                    if (results.length === 0) {
                        planClientSearchResults.innerHTML = '<div class="client-search-result-item">未找到匹配的客户</div>';
                        planClientSearchResults.style.display = 'block';
                        return;
                    }
                    
                    renderClientSearchResults(results, planClientSearchResults, 'planning');
                });
                
                // 点击页面其他区域关闭搜索结果
                document.addEventListener('click', function(e) {
                    if (!planClientSearchInput.contains(e.target) && !planClientSearchResults.contains(e.target)) {
                        planClientSearchResults.style.display = 'none';
                    }
                });
            }
        }
        
        // 显示所有客户在搜索结果中
        function showAllClientsInSearchResults(resultsContainer, context) {
            if (AppState.clients.length === 0) {
                resultsContainer.innerHTML = '<div class="client-search-result-item">暂无客户信息</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            // 按婚礼日期排序
            const sortedClients = [...AppState.clients].sort((a, b) => {
                return new Date(a.weddingDate) - new Date(b.weddingDate);
            });
            
            renderClientSearchResults(sortedClients, resultsContainer, context);
        }
        
        // 渲染客户搜索结果
        function renderClientSearchResults(clients, resultsContainer, context) {
            let html = '';
            
            clients.forEach(client => {
                const weddingDate = new Date(client.weddingDate);
                const formattedDate = `${weddingDate.getFullYear()}年${weddingDate.getMonth() + 1}月${weddingDate.getDate()}日`;
                
                // 问卷状态
                let questionnaireStatus = '';
                if (client.questionnaireId) {
                    questionnaireStatus = '<span style="color: var(--info); font-size: 0.8rem;">(已有问卷)</span>';
                }
                
                html += `
                    <div class="client-search-result-item" data-client-id="${client.id}" data-context="${context}">
                        <div style="font-weight: 500;">${client.groomName} & ${client.brideName} ${questionnaireStatus}</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">${formattedDate} | ${client.venue || '场地未定'}</div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
            
            // 添加点击事件
            document.querySelectorAll(`#${resultsContainer.id} .client-search-result-item`).forEach(item => {
                item.addEventListener('click', function() {
                    const clientId = this.getAttribute('data-client-id');
                    const context = this.getAttribute('data-context');
                    const client = AppState.clients.find(c => c.id === clientId);
                    
                    if (client) {
                        // 根据上下文处理选择
                        if (context === 'questionnaire') {
                            document.getElementById('clientSearchInput').value = `${client.groomName} & ${client.brideName} (${client.weddingDate})`;
                            AppState.selectedClientForQuestionnaire = client;
                            
                            // 隐藏搜索结果
                            resultsContainer.style.display = 'none';
                            
                            // 如果客户已有问卷，提示是否加载
                            if (client.questionnaireId) {
                                const questionnaire = AppState.questionnaires.find(q => q.id === client.questionnaireId);
                                if (questionnaire) {
                                    if (confirm('该客户已有问卷，是否加载？')) {
                                        loadQuestionnaire(questionnaire.id);
                                    }
                                }
                            }
                        } else if (context === 'newQuestionnaire') {
                            document.getElementById('questionnaireClientSearch').value = `${client.groomName} & ${client.brideName}`;
                            // 设置隐藏的客户端ID
                            if (!document.getElementById('questionnaireClient')) {
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.id = 'questionnaireClient';
                                hiddenInput.name = 'questionnaireClient';
                                document.querySelector('#newQuestionnaireContent .card').appendChild(hiddenInput);
                            }
                            document.getElementById('questionnaireClient').value = clientId;
                            resultsContainer.style.display = 'none';
                        } else if (context === 'planning') {
                            document.getElementById('planClientSearchInput').value = `${client.groomName} & ${client.brideName}`;
                            resultsContainer.style.display = 'none';
                            
                            // 加载该客户的环节规划
                            loadClientPlanning(clientId);
                        }
                    }
                });
            });
        }
        
        // 问卷模板管理
        function renderQuestionnaireTemplates() {
            const templatesContainer = document.getElementById('questionnaireTemplates');
            if (!templatesContainer) {
                console.error('questionnaireTemplates元素不存在');
                return;
            }
            
            let html = '';
            
            // 确保templates存在且是数组
            if (!Array.isArray(AppState.templates)) {
                AppState.templates = [];
            }
            
            // 如果没有模板，初始化默认模板
            if (AppState.templates.length === 0) {
                // 初始化示例问卷模板
                AppState.templates = [
                    {
                        id: '1',
                        name: '标准婚礼问卷',
                        description: '适用于大多数传统婚礼的标准问卷',
                        tags: ['标准', '传统', '通用'],
                        questions: [
                            { id: 'q1', question: '新人爱情故事', type: 'textarea' },
                            { id: 'q2', question: '婚礼主题/风格', type: 'text' },
                            { id: 'q3', question: '婚礼色调', type: 'text' },
                            { id: 'q4', question: '特殊环节要求', type: 'textarea' },
                            { id: 'q5', question: '禁忌与注意事项', type: 'textarea' }
                        ],
                        isDefault: true
                    },
                    {
                        id: '2',
                        name: '西式教堂婚礼问卷',
                        description: '专门针对教堂婚礼的特殊问卷',
                        tags: ['教堂', '西式', '宗教'],
                        questions: [
                            { id: 'q1', question: '新人宗教背景', type: 'text' },
                            { id: 'q2', question: '教堂仪式要求', type: 'textarea' },
                            { id: 'q3', question: '宗教音乐偏好', type: 'text' },
                            { id: 'q4', question: '神父/牧师要求', type: 'text' },
                            { id: 'q5', question: '宗教禁忌', type: 'textarea' }
                        ],
                        isDefault: true
                    },
                    {
                        id: '3',
                        name: '户外婚礼问卷',
                        description: '适合户外草坪、海滩等婚礼场地',
                        tags: ['户外', '草坪', '海滩'],
                        questions: [
                            { id: 'q1', question: '户外场地类型', type: 'text' },
                            { id: 'q2', question: '天气预案要求', type: 'textarea' },
                            { id: 'q3', question: '户外装饰风格', type: 'text' },
                            { id: 'q4', question: '音响设备要求', type: 'textarea' },
                            { id: 'q5', question: '宾客座椅安排', type: 'textarea' }
                        ],
                        isDefault: true
                    }
                ];
                // 保存初始化的模板
                saveData();
            }
            
            AppState.templates.forEach(template => {
                const tagsHtml = template.tags.map(tag => 
                    `<span class="template-tag">${tag}</span>`
                ).join('');
                
                html += `
                    <div class="template-card" data-template-id="${template.id}">
                        <div class="template-name">${template.name}</div>
                        <div class="template-desc">${template.description}</div>
                        <div class="template-tags">${tagsHtml}</div>
                    </div>
                `;
            });
            
            templatesContainer.innerHTML = html;
            
            // 添加模板选择事件
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', function() {
                    const templateId = this.getAttribute('data-template-id');
                    
                    // 检查是否已选择客户
                    if (!AppState.selectedClientForQuestionnaire) {
                        alert('请先选择客户');
                        return;
                    }
                    
                    // 创建问卷
                    createQuestionnaireFromTemplate(templateId, AppState.selectedClientForQuestionnaire.id);
                    
                    // 高亮选中的模板
                    document.querySelectorAll('.template-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }
        
        // 从模板创建问卷
        function createQuestionnaireFromTemplate(templateId, clientId) {
            const template = AppState.templates.find(t => t.id === templateId);
            if (!template) {
                console.error('找不到指定的模板');
                return;
            }
            
            const client = AppState.clients.find(c => c.id === clientId);
            if (!client) {
                console.error('找不到指定的客户');
                return;
            }
            
            // 创建问卷
            const questionnaireId = generateId();
            const questionnaire = {
                id: questionnaireId,
                templateId: templateId,
                clientId: clientId,
                title: `${client.groomName} & ${client.brideName}的婚礼问卷`,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                answers: {},
                completed: false
            };
            
            // 检查是否已有问卷
            const existingQuestionnaire = AppState.questionnaires.find(q => q.clientId === clientId);
            if (existingQuestionnaire) {
                if (confirm('该客户已有问卷，是否覆盖？')) {
                    // 删除旧的问卷
                    AppState.questionnaires = AppState.questionnaires.filter(q => q.id !== existingQuestionnaire.id);
                    AppState.questionnaires.push(questionnaire);
                } else {
                    return;
                }
            } else {
                AppState.questionnaires.push(questionnaire);
            }
            
            // 更新客户的问卷ID
            client.questionnaireId = questionnaireId;
            
            // 保存数据
            saveData();
            
            // 加载问卷
            loadQuestionnaire(questionnaireId);
            
            // 显示分享链接区域
            const shareSection = document.getElementById('questionnaireShareSection');
            if (shareSection) {
                shareSection.style.display = 'block';
            }
            
            // 更新问卷操作按钮状态
            updateQuestionnaireActionButtons();
        }
        
        // 加载问卷
        function loadQuestionnaire(questionnaireId) {
            const questionnaire = AppState.questionnaires.find(q => q.id === questionnaireId);
            if (!questionnaire) return;
            
            const template = AppState.templates.find(t => t.id === questionnaire.templateId);
            if (!template) return;
            
            const client = AppState.clients.find(c => c.id === questionnaire.clientId);
            if (!client) return;
            
            AppState.currentQuestionnaire = questionnaire;
            
            const templateSelectionCard = document.getElementById('templateSelectionCard');
            const questionnaireContent = document.getElementById('questionnaireContent');
            const newQuestionnaireContent = document.getElementById('newQuestionnaireContent');
            
            // 隐藏模板选择，显示问卷内容
            templateSelectionCard.style.display = 'none';
            newQuestionnaireContent.style.display = 'none';
            questionnaireContent.style.display = 'block';
            
            // 生成问卷表单
            let formHtml = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">${client.groomName} & ${client.brideName} 的婚礼问卷</h3>
                        <button class="btn btn-small btn-secondary" id="backToTemplatesFromViewBtn">
                            <i class="fas fa-arrow-left"></i> 返回
                        </button>
                    </div>
                    <p>基于"${template.name}"模板创建</p>
                    
                    <form id="questionnaireForm">
            `;
            
            template.questions.forEach((question, index) => {
                const answer = questionnaire.answers[question.id] || '';
                
                if (question.type === 'textarea') {
                    formHtml += `
                        <div class="form-group">
                            <label class="form-label">${question.question}</label>
                            <textarea class="form-control" name="${question.id}" rows="4" placeholder="请填写...">${answer}</textarea>
                        </div>
                    `;
                } else if (question.type === 'select' || question.type === 'checkbox') {
                    let optionsHtml = '';
                    if (question.options && question.options.length > 0) {
                        if (question.type === 'select') {
                            optionsHtml = `<select class="form-control" name="${question.id}">`;
                            question.options.forEach(option => {
                                const selected = answer === option ? 'selected' : '';
                                optionsHtml += `<option value="${option}" ${selected}>${option}</option>`;
                            });
                            optionsHtml += `</select>`;
                        } else {
                            optionsHtml = '<div>';
                            const answers = answer ? answer.split(',') : [];
                            question.options.forEach(option => {
                                const checked = answers.includes(option) ? 'checked' : '';
                                optionsHtml += `
                                    <div>
                                        <input type="checkbox" name="${question.id}" value="${option}" id="${question.id}-${option}" ${checked}>
                                        <label for="${question.id}-${option}">${option}</label>
                                    </div>
                                `;
                            });
                            optionsHtml += '</div>';
                        }
                    } else {
                        optionsHtml = `<input type="text" class="form-control" name="${question.id}" placeholder="请填写..." value="${answer}">`;
                    }
                    
                    formHtml += `
                        <div class="form-group">
                            <label class="form-label">${question.question}</label>
                            ${optionsHtml}
                        </div>
                    `;
                } else {
                    formHtml += `
                        <div class="form-group">
                            <label class="form-label">${question.question}</label>
                            <input type="${question.type}" class="form-control" name="${question.id}" placeholder="请填写..." value="${answer}">
                        </div>
                    `;
                }
            });
            
            formHtml += `
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="saveQuestionnaireBtn">保存问卷</button>
                            <button type="button" class="btn btn-secondary" id="exportQuestionnaireBtn">
                                <i class="fas fa-file-export"></i> 导出答案
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelQuestionnaireBtn">返回</button>
                        </div>
                    </form>
                </div>
            `;
            
            questionnaireContent.innerHTML = formHtml;
            
            // 添加返回按钮事件
            document.getElementById('backToTemplatesFromViewBtn').addEventListener('click', function() {
                templateSelectionCard.style.display = 'block';
                questionnaireContent.style.display = 'none';
                document.getElementById('questionnaireShareSection').style.display = 'none';
                
                // 清除模板选中状态
                document.querySelectorAll('.template-card').forEach(c => {
                    c.classList.remove('active');
                });
                
                // 清除客户选择
                document.getElementById('clientSearchInput').value = '';
                AppState.selectedClientForQuestionnaire = null;
                AppState.currentQuestionnaire = null;
                
                // 更新问卷操作按钮状态
                updateQuestionnaireActionButtons();
            });
            
            // 添加取消按钮事件
            document.getElementById('cancelQuestionnaireBtn').addEventListener('click', function() {
                templateSelectionCard.style.display = 'block';
                questionnaireContent.style.display = 'none';
                document.getElementById('questionnaireShareSection').style.display = 'none';
                
                // 清除模板选中状态
                document.querySelectorAll('.template-card').forEach(c => {
                    c.classList.remove('active');
                });
                
                // 清除客户选择
                document.getElementById('clientSearchInput').value = '';
                AppState.selectedClientForQuestionnaire = null;
                AppState.currentQuestionnaire = null;
                
                // 更新问卷操作按钮状态
                updateQuestionnaireActionButtons();
            });
            
            // 添加保存按钮事件
            document.getElementById('saveQuestionnaireBtn').addEventListener('click', function() {
                saveQuestionnaireAnswers(questionnaireId);
            });
            
            // 添加导出按钮事件
            document.getElementById('exportQuestionnaireBtn').addEventListener('click', function() {
                exportQuestionnaire(questionnaireId);
            });
            
            // 显示分享链接区域
            document.getElementById('questionnaireShareSection').style.display = 'block';
            
            // 更新问卷操作按钮状态
            updateQuestionnaireActionButtons();
        }
        
        // 保存问卷答案
        function saveQuestionnaireAnswers(questionnaireId) {
            const questionnaire = AppState.questionnaires.find(q => q.id === questionnaireId);
            if (!questionnaire) return;
            
            const template = AppState.templates.find(t => t.id === questionnaire.templateId);
            if (!template) return;
            
            // 收集答案
            const answers = {};
            let allAnswered = true;
            
            template.questions.forEach(question => {
                const input = document.querySelector(`[name="${question.id}"]`);
                if (!input) return;
                
                let value = '';
                if (question.type === 'checkbox') {
                    const checkboxes = document.querySelectorAll(`[name="${question.id}"]:checked`);
                    value = Array.from(checkboxes).map(cb => cb.value).join(',');
                } else {
                    value = input.value;
                }
                
                answers[question.id] = value;
                
                // 检查是否所有必填问题都已填写
                if (!value.trim() && question.required) {
                    allAnswered = false;
                }
            });
            
            // 更新问卷
            questionnaire.answers = answers;
            questionnaire.updatedAt = new Date().toISOString();
            questionnaire.completed = allAnswered;
            
            // 保存数据
            saveData();
            
            alert('问卷已保存！');
        }
        
        // 导出问卷答案
        function exportQuestionnaire(questionnaireId) {
            const questionnaire = AppState.questionnaires.find(q => q.id === questionnaireId);
            if (!questionnaire) return;
            
            const client = AppState.clients.find(c => c.id === questionnaire.clientId);
            if (!client) return;
            
            const exportData = {
                questionnaireId: questionnaire.id,
                clientId: questionnaire.clientId,
                clientName: `${client.groomName} & ${client.brideName}`,
                weddingDate: client.weddingDate,
                answers: questionnaire.answers,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `问卷答案_${client.groomName}&${client.brideName}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('问卷答案已导出为JSON文件，可分享给客户填写！');
        }
        
        // 导入问卷答案
        function setupQuestionnaireImport() {
            // 全局导入问卷按钮
            document.getElementById('importQuestionnaireBtnGlobal').addEventListener('click', function() {
                openImportQuestionnaireModal();
            });
            
            // 生成分享链接按钮
            const generateShareLinkBtn = document.getElementById('generateShareLinkBtn');
            if (generateShareLinkBtn) {
                generateShareLinkBtn.addEventListener('click', function() {
                    generateShareLink();
                });
            }
            
            // 复制分享链接按钮
            const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
            if (copyShareLinkBtn) {
                copyShareLinkBtn.addEventListener('click', function() {
                    const shareLinkInput = document.getElementById('shareLinkInput');
                    if (shareLinkInput.value) {
                        shareLinkInput.select();
                        document.execCommand('copy');
                        alert('链接已复制到剪贴板！');
                    } else {
                        alert('请先生成分享链接');
                    }
                });
            }
        }
        
        // 生成分享链接
        function generateShareLink() {
            try {
                if (!AppState.currentQuestionnaire) {
                    alert('请先创建或加载问卷');
                    return;
                }
                
                const questionnaire = AppState.currentQuestionnaire;
                const client = AppState.clients.find(c => c.id === questionnaire.clientId);
                
                if (!client) {
                    alert('未找到关联客户信息，请先选择客户');
                    return;
                }
                
                // 生成一个简单的分享链接（实际应用中可能需要服务器支持）
                const shareData = {
                    questionnaireId: questionnaire.id,
                    clientId: questionnaire.clientId,
                    clientName: `${client.groomName} & ${client.brideName}`,
                    templateId: questionnaire.templateId
                };
                
                const encodedData = btoa(JSON.stringify(shareData));
                const shareLink = `${window.location.origin}${window.location.pathname}#questionnaire=${encodedData}`;
                
                const shareLinkInput = document.getElementById('shareLinkInput');
                if (shareLinkInput) {
                    shareLinkInput.value = shareLink;
                    alert('分享链接已生成！复制链接发送给客户，客户可以通过此链接填写问卷。');
                } else {
                    alert('生成链接失败：分享链接输入框未找到');
                }
            } catch (error) {
                console.error('生成分享链接失败:', error);
                alert('生成分享链接失败，请重试');
            }
        }
        
        // 打开导入问卷答案模态框
        function openImportQuestionnaireModal() {
            const modal = document.getElementById('importQuestionnaireModal');
            modal.classList.add('active');
        }
        
        // 设置导入问卷答案模态框
        function setupImportQuestionnaireModal() {
            const modal = document.getElementById('importQuestionnaireModal');
            const closeBtn = document.getElementById('closeImportQuestionnaireModal');
            const cancelBtn = document.getElementById('cancelImportQuestionnaireBtn');
            const confirmBtn = document.getElementById('confirmImportQuestionnaireBtn');
            const fileInput = document.getElementById('questionnaireFileInput');
            const preview = document.getElementById('importPreview');
            const previewContent = document.getElementById('importPreviewContent');
            
            let importData = null;
            
            // 关闭模态框
            function closeModal() {
                modal.classList.remove('active');
                fileInput.value = '';
                preview.style.display = 'none';
                importData = null;
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 文件选择
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        importData = JSON.parse(event.target.result);
                        
                        // 验证数据格式
                        if (!importData.questionnaireId || !importData.answers) {
                            throw new Error('数据格式不正确');
                        }
                        
                        // 显示预览
                        let previewHtml = '<ul>';
                        for (const [questionId, answer] of Object.entries(importData.answers)) {
                            previewHtml += `<li><strong>问题${questionId}:</strong> ${answer}</li>`;
                        }
                        previewHtml += '</ul>';
                        
                        previewContent.innerHTML = previewHtml;
                        preview.style.display = 'block';
                    } catch (error) {
                        alert('导入失败：数据文件格式不正确或已损坏');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
            });
            
            // 确认导入
            confirmBtn.addEventListener('click', function() {
                if (!importData) {
                    alert('请先选择要导入的文件');
                    return;
                }
                
                // 查找对应的问卷
                const questionnaire = AppState.questionnaires.find(q => q.id === importData.questionnaireId);
                if (!questionnaire) {
                    alert('未找到对应的问卷，请先创建问卷');
                    closeModal();
                    return;
                }
                
                // 更新答案
                questionnaire.answers = importData.answers;
                questionnaire.updatedAt = new Date().toISOString();
                questionnaire.completed = true;
                
                // 保存数据
                saveData();
                
                alert('问卷答案已成功导入！');
                
                // 重新加载问卷
                if (AppState.currentQuestionnaire && AppState.currentQuestionnaire.id === questionnaire.id) {
                    loadQuestionnaire(questionnaire.id);
                }
                
                closeModal();
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 更新问卷操作按钮状态
        function updateQuestionnaireActionButtons() {
            const editBtn = document.getElementById('editQuestionnaireBtn');
            const deleteBtn = document.getElementById('deleteQuestionnaireBtn');
            const shareBtn = document.getElementById('shareQuestionnaireBtn');
            
            if (AppState.currentQuestionnaire) {
                // 有当前问卷，显示操作按钮
                editBtn.style.display = 'inline-flex';
                deleteBtn.style.display = 'inline-flex';
                shareBtn.style.display = 'inline-flex';
                
                // 设置按钮事件
                editBtn.onclick = function() {
                    if (AppState.currentQuestionnaire) {
                        // 编辑问卷逻辑
                        alert('编辑问卷功能开发中...');
                    }
                };
                
                deleteBtn.onclick = function() {
                    if (AppState.currentQuestionnaire && confirm('确定要删除这个问卷吗？')) {
                        deleteQuestionnaire(AppState.currentQuestionnaire.id);
                    }
                };
                
                shareBtn.onclick = function() {
                    if (AppState.currentQuestionnaire) {
                        generateShareLink();
                    }
                };
            } else {
                // 没有当前问卷，隐藏操作按钮
                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                shareBtn.style.display = 'none';
            }
        }
        
        // 删除问卷
        function deleteQuestionnaire(questionnaireId) {
            const questionnaire = AppState.questionnaires.find(q => q.id === questionnaireId);
            if (!questionnaire) return;
            
            // 删除问卷
            AppState.questionnaires = AppState.questionnaires.filter(q => q.id !== questionnaireId);
            
            // 更新客户的问卷ID
            const client = AppState.clients.find(c => c.id === questionnaire.clientId);
            if (client) {
                client.questionnaireId = null;
            }
            
            // 保存数据
            saveData();
            
            // 返回模板选择界面
            document.getElementById('templateSelectionCard').style.display = 'block';
            document.getElementById('questionnaireContent').style.display = 'none';
            document.getElementById('questionnaireShareSection').style.display = 'none';
            
            // 清除客户选择
            document.getElementById('clientSearchInput').value = '';
            AppState.selectedClientForQuestionnaire = null;
            AppState.currentQuestionnaire = null;
            
            // 更新问卷操作按钮状态
            updateQuestionnaireActionButtons();
            
            alert('问卷已删除！');
        }
        
        // 渲染模板列表
        function renderTemplatesList() {
            const templatesList = document.getElementById('templatesList');
            if (!templatesList) return;
            
            let html = '';
            
            // 确保templates存在且是数组
            if (!Array.isArray(AppState.templates)) {
                AppState.templates = [];
            }
            
            if (AppState.templates.length === 0) {
                html = '<div class="empty-state">暂无模板，请点击"新建模板"创建</div>';
            } else {
                AppState.templates.forEach(template => {
                    const tagsHtml = template.tags.map(tag => 
                        `<span class="template-tag">${tag}</span>`
                    ).join('');
                    
                    html += `
                        <div class="template-item" data-template-id="${template.id}">
                            <div class="template-item-header">
                                <h5>${template.name}</h5>
                                <div class="template-item-actions">
                                    <button class="btn btn-small btn-primary" onclick="editTemplate('${template.id}')">编辑</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteTemplate('${template.id}')">删除</button>
                                </div>
                            </div>
                            <div class="template-item-description">${template.description}</div>
                            <div class="template-item-tags">${tagsHtml}</div>
                            <div class="template-item-meta">
                                问题数量: ${template.questions.length}个
                            </div>
                        </div>
                    `;
                });
            }
            
            templatesList.innerHTML = html;
        }
        
        // 编辑模板
        function editTemplate(templateId) {
            const template = AppState.templates.find(t => t.id === templateId);
            if (!template) return;
            
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateDescription').value = template.description;
            document.getElementById('templateTags').value = template.tags.join(',');
            document.getElementById('templateId').value = template.id;
            
            // 渲染问题
            renderTemplateQuestions(template.questions);
            
            // 显示编辑器，隐藏列表
            document.getElementById('templateEditor').style.display = 'block';
            document.getElementById('saveTemplateBtn').style.display = 'inline-block';
        }
        
        // 删除模板
        function deleteTemplate(templateId) {
            if (confirm('确定要删除此模板吗？')) {
                AppState.templates = AppState.templates.filter(t => t.id !== templateId);
                saveData();
                renderTemplatesList();
                renderQuestionnaireTemplates();
            }
        }
        
        // 渲染模板问题
        function renderTemplateQuestions(questions) {
            const container = document.getElementById('customQuestionsContainer');
            if (!container) return;
            
            let html = '';
            questions.forEach((question, index) => {
                html += `
                    <div class="question-item" data-index="${index}">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">问题 ${index + 1}</label>
                                <input type="text" class="form-control question-text" value="${question.question}" placeholder="输入问题">
                            </div>
                            <div class="form-group" style="width: 150px;">
                                <label class="form-label">类型</label>
                                <select class="form-control question-type">
                                    <option value="text" ${question.type === 'text' ? 'selected' : ''}>单行文本</option>
                                    <option value="textarea" ${question.type === 'textarea' ? 'selected' : ''}>多行文本</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button type="button" class="btn btn-danger btn-small remove-question" style="margin-bottom: 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加删除问题事件
            document.querySelectorAll('.remove-question').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.question-item').remove();
                });
            });
        }
        
        // 模板管理功能
        function setupTemplateManagement() {
            const manageTemplatesBtn = document.getElementById('manageTemplatesBtn');
            const templateModal = document.getElementById('templateModal');
            const closeTemplateModal = document.getElementById('closeTemplateModal');
            const cancelTemplateBtn = document.getElementById('cancelTemplateBtn');
            const addTemplateBtn = document.getElementById('addTemplateBtn');
            const saveTemplateBtn = document.getElementById('saveTemplateBtn');
            const addTemplateQuestionBtn = document.getElementById('addTemplateQuestionBtn');
            
            // 打开模板管理模态框
            if (manageTemplatesBtn && templateModal) {
                manageTemplatesBtn.addEventListener('click', function() {
                    templateModal.classList.add('active');
                    // 渲染模板列表
                    renderTemplatesList();
                });
            }
            
            // 关闭模板管理模态框
            function closeTemplateModalFunc() {
                templateModal.classList.remove('active');
                // 重置编辑器
                document.getElementById('templateEditor').style.display = 'none';
                document.getElementById('saveTemplateBtn').style.display = 'none';
            }
            
            // 关闭按钮
            if (closeTemplateModal) {
                closeTemplateModal.addEventListener('click', closeTemplateModalFunc);
            }
            
            // 取消按钮
            if (cancelTemplateBtn) {
                cancelTemplateBtn.addEventListener('click', closeTemplateModalFunc);
            }
            
            // 新建模板
            if (addTemplateBtn) {
                addTemplateBtn.addEventListener('click', function() {
                    // 重置表单
                    document.getElementById('templateName').value = '';
                    document.getElementById('templateDescription').value = '';
                    document.getElementById('templateTags').value = '';
                    document.getElementById('templateId').value = '';
                    document.getElementById('customQuestionsContainer').innerHTML = '';
                    
                    // 显示编辑器
                    document.getElementById('templateEditor').style.display = 'block';
                    document.getElementById('saveTemplateBtn').style.display = 'inline-block';
                });
            }
            
            // 添加问题
            if (addTemplateQuestionBtn) {
                addTemplateQuestionBtn.addEventListener('click', function() {
                    const container = document.getElementById('customQuestionsContainer');
                    if (!container) return;
                    
                    const index = container.querySelectorAll('.question-item').length;
                    const html = `
                        <div class="question-item" data-index="${index}">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">问题 ${index + 1}</label>
                                    <input type="text" class="form-control question-text" placeholder="输入问题">
                                </div>
                                <div class="form-group" style="width: 150px;">
                                    <label class="form-label">类型</label>
                                    <select class="form-control question-type">
                                        <option value="text">单行文本</option>
                                        <option value="textarea">多行文本</option>
                                    </select>
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button type="button" class="btn btn-danger btn-small remove-question" style="margin-bottom: 10px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.insertAdjacentHTML('beforeend', html);
                    
                    // 添加删除事件
                    const newQuestion = container.lastElementChild;
                    newQuestion.querySelector('.remove-question').addEventListener('click', function() {
                        newQuestion.remove();
                    });
                });
            }
            
            // 保存模板
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', function() {
                    const name = document.getElementById('templateName').value.trim();
                    const description = document.getElementById('templateDescription').value.trim();
                    const tagsStr = document.getElementById('templateTags').value.trim();
                    const templateId = document.getElementById('templateId').value.trim();
                    
                    if (!name) {
                        alert('请输入模板名称');
                        return;
                    }
                    
                    // 解析标签
                    const tags = tagsStr ? tagsStr.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                    
                    // 收集问题
                    const questions = [];
                    const questionItems = document.querySelectorAll('.question-item');
                    questionItems.forEach((item, index) => {
                        const text = item.querySelector('.question-text').value.trim();
                        const type = item.querySelector('.question-type').value;
                        if (text) {
                            questions.push({
                                id: `q${index + 1}`,
                                question: text,
                                type: type
                            });
                        }
                    });
                    
                    if (questions.length === 0) {
                        alert('请至少添加一个问题');
                        return;
                    }
                    
                    const templateData = {
                        name: name,
                        description: description,
                        tags: tags,
                        questions: questions
                    };
                    
                    if (templateId) {
                        // 更新现有模板
                        const templateIndex = AppState.templates.findIndex(t => t.id === templateId);
                        if (templateIndex !== -1) {
                            AppState.templates[templateIndex] = { ...AppState.templates[templateIndex], ...templateData };
                        }
                    } else {
                        // 创建新模板
                        const newTemplate = {
                            id: Date.now().toString(),
                            ...templateData
                        };
                        AppState.templates.push(newTemplate);
                    }
                    
                    // 保存数据
                    saveData();
                    
                    // 重新渲染
                    renderTemplatesList();
                    renderQuestionnaireTemplates();
                    
                    // 关闭编辑器
                    document.getElementById('templateEditor').style.display = 'none';
                    document.getElementById('saveTemplateBtn').style.display = 'none';
                });
            }
        }
        
        // 新建问卷功能
        function setupNewQuestionnaire() {
            const newQuestionnaireBtn = document.getElementById('newQuestionnaireBtn');
            const backToTemplatesBtn = document.getElementById('backToTemplatesBtn');
            const templateSelectionCard = document.getElementById('templateSelectionCard');
            const newQuestionnaireContent = document.getElementById('newQuestionnaireContent');
            
            if (newQuestionnaireBtn) {
                newQuestionnaireBtn.addEventListener('click', function() {
                    // 隐藏模板选择，显示新建问卷界面
                    templateSelectionCard.style.display = 'none';
                    newQuestionnaireContent.style.display = 'block';
                    
                    // 清除模板选中状态
                    document.querySelectorAll('.template-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // 清空表单
                    document.getElementById('questionnaireTitle').value = '';
                    document.getElementById('questionnaireClientSearch').value = '';
                    
                    // 清空隐藏的客户端ID
                    const clientIdInput = document.getElementById('questionnaireClient');
                    if (clientIdInput) {
                        clientIdInput.value = '';
                    }
                    
                    // 清空问题容器，只保留一个默认问题
                    const questionsContainer = document.getElementById('customQuestionsContainer');
                    questionsContainer.innerHTML = `
                        <div class="custom-question-item">
                            <div class="custom-question-header">
                                <input type="text" class="form-control question-text" placeholder="问题1：请输入问题内容">
                                <select class="question-type-select">
                                    <option value="text">文本</option>
                                    <option value="textarea">长文本</option>
                                    <option value="select">单选</option>
                                    <option value="checkbox">多选</option>
                                </select>
                            </div>
                            <div class="question-options" style="display: none;">
                                <input type="text" class="form-control" placeholder="选项，用逗号分隔（例如：选项1,选项2,选项3）" style="margin-top: 10px;">
                            </div>
                        </div>
                    `;
                    
                    // 添加问题类型变化事件
                    setupQuestionTypeChange();
                });
            }
            
            if (backToTemplatesBtn) {
                backToTemplatesBtn.addEventListener('click', function() {
                    // 返回模板选择界面
                    templateSelectionCard.style.display = 'block';
                    newQuestionnaireContent.style.display = 'none';
                    document.getElementById('questionnaireContent').style.display = 'none';
                    document.getElementById('questionnaireShareSection').style.display = 'none';
                    
                    // 更新问卷操作按钮状态
                    updateQuestionnaireActionButtons();
                });
            }
            
            // 添加问题按钮
            const addQuestionBtn = document.getElementById('addQuestionBtn');
            if (addQuestionBtn) {
                addQuestionBtn.addEventListener('click', function() {
                    addCustomQuestion();
                });
            }
            
            // 保存自定义问卷按钮
            const saveCustomQuestionnaireBtn = document.getElementById('saveCustomQuestionnaireBtn');
            if (saveCustomQuestionnaireBtn) {
                saveCustomQuestionnaireBtn.addEventListener('click', function() {
                    saveCustomQuestionnaire();
                });
            }
            
            // 取消自定义问卷按钮
            const cancelCustomQuestionnaireBtn = document.getElementById('cancelCustomQuestionnaireBtn');
            if (cancelCustomQuestionnaireBtn) {
                cancelCustomQuestionnaireBtn.addEventListener('click', function() {
                    templateSelectionCard.style.display = 'block';
                    newQuestionnaireContent.style.display = 'none';
                    document.getElementById('questionnaireShareSection').style.display = 'none';
                    
                    // 更新问卷操作按钮状态
                    updateQuestionnaireActionButtons();
                });
            }
            
            // 保存为模板按钮
            const saveAsTemplateBtn = document.getElementById('saveAsTemplateBtn');
            if (saveAsTemplateBtn) {
                saveAsTemplateBtn.addEventListener('click', function() {
                    // 收集问题
                    const questions = [];
                    const questionItems = document.querySelectorAll('.custom-question-item');
                    questionItems.forEach((item, index) => {
                        const text = item.querySelector('.question-text').value.trim();
                        const type = item.querySelector('.question-type-select').value;
                        if (text) {
                            questions.push({
                                id: `q${index + 1}`,
                                question: text,
                                type: type
                            });
                        }
                    });
                    
                    if (questions.length === 0) {
                        alert('请至少添加一个问题');
                        return;
                    }
                    
                    // 弹出对话框获取模板名称和描述
                    const templateName = prompt('请输入模板名称：');
                    if (!templateName || templateName.trim() === '') {
                        alert('模板名称不能为空');
                        return;
                    }
                    
                    const templateDescription = prompt('请输入模板描述：');
                    const tagsStr = prompt('请输入模板标签（用逗号分隔）：') || '';
                    
                    // 解析标签
                    const tags = tagsStr ? tagsStr.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                    
                    // 创建新模板
                    const newTemplate = {
                        id: Date.now().toString(),
                        name: templateName.trim(),
                        description: templateDescription ? templateDescription.trim() : '',
                        tags: tags,
                        questions: questions
                    };
                    
                    // 添加到模板列表
                    AppState.templates.push(newTemplate);
                    
                    // 保存数据
                    saveData();
                    
                    // 重新渲染模板列表
                    renderQuestionnaireTemplates();
                    renderTemplatesList(); // 同时更新模板管理模态框中的模板列表
                    
                    alert('模板已成功保存！');
                });
            }
        }
        
        // 设置问题类型变化事件
        function setupQuestionTypeChange() {
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('question-type-select')) {
                    const questionItem = e.target.closest('.custom-question-item');
                    const optionsDiv = questionItem.querySelector('.question-options');
                    
                    if (e.target.value === 'select' || e.target.value === 'checkbox') {
                        optionsDiv.style.display = 'block';
                    } else {
                        optionsDiv.style.display = 'none';
                    }
                }
            });
        }
        
        // 添加自定义问题
        function addCustomQuestion() {
            const questionsContainer = document.getElementById('customQuestionsContainer');
            const questionCount = questionsContainer.children.length + 1;
            
            const questionHtml = `
                <div class="custom-question-item">
                    <div class="custom-question-header">
                        <input type="text" class="form-control question-text" placeholder="问题${questionCount}：请输入问题内容">
                        <select class="question-type-select">
                            <option value="text">文本</option>
                            <option value="textarea">长文本</option>
                            <option value="select">单选</option>
                            <option value="checkbox">多选</option>
                        </select>
                        <button type="button" class="btn btn-small btn-secondary remove-question">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="question-options" style="display: none;">
                        <input type="text" class="form-control" placeholder="选项，用逗号分隔（例如：选项1,选项2,选项3）" style="margin-top: 10px;">
                    </div>
                </div>
            `;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = questionHtml;
            const newQuestion = tempDiv.firstElementChild;
            questionsContainer.appendChild(newQuestion);
            
            // 添加删除按钮事件
            const removeBtn = newQuestion.querySelector('.remove-question');
            removeBtn.addEventListener('click', function() {
                this.closest('.custom-question-item').remove();
            });
            
            // 添加问题类型变化事件
            const typeSelect = newQuestion.querySelector('.question-type-select');
            typeSelect.addEventListener('change', function() {
                const optionsDiv = this.closest('.custom-question-item').querySelector('.question-options');
                if (this.value === 'select' || this.value === 'checkbox') {
                    optionsDiv.style.display = 'block';
                } else {
                    optionsDiv.style.display = 'none';
                }
            });
        }
        
        // 保存自定义问卷
        function saveCustomQuestionnaire() {
            const title = document.getElementById('questionnaireTitle').value.trim();
            const clientIdInput = document.getElementById('questionnaireClient');
            const clientId = clientIdInput ? clientIdInput.value : '';
            
            if (!title) {
                alert('请输入问卷标题');
                return;
            }
            
            if (!clientId) {
                alert('请选择关联客户');
                return;
            }
            
            // 收集问题
            const questions = [];
            const questionElements = document.querySelectorAll('#customQuestionsContainer .custom-question-item');
            
            questionElements.forEach((element, index) => {
                const questionText = element.querySelector('.question-text').value.trim();
                const questionType = element.querySelector('.question-type-select').value;
                
                if (questionText) {
                    const questionData = {
                        id: `q${index + 1}`,
                        question: questionText,
                        type: questionType
                    };
                    
                    // 如果是选择类型，添加选项
                    if (questionType === 'select' || questionType === 'checkbox') {
                        const optionsInput = element.querySelector('.question-options input');
                        if (optionsInput && optionsInput.value.trim()) {
                            questionData.options = optionsInput.value.split(',').map(opt => opt.trim());
                        }
                    }
                    
                    questions.push(questionData);
                }
            });
            
            if (questions.length === 0) {
                alert('请至少添加一个问题');
                return;
            }
            
            const client = AppState.clients.find(c => c.id === clientId);
            if (!client) {
                alert('客户不存在');
                return;
            }
            
            // 创建自定义模板
            const templateId = generateId();
            const templateData = {
                id: templateId,
                name: title,
                description: `为 ${client.groomName} & ${client.brideName} 定制的问卷`,
                tags: ['自定义', '专属'],
                questions: questions,
                isDefault: false
            };
            
            // 添加到模板列表
            AppState.templates.push(templateData);
            
            // 创建问卷
            const questionnaireId = generateId();
            const questionnaire = {
                id: questionnaireId,
                templateId: templateId,
                clientId: clientId,
                title: title,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                answers: {},
                completed: false
            };
            
            // 检查是否已有问卷
            const existingQuestionnaire = AppState.questionnaires.find(q => q.clientId === clientId);
            if (existingQuestionnaire) {
                if (confirm('该客户已有问卷，是否覆盖？')) {
                    // 删除旧的问卷
                    AppState.questionnaires = AppState.questionnaires.filter(q => q.id !== existingQuestionnaire.id);
                    AppState.questionnaires.push(questionnaire);
                } else {
                    return;
                }
            } else {
                AppState.questionnaires.push(questionnaire);
            }
            
            // 更新客户的问卷ID
            client.questionnaireId = questionnaireId;
            
            // 保存数据
            saveData();
            
            // 重新渲染模板列表
            renderQuestionnaireTemplates();
            
            // 返回模板选择界面
            document.getElementById('templateSelectionCard').style.display = 'block';
            document.getElementById('newQuestionnaireContent').style.display = 'none';
            
            // 加载新创建的问卷
            loadQuestionnaire(questionnaireId);
            
            alert('自定义问卷已保存！');
        }
        
        // 环节规划功能 - 时间轴拖拽和编辑
        function setupPlanning() {
            // 添加自定义环节按钮
            document.getElementById('addCustomStepBtn').addEventListener('click', function() {
                openCustomStepModal();
            });
            
            // 保存时间轴按钮
            document.getElementById('saveTimelineBtn').addEventListener('click', function() {
                saveTimeline();
            });
            
            // 返回初始状态按钮
            document.getElementById('clearPlanningBtn').addEventListener('click', function() {
                clearPlanning();
            });
            
            // 渲染自定义环节
            renderCustomSteps();
            
            // 设置时间轴拖拽功能
            setupTimelineDragAndDrop();
            
            // 设置时间编辑功能
            setupTimelineEditFunctions();
        }
        
        // 渲染时间轴
        function renderTimeline() {
            const timelineContainer = document.getElementById('weddingTimeline');
            const customStepsContainer = document.getElementById('customStepsContainer');
            
            // 清空时间轴（保留标准环节结构）
            const standardSteps = timelineContainer.querySelectorAll('.timeline-item[data-step-type="standard"]');
            const customStepsHtml = customStepsContainer.innerHTML;
            
            // 重新构建时间轴
            timelineContainer.innerHTML = '';
            
            // 添加标准环节
            standardSteps.forEach(step => {
                timelineContainer.appendChild(step);
            });
            
            // 添加自定义环节容器
            const containerDiv = document.createElement('div');
            containerDiv.id = 'customStepsContainer';
            containerDiv.innerHTML = customStepsHtml;
            timelineContainer.appendChild(containerDiv);
            
            // 重新设置拖拽功能
            setupTimelineDragAndDrop();
        }
        
        // 设置时间轴拖拽功能
        function setupTimelineDragAndDrop() {
            const timeline = document.getElementById('weddingTimeline');
            const items = timeline.querySelectorAll('.timeline-item, .custom-timeline-item');
            
            items.forEach(item => {
                item.setAttribute('draggable', 'true');
                
                item.addEventListener('dragstart', function(e) {
                    AppState.isDragging = true;
                    AppState.dragElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', this.dataset.stepId || '');
                });
                
                item.addEventListener('dragend', function() {
                    AppState.isDragging = false;
                    AppState.dragElement = null;
                    this.classList.remove('dragging');
                    document.querySelectorAll('.drag-placeholder').forEach(ph => ph.remove());
                });
            });
            
            timeline.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (!AppState.isDragging || !AppState.dragElement) return;
                
                const afterElement = getDragAfterElement(timeline, e.clientY);
                const placeholder = document.querySelector('.drag-placeholder');
                
                if (!placeholder) {
                    const ph = document.createElement('div');
                    ph.className = 'drag-placeholder';
                    timeline.appendChild(ph);
                }
                
                if (afterElement) {
                    timeline.insertBefore(document.querySelector('.drag-placeholder'), afterElement);
                } else {
                    timeline.appendChild(document.querySelector('.drag-placeholder'));
                }
            });
            
            timeline.addEventListener('drop', function(e) {
                e.preventDefault();
                if (!AppState.dragElement) return;
                
                const placeholder = document.querySelector('.drag-placeholder');
                if (placeholder && AppState.dragElement) {
                    timeline.insertBefore(AppState.dragElement, placeholder);
                    placeholder.remove();
                    
                    // 更新环节顺序
                    updateTimelineOrder();
                }
            });
        }
        
        // 获取拖拽后的元素位置
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.timeline-item:not(.dragging), .custom-timeline-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // 更新时间轴顺序
        function updateTimelineOrder() {
            const timeline = document.getElementById('weddingTimeline');
            const steps = timeline.querySelectorAll('.timeline-item, .custom-timeline-item');
            
            AppState.timelineSteps = [];
            steps.forEach(step => {
                const stepId = step.dataset.stepId;
                const stepType = step.dataset.stepType || 'custom';
                const timeElement = step.querySelector('.timeline-time span');
                const titleElement = step.querySelector('h4');
                const descElement = step.querySelector('p');
                
                AppState.timelineSteps.push({
                    id: stepId,
                    type: stepType,
                    time: timeElement ? timeElement.textContent : '',
                    title: titleElement ? titleElement.textContent : '',
                    description: descElement ? descElement.textContent : ''
                });
            });
        }
        
        // 设置时间轴编辑功能
        function setupTimelineEditFunctions() {
            // 编辑时间按钮事件已经在HTML中通过onclick绑定
            // 编辑内容按钮事件已经在HTML中通过onclick绑定
        }
        
        // 编辑时间轴时间（全局函数）
        window.editTimelineTime = function(stepId) {
            const step = document.querySelector(`[data-step-id="${stepId}"]`);
            if (!step) return;
            
            const timeElement = step.querySelector('.timeline-time span');
            const currentTime = timeElement ? timeElement.textContent : '';
            const timeParts = currentTime.split(' - ');
            
            const modal = document.getElementById('editTimeModal');
            document.getElementById('editStartTime').value = timeParts[0] || '';
            document.getElementById('editEndTime').value = timeParts[1] || '';
            document.getElementById('editStepId').value = stepId;
            
            AppState.editingTimeStep = stepId;
            modal.classList.add('active');
        };
        
        // 编辑时间轴内容（全局函数）
        window.editTimelineContent = function(stepId) {
            const step = document.querySelector(`[data-step-id="${stepId}"]`);
            if (!step) return;
            
            const titleElement = step.querySelector('h4');
            const descElement = step.querySelector('p');
            
            const modal = document.getElementById('editContentModal');
            document.getElementById('editStepTitle').value = titleElement ? titleElement.textContent : '';
            document.getElementById('editStepDescription').value = descElement ? descElement.textContent : '';
            document.getElementById('editContentStepId').value = stepId;
            
            AppState.editingContentStep = stepId;
            modal.classList.add('active');
        };
        
        // 保存时间轴时间
        function setupEditTimeModal() {
            const modal = document.getElementById('editTimeModal');
            const closeBtn = document.getElementById('closeEditTimeModal');
            const cancelBtn = document.getElementById('cancelEditTimeBtn');
            const saveBtn = document.getElementById('saveEditTimeBtn');
            
            function closeModal() {
                modal.classList.remove('active');
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            saveBtn.addEventListener('click', function() {
                const stepId = document.getElementById('editStepId').value;
                const startTime = document.getElementById('editStartTime').value.trim();
                const endTime = document.getElementById('editEndTime').value.trim();
                
                const step = document.querySelector(`[data-step-id="${stepId}"]`);
                if (step) {
                    const timeElement = step.querySelector('.timeline-time span');
                    if (timeElement) {
                        if (startTime && endTime) {
                            timeElement.textContent = `${startTime} - ${endTime}`;
                        } else if (startTime) {
                            timeElement.textContent = startTime;
                        } else if (endTime) {
                            timeElement.textContent = endTime;
                        }
                        
                        // 更新时间轴数据
                        updateTimelineOrder();
                    }
                }
                
                closeModal();
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 保存时间轴内容
        function setupEditContentModal() {
            const modal = document.getElementById('editContentModal');
            const closeBtn = document.getElementById('closeEditContentModal');
            const cancelBtn = document.getElementById('cancelEditContentBtn');
            const saveBtn = document.getElementById('saveEditContentBtn');
            
            function closeModal() {
                modal.classList.remove('active');
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            saveBtn.addEventListener('click', function() {
                const stepId = document.getElementById('editContentStepId').value;
                const title = document.getElementById('editStepTitle').value.trim();
                const description = document.getElementById('editStepDescription').value.trim();
                
                const step = document.querySelector(`[data-step-id="${stepId}"]`);
                if (step) {
                    const titleElement = step.querySelector('h4');
                    const descElement = step.querySelector('p');
                    
                    if (titleElement && title) {
                        titleElement.textContent = title;
                    }
                    
                    if (descElement && description) {
                        descElement.textContent = description;
                    }
                    
                    // 更新时间轴数据
                    updateTimelineOrder();
                }
                
                closeModal();
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 保存时间轴到本地存储
        function saveTimeline() {
            const hostScript = document.getElementById('hostScript').value;
            
            // 更新时间轴数据
            updateTimelineOrder();
            
            // 保存主持词
            const timelineData = {
                steps: AppState.timelineSteps,
                hostScript: hostScript,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('weddingHostTimeline', JSON.stringify(timelineData));
            alert('时间轴已保存！');
        }
        
        // 清空规划页面状态
        function clearPlanning() {
            // 清空搜索框
            document.getElementById('planClientSearchInput').value = '';
            
            // 重置标题
            document.getElementById('planningTitle').textContent = '婚礼时间轴规划';
            document.getElementById('planningClientTitle').textContent = '婚礼时间轴规划';
            
            // 清空自定义环节容器
            const customStepsContainer = document.getElementById('customStepsContainer');
            customStepsContainer.innerHTML = '';
            
            // 清空主持词
            document.getElementById('hostScript').value = '';
            
            // 重置时间轴数据
            AppState.timelineSteps = [
                {
                    id: 'step-1',
                    type: 'standard',
                    time: '15:00 - 15:30',
                    title: '迎宾与签到',
                    description: '主持人迎宾，引导宾客签到，暖场音乐播放。'
                },
                {
                    id: 'step-2',
                    type: 'standard',
                    time: '15:30 - 15:40',
                    title: '开场白与宾客欢迎',
                    description: '主持人开场，介绍婚礼主题，欢迎所有来宾。'
                },
                {
                    id: 'step-3',
                    type: 'standard',
                    time: '15:40 - 15:50',
                    title: '新郎入场',
                    description: '新郎登场，与主持人简短互动。'
                }
            ];
            
            // 重新渲染时间轴
            renderTimeline();
            
            alert('已返回初始状态！');
        }
        
        // 加载客户环节规划
        function loadClientPlanning(clientId) {
            const client = AppState.clients.find(c => c.id === clientId);
            if (!client) return;
            
            // 更新标题
            document.getElementById('planningTitle').textContent = `${client.groomName} & ${client.brideName} 的婚礼时间轴规划`;
            document.getElementById('planningClientTitle').textContent = `${client.groomName} & ${client.brideName} 的婚礼时间轴规划`;
            
            // 清空自定义环节容器
            const customStepsContainer = document.getElementById('customStepsContainer');
            customStepsContainer.innerHTML = '';
            
            // 添加该客户的自定义环节
            const clientSteps = AppState.customSteps.filter(step => 
                step.clientId === clientId
            );
            
            if (clientSteps.length > 0) {
                clientSteps.forEach(step => {
                    const stepHtml = `
                        <div class="custom-timeline-item" data-step-id="${step.id}" data-step-type="custom">
                            <div class="custom-timeline-content">
                                <div>
                                    <h4>${step.name}</h4>
                                    ${step.time ? `<div style="color: var(--info); font-weight: 500; margin-bottom: 5px;">${step.time}${step.duration ? ` (约${step.duration}分钟)` : ''}</div>` : ''}
                                    <p>${step.description}</p>
                                </div>
                                <div class="custom-timeline-actions">
                                    <button class="btn btn-small btn-secondary" onclick="editCustomStep('${step.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="deleteCustomStep('${step.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = stepHtml;
                    const newStep = tempDiv.firstElementChild;
                    customStepsContainer.appendChild(newStep);
                });
                
                // 重新设置拖拽功能
                setupTimelineDragAndDrop();
            }
            
            // 更新主持词要点
            const hostScript = document.getElementById('hostScript');
            hostScript.value = client.notes || '';
            
            // 显示客户信息
            alert(`已加载 ${client.groomName} & ${client.brideName} 的环节规划`);
        }
        
        // 渲染自定义环节
        function renderCustomSteps() {
            const container = document.getElementById('customStepsContainer');
            
            if (AppState.customSteps.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            AppState.customSteps.forEach(step => {
                // 获取关联客户信息
                let clientInfo = '';
                if (step.clientId) {
                    const client = AppState.clients.find(c => c.id === step.clientId);
                    if (client) {
                        clientInfo = `<small style="color: var(--gray);">关联客户: ${client.groomName} & ${client.brideName}</small>`;
                    }
                }
                
                html += `
                    <div class="custom-timeline-item" data-step-id="${step.id}" data-step-type="custom">
                        <div class="custom-timeline-content">
                            <div>
                                <h4>${step.name}</h4>
                                ${step.time ? `<div style="color: var(--info); font-weight: 500; margin-bottom: 5px;">${step.time}${step.duration ? ` (约${step.duration}分钟)` : ''}</div>` : ''}
                                <p>${step.description}</p>
                                ${clientInfo}
                            </div>
                            <div class="custom-timeline-actions">
                                <button class="btn btn-small btn-secondary" onclick="editCustomStep('${step.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="deleteCustomStep('${step.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 重新设置拖拽功能
            setupTimelineDragAndDrop();
        }
        
        // 打开自定义环节模态框
        function openCustomStepModal(stepId = null) {
            const modal = document.getElementById('customStepModal');
            const form = document.getElementById('customStepForm');
            
            // 重置表单
            form.reset();
            
            // 填充客户选项
            const stepClientSelect = document.getElementById('stepClient');
            stepClientSelect.innerHTML = '<option value="">不关联特定客户（通用环节）</option>';
            
            AppState.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.groomName} & ${client.brideName} (${client.weddingDate})`;
                stepClientSelect.appendChild(option);
            });
            
            if (stepId) {
                // 编辑现有环节
                const step = AppState.customSteps.find(s => s.id === stepId);
                if (step) {
                    document.getElementById('stepName').value = step.name;
                    document.getElementById('stepTime').value = step.time || '';
                    document.getElementById('stepDuration').value = step.duration || '';
                    document.getElementById('stepDescription').value = step.description || '';
                    document.getElementById('stepClient').value = step.clientId || '';
                    document.getElementById('stepId').value = step.id;
                    
                    AppState.editingStep = step;
                }
            } else {
                // 添加新环节
                AppState.editingStep = null;
                document.getElementById('stepId').value = '';
            }
            
            modal.classList.add('active');
        }
        
        // 保存自定义环节
        function setupCustomStepModal() {
            const modal = document.getElementById('customStepModal');
            const closeBtn = document.getElementById('closeCustomStepModal');
            const cancelBtn = document.getElementById('cancelCustomStepBtn');
            const saveBtn = document.getElementById('saveCustomStepBtn');
            
            // 关闭模态框
            function closeModal() {
                modal.classList.remove('active');
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 保存环节
            saveBtn.addEventListener('click', function() {
                const form = document.getElementById('customStepForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const stepData = {
                    id: document.getElementById('stepId').value || generateId(),
                    name: document.getElementById('stepName').value,
                    time: document.getElementById('stepTime').value,
                    duration: document.getElementById('stepDuration').value ? parseInt(document.getElementById('stepDuration').value) : null,
                    description: document.getElementById('stepDescription').value,
                    clientId: document.getElementById('stepClient').value || null
                };
                
                // 检查是否已存在相同ID的环节
                const existingIndex = AppState.customSteps.findIndex(s => s.id === stepData.id);
                
                if (existingIndex >= 0) {
                    // 更新现有环节
                    AppState.customSteps[existingIndex] = stepData;
                } else {
                    // 添加新环节
                    AppState.customSteps.push(stepData);
                }
                
                // 保存数据
                saveData();
                
                // 刷新环节显示
                renderCustomSteps();
                
                // 关闭模态框
                closeModal();
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 编辑自定义环节（全局函数）
        window.editCustomStep = function(stepId) {
            openCustomStepModal(stepId);
        };
        
        // 删除自定义环节（全局函数）
        window.deleteCustomStep = function(stepId) {
            if (confirm('确定要删除这个环节吗？')) {
                AppState.customSteps = AppState.customSteps.filter(s => s.id !== stepId);
                saveData();
                renderCustomSteps();
            }
        };
        
        // 音乐管理功能
        function setupMusicManagement() {
            // 添加音乐按钮
            document.getElementById('addMusicBtn').addEventListener('click', function() {
                openMusicModal();
            });
            
            // 音乐视图切换
            setupMusicViewToggle();
            
            // 本地文件上传
            setupFileUpload();
            
            // 多场次音乐播放系统
            setupMusicSessionSystem();
            
            // 渲染初始音乐库
            renderMusicLibrary();
            
            // 渲染音乐分类
            renderMusicCategories();
            
            // 初始化遥控器控制
            initRemoteControl();
        }
        
        // 设置音乐视图切换
        function setupMusicViewToggle() {
            const viewBtns = document.querySelectorAll('.music-view-btn-optimized');
            const views = {
                'library': document.getElementById('musicLibraryView'),
                'local': document.getElementById('localMusicView'),
                'session': document.getElementById('sessionOnlyView')
            };
            
            viewBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.getAttribute('data-music-view');
                    
                    // 更新按钮状态
                    viewBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 切换视图显示
                    Object.values(views).forEach(v => {
                        v.classList.remove('active-view');
                    });
                    
                    views[view].classList.add('active-view');
                    
                    // 如果是播放系统视图，确保播放列表已加载
                    if (view === 'session') {
                        renderSessionPlaylist('sessionPlaylist2');
                    }
                });
            });
        }
        
        // 渲染音乐分类
        function renderMusicCategories() {
            const container = document.getElementById('musicCategoriesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            AppState.musicCategories.forEach(category => {
                const tag = document.createElement('span');
                tag.className = 'music-category-tag';
                tag.setAttribute('data-category-key', category.key);
                tag.innerHTML = `
                    ${category.name}
                    <span class="edit-icon" onclick="editMusicCategory('${category.key}', event)">
                        <i class="fas fa-edit"></i>
                    </span>
                `;
                
                container.appendChild(tag);
                
                // 添加点击事件
                tag.addEventListener('click', function(e) {
                    if (e.target.closest('.edit-icon')) return;
                    
                    const categoryKey = this.getAttribute('data-category-key');
                    renderMusicLibrary(categoryKey);
                    
                    // 高亮选中的分类
                    document.querySelectorAll('.music-category-tag').forEach(t => {
                        t.style.backgroundColor = 'rgba(233, 30, 99, 0.1)';
                    });
                    this.style.backgroundColor = 'rgba(233, 30, 99, 0.2)';
                });
            });
        }
        
        // 编辑音乐分类（全局函数）
        window.editMusicCategory = function(categoryKey, event) {
            event.stopPropagation();
            
            const category = AppState.musicCategories.find(c => c.key === categoryKey);
            if (!category) return;
            
            const modal = document.getElementById('editCategoryModal');
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryKey').value = category.key;
            document.getElementById('editCategoryOriginalKey').value = category.key;
            
            AppState.editingCategory = category;
            modal.classList.add('active');
        };
        
        // 设置编辑音乐分类模态框
        function setupEditCategoryModal() {
            const modal = document.getElementById('editCategoryModal');
            const closeBtn = document.getElementById('closeEditCategoryModal');
            const cancelBtn = document.getElementById('cancelEditCategoryBtn');
            const saveBtn = document.getElementById('saveEditCategoryBtn');
            
            // 关闭模态框
            function closeModal() {
                modal.classList.remove('active');
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 保存分类
            saveBtn.addEventListener('click', function() {
                const originalKey = document.getElementById('editCategoryOriginalKey').value;
                const newName = document.getElementById('editCategoryName').value.trim();
                const newKey = document.getElementById('editCategoryKey').value.trim();
                
                if (!newName || !newKey) {
                    alert('分类名称和标识不能为空');
                    return;
                }
                
                // 检查是否已存在相同标识的分类（排除自身）
                const existingCategory = AppState.musicCategories.find(c => c.key === newKey && c.key !== originalKey);
                if (existingCategory) {
                    alert('该分类标识已存在，请使用其他标识');
                    return;
                }
                
                // 查找要编辑的分类
                const categoryIndex = AppState.musicCategories.findIndex(c => c.key === originalKey);
                if (categoryIndex === -1) {
                    // 添加新分类
                    AppState.musicCategories.push({
                        key: newKey,
                        name: newName
                    });
                } else {
                    // 更新现有分类
                    AppState.musicCategories[categoryIndex] = {
                        key: newKey,
                        name: newName
                    };
                    
                    // 更新使用该分类的音乐
                    AppState.music.forEach(music => {
                        if (music.category === originalKey) {
                            music.category = newKey;
                        }
                    });
                }
                
                // 保存数据
                saveData();
                
                // 重新渲染
                renderMusicCategories();
                renderMusicLibrary();
                
                // 关闭模态框
                closeModal();
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 设置多场次音乐播放系统
        function setupMusicSessionSystem() {
            // 创建播放列表按钮
            document.getElementById('createSessionBtn').addEventListener('click', function() {
                createNewMusicSession('sessionSelect');
            });
            
            document.getElementById('createSessionBtn2').addEventListener('click', function() {
                createNewMusicSession('sessionSelect2');
            });
            
            // 编辑播放列表按钮
            document.getElementById('editSessionBtn').addEventListener('click', function() {
                editMusicSession('sessionSelect');
            });
            
            document.getElementById('editSessionBtn2').addEventListener('click', function() {
                editMusicSession('sessionSelect2');
            });
            
            // 清空播放列表按钮
            document.getElementById('clearSessionBtn').addEventListener('click', function() {
                clearMusicSession('sessionSelect');
            });
            
            document.getElementById('clearSessionBtn2').addEventListener('click', function() {
                clearMusicSession('sessionSelect2');
            });
            
            // 播放列表选择
            document.getElementById('sessionSelect').addEventListener('change', function() {
                const sessionId = this.value;
                if (sessionId) {
                    loadMusicSession(sessionId);
                }
            });
            
            document.getElementById('sessionSelect2').addEventListener('change', function() {
                const sessionId = this.value;
                if (sessionId) {
                    loadMusicSession(sessionId, true);
                }
            });
            
            // 设置播放列表拖拽排序
            setupSessionDragAndDrop();
            
            // 设置遥控器控制
            setupRemoteControl();
        }
        
        // 设置播放列表拖拽排序
        function setupSessionDragAndDrop() {
            const playlists = ['sessionPlaylist', 'sessionPlaylist2'];
            
            playlists.forEach(playlistId => {
                const playlist = document.getElementById(playlistId);
                if (!playlist) return;
                
                playlist.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                playlist.addEventListener('drop', function(e) {
                    e.preventDefault();
                    
                    if (!AppState.currentSession) {
                        alert('请先选择一个播放列表');
                        return;
                    }
                    
                    const musicId = e.dataTransfer.getData('text/plain');
                    if (musicId) {
                        // 检查是否已存在
                        if (AppState.currentSession.tracks.includes(musicId)) {
                            alert('这首音乐已经在播放列表中');
                            return;
                        }
                        
                        // 添加到播放列表
                        AppState.currentSession.tracks.push(musicId);
                        saveData();
                        renderSessionPlaylist();
                        
                        // 如果当前在sessionOnly视图，也更新另一个播放列表
                        if (playlistId === 'sessionPlaylist2') {
                            renderSessionPlaylist('sessionPlaylist');
                        } else if (playlistId === 'sessionPlaylist') {
                            renderSessionPlaylist('sessionPlaylist2');
                        }
                    }
                });
            });
        }
        
        // 渲染播放列表选择器
        function renderSessionSelector() {
            const select = document.getElementById('sessionSelect');
            const select2 = document.getElementById('sessionSelect2');
            
            // 清空选项（保留第一个选项）
            while (select.options.length > 1) {
                select.remove(1);
            }
            while (select2.options.length > 1) {
                select2.remove(1);
            }
            
            // 添加播放列表选项
            AppState.musicSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = session.name;
                select.appendChild(option);
                
                const option2 = option.cloneNode(true);
                select2.appendChild(option2);
            });
        }
        
        // 渲染播放列表
        function renderSessionPlaylist(playlistId = 'sessionPlaylist') {
            const playlist = document.getElementById(playlistId);
            
            if (!AppState.currentSession) {
                playlist.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--gray);">
                        <i class="fas fa-music" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                        <p>请选择一个播放列表</p>
                    </div>
                `;
                return;
            }
            
            const session = AppState.currentSession;
            const tracks = session.tracks || [];
            
            if (tracks.length === 0) {
                playlist.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--gray);">
                        <i class="fas fa-list" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                        <p>播放列表为空</p>
                        <p style="font-size: 0.9rem;">从音乐库拖动音乐到此处添加</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            tracks.forEach((trackId, index) => {
                const music = AppState.music.find(m => m.id === trackId);
                if (!music) return;
                
                const isPlaying = AppState.playingMusic === trackId && 
                                 AppState.currentSession && 
                                 AppState.currentSession.id === session.id;
                
                html += `
                    <div class="session-track ${isPlaying ? 'playing' : ''} ${AppState.sessionTrackIndex === index ? 'active' : ''}" 
                         data-track-id="${trackId}" data-track-index="${index}" draggable="true">
                        <div class="session-track-number">${index + 1}</div>
                        <div class="session-track-info">
                            <div class="session-track-title">${music.title}</div>
                            <div class="session-track-artist">${music.artist || '未知演唱者'}</div>
                        </div>
                        <div class="session-track-duration">--:--</div>
                        <div class="session-track-actions">
                            <button class="btn btn-small btn-secondary" onclick="removeFromSession('${session.id}', ${index}, '${playlistId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            playlist.innerHTML = html;
            
            // 添加拖拽排序功能
            setupTrackDragAndDrop(playlist);
            
            // 添加点击播放事件
            document.querySelectorAll(`#${playlistId} .session-track`).forEach(track => {
                track.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                    
                    const trackId = this.getAttribute('data-track-id');
                    const trackIndex = parseInt(this.getAttribute('data-track-index'));
                    
                    if (AppState.currentSession && AppState.currentSession.id === session.id && 
                        AppState.playingMusic === trackId) {
                        // 暂停当前音乐
                        togglePlayMusic(trackId);
                    } else {
                        // 播放选中的音乐
                        AppState.sessionTrackIndex = trackIndex;
                        playSessionTrack(session.id, trackIndex);
                    }
                });
            });
        }
        
        // 设置音轨拖拽排序
        function setupTrackDragAndDrop(playlist) {
            let draggedTrack = null;
            
            playlist.querySelectorAll('.session-track').forEach(track => {
                track.addEventListener('dragstart', function() {
                    draggedTrack = this;
                    this.classList.add('dragging');
                });
                
                track.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedTrack = null;
                    
                    // 更新播放列表顺序
                    updateSessionTrackOrder();
                });
            });
            
            playlist.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(playlist, e.clientY);
                const draggable = document.querySelector('.dragging');
                
                if (draggable) {
                    if (afterElement == null) {
                        playlist.appendChild(draggable);
                    } else {
                        playlist.insertBefore(draggable, afterElement);
                    }
                }
            });
        }
        
        // 更新播放列表音轨顺序
        function updateSessionTrackOrder() {
            if (!AppState.currentSession) return;
            
            const playlist = document.getElementById('sessionPlaylist');
            const tracks = playlist.querySelectorAll('.session-track');
            const newTrackOrder = [];
            
            tracks.forEach(track => {
                const trackId = track.getAttribute('data-track-id');
                newTrackOrder.push(trackId);
            });
            
            AppState.currentSession.tracks = newTrackOrder;
            saveData();
            
            // 更新另一个播放列表显示
            renderSessionPlaylist('sessionPlaylist2');
        }
        
        // 创建新的播放列表
        function createNewMusicSession(selectId) {
            const sessionName = prompt('请输入播放列表名称：');
            if (!sessionName) return;
            
            const sessionId = generateId();
            const newSession = {
                id: sessionId,
                name: sessionName,
                description: '新建播放列表',
                tracks: []
            };
            
            AppState.musicSessions.push(newSession);
            saveData();
            renderSessionSelector();
            
            // 选择新建的播放列表
            const select = document.getElementById(selectId);
            select.value = sessionId;
            
            // 触发change事件
            select.dispatchEvent(new Event('change'));
        }
        
        // 编辑播放列表
        function editMusicSession(selectId) {
            const select = document.getElementById(selectId);
            const sessionId = select.value;
            
            if (!sessionId) {
                alert('请先选择一个播放列表');
                return;
            }
            
            const session = AppState.musicSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const newName = prompt('请输入新的播放列表名称：', session.name);
            if (!newName) return;
            
            session.name = newName;
            saveData();
            renderSessionSelector();
            
            // 更新当前会话
            if (AppState.currentSession && AppState.currentSession.id === sessionId) {
                AppState.currentSession.name = newName;
            }
            
            // 更新播放列表显示
            renderSessionPlaylist();
            renderSessionPlaylist('sessionPlaylist2');
            
            // 更新选择框
            select.value = sessionId;
        }
        
        // 清空播放列表
        function clearMusicSession(selectId) {
            const select = document.getElementById(selectId);
            const sessionId = select.value;
            
            if (!sessionId) {
                alert('请先选择一个播放列表');
                return;
            }
            
            if (confirm('确定要清空播放列表中的所有歌曲吗？')) {
                const session = AppState.musicSessions.find(s => s.id === sessionId);
                if (session) {
                    session.tracks = [];
                    saveData();
                    
                    // 更新当前会话
                    if (AppState.currentSession && AppState.currentSession.id === sessionId) {
                        AppState.currentSession.tracks = [];
                    }
                    
                    renderSessionPlaylist();
                    renderSessionPlaylist('sessionPlaylist2');
                }
            }
        }
        
        // 加载播放列表
        function loadMusicSession(sessionId, updateSelect2 = false) {
            const session = AppState.musicSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            AppState.currentSession = session;
            AppState.sessionTrackIndex = 0;
            
            renderSessionPlaylist();
            
            if (updateSelect2) {
                document.getElementById('sessionSelect2').value = sessionId;
                renderSessionPlaylist('sessionPlaylist2');
            } else {
                document.getElementById('sessionSelect').value = sessionId;
            }
            
            // 更新遥控器按钮状态
            updateRemoteControlButtons();
        }
        
        // 从播放列表移除音乐
        window.removeFromSession = function(sessionId, index, playlistId = 'sessionPlaylist') {
            if (confirm('确定要从播放列表中移除这首音乐吗？')) {
                const session = AppState.musicSessions.find(s => s.id === sessionId);
                if (session && session.tracks) {
                    session.tracks.splice(index, 1);
                    saveData();
                    
                    // 更新当前会话
                    if (AppState.currentSession && AppState.currentSession.id === sessionId) {
                        AppState.currentSession.tracks = session.tracks;
                    }
                    
                    renderSessionPlaylist(playlistId);
                    
                    // 更新另一个播放列表显示
                    if (playlistId === 'sessionPlaylist') {
                        renderSessionPlaylist('sessionPlaylist2');
                    } else {
                        renderSessionPlaylist('sessionPlaylist');
                    }
                }
            }
        };
        
        // 播放播放列表中的音乐
        function playSessionTrack(sessionId, trackIndex) {
            const session = AppState.musicSessions.find(s => s.id === sessionId);
            if (!session || !session.tracks || session.tracks.length === 0) return;
            
            if (trackIndex >= 0 && trackIndex < session.tracks.length) {
                const trackId = session.tracks[trackIndex];
                AppState.currentSession = session;
                AppState.sessionTrackIndex = trackIndex;
                
                // 播放音乐
                togglePlayMusic(trackId);
                
                // 更新播放列表显示
                renderSessionPlaylist();
                renderSessionPlaylist('sessionPlaylist2');
                
                // 更新遥控器按钮状态
                updateRemoteControlButtons();
            }
        }
        
        // 打开音乐模态框
        function openMusicModal(musicId = null) {
            const modal = document.getElementById('musicModal');
            const form = document.getElementById('musicForm');
            
            // 重置表单
            form.reset();
            
            // 设置默认文件类型
            document.getElementById('musicFileType').value = 'link';
            document.getElementById('localFileSection').style.display = 'none';
            
            // 更新本地文件选择框
            updateLocalFileSelect();
            
            // 文件类型切换事件
            document.getElementById('musicFileType').addEventListener('change', function() {
                if (this.value === 'local') {
                    document.getElementById('localFileSection').style.display = 'block';
                } else {
                    document.getElementById('localFileSection').style.display = 'none';
                }
            });
            
            // 填充音乐分类选项
            const musicCategorySelect = document.getElementById('musicCategory');
            musicCategorySelect.innerHTML = '';
            
            AppState.musicCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.key;
                option.textContent = category.name;
                musicCategorySelect.appendChild(option);
            });
            
            if (musicId) {
                // 编辑现有音乐
                const music = AppState.music.find(m => m.id === musicId);
                if (music) {
                    document.getElementById('musicTitle').value = music.title;
                    document.getElementById('musicArtist').value = music.artist || '';
                    document.getElementById('musicCategory').value = music.category;
                    document.getElementById('musicSource').value = music.source || '';
                    document.getElementById('musicNotes').value = music.notes || '';
                    
                    if (music.fileType === 'local') {
                        document.getElementById('musicFileType').value = 'local';
                        document.getElementById('localFileSection').style.display = 'block';
                        document.getElementById('localFileSelect').value = music.source || '';
                    }
                    
                    AppState.editingMusic = music;
                }
            } else {
                // 添加新音乐
                AppState.editingMusic = null;
            }
            
            modal.classList.add('active');
        }
        
        // 更新本地文件选择框
        function updateLocalFileSelect() {
            const select = document.getElementById('localFileSelect');
            
            // 清空选项（保留第一个选项）
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // 添加本地文件选项
            AppState.localMusicFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file.id;
                option.textContent = file.name;
                select.appendChild(option);
            });
        }
        
        // 保存音乐
        function setupMusicModal() {
            const modal = document.getElementById('musicModal');
            const closeBtn = document.getElementById('closeMusicModal');
            const cancelBtn = document.getElementById('cancelMusicBtn');
            const saveBtn = document.getElementById('saveMusicBtn');
            
            // 关闭模态框
            function closeModal() {
                modal.classList.remove('active');
            }
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 保存音乐
            saveBtn.addEventListener('click', function() {
                const form = document.getElementById('musicForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const fileType = document.getElementById('musicFileType').value;
                let source = '';
                
                if (fileType === 'local') {
                    const localFileId = document.getElementById('localFileSelect').value;
                    if (!localFileId) {
                        alert('请选择本地音乐文件');
                        return;
                    }
                    const file = AppState.localMusicFiles.find(f => f.id === localFileId);
                    source = file ? file.id : '';
                } else {
                    source = document.getElementById('musicSource').value;
                }
                
                const musicData = {
                    id: AppState.editingMusic ? AppState.editingMusic.id : generateId(),
                    title: document.getElementById('musicTitle').value,
                    artist: document.getElementById('musicArtist').value,
                    category: document.getElementById('musicCategory').value,
                    source: source,
                    notes: document.getElementById('musicNotes').value,
                    fileType: fileType
                };
                
                // 检查是否已存在相同ID的音乐
                const existingIndex = AppState.music.findIndex(m => m.id === musicData.id);
                
                if (existingIndex >= 0) {
                    // 更新现有音乐
                    AppState.music[existingIndex] = musicData;
                } else {
                    // 添加新音乐
                    AppState.music.push(musicData);
                }
                
                // 保存数据
                saveData();
                
                // 刷新音乐库
                renderMusicLibrary();
                
                // 关闭模态框
                closeModal();
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        // 渲染音乐库
        function renderMusicLibrary(filter = null) {
            const musicLibrary = document.getElementById('musicLibrary');
            
            let filteredMusic = AppState.music;
            if (filter) {
                filteredMusic = AppState.music.filter(music => music.category === filter);
            }
            
            if (filteredMusic.length === 0) {
                musicLibrary.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">
                            <i class="fas fa-music"></i>
                        </div>
                        <h3>暂无${filter ? '此类' : ''}音乐</h3>
                        <p>点击上方"添加音乐"按钮开始创建你的婚礼音乐库</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredMusic.forEach(music => {
                // 查找分类名称
                const category = AppState.musicCategories.find(c => c.key === music.category);
                const categoryLabel = category ? category.name : music.category;
                
                // 判断音乐状态
                let statusClass = 'inactive';
                if (AppState.playingMusic === music.id) {
                    statusClass = AppState.audioPlayer.paused ? 'paused' : 'playing';
                }
                
                // 获取音乐文件信息（如果是本地文件）
                let fileInfo = '';
                if (music.fileType === 'local') {
                    const file = AppState.localMusicFiles.find(f => f.id === music.source);
                    if (file) {
                        fileInfo = `<div class="music-artist">本地文件: ${file.name}</div>`;
                    }
                }
                
                html += `
                    <div class="music-item ${statusClass}" data-music-id="${music.id}" draggable="true">
                        <div class="music-actions">
                            <button class="btn btn-small btn-secondary" onclick="editMusic('${music.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="deleteMusic('${music.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="music-title">${music.title}</div>
                        ${music.fileType === 'local' ? fileInfo : `<div class="music-artist">${music.artist || '未知演唱者'}</div>`}
                        <div class="music-tags">
                            <span class="music-tag">${categoryLabel}</span>
                            ${music.fileType === 'local' ? '<span class="music-tag">本地文件</span>' : ''}
                        </div>
                        <div class="music-player-container">
                            <div class="music-status-indicator"></div>
                            <div class="music-progress">
                                <div class="music-progress-bar" id="progress-${music.id}"></div>
                            </div>
                            <div class="music-time" id="time-${music.id}">0:00</div>
                        </div>
                    </div>
                `;
            });
            
            musicLibrary.innerHTML = html;
            
            // 添加点击播放事件
            document.querySelectorAll('.music-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // 如果点击的是操作按钮，不触发播放
                    if (e.target.closest('.music-actions')) return;
                    
                    const musicId = this.getAttribute('data-music-id');
                    togglePlayMusic(musicId);
                });
                
                // 拖拽开始
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.getAttribute('data-music-id'));
                    e.dataTransfer.effectAllowed = 'copy';
                });
            });
        }
        
        // 播放/暂停音乐
        window.togglePlayMusic = function(musicId) {
            const music = AppState.music.find(m => m.id === musicId);
            if (!music) return;
            
            if (AppState.playingMusic === musicId) {
                // 暂停当前音乐
                if (music.fileType === 'local') {
                    // 暂停本地音乐
                    const audioObj = AppState.localAudioObjects[musicId];
                    if (audioObj) {
                        audioObj.pause();
                    }
                } else {
                    // 暂停在线音乐
                    AppState.audioPlayer.pause();
                }
                
                // 更新状态
                AppState.playingMusic = null;
                AppState.remoteControl.isPlaying = false;
            } else {
                // 停止当前播放的音乐
                if (AppState.playingMusic) {
                    const prevMusic = AppState.music.find(m => m.id === AppState.playingMusic);
                    if (prevMusic && prevMusic.fileType === 'local') {
                        const prevAudioObj = AppState.localAudioObjects[AppState.playingMusic];
                        if (prevAudioObj) {
                            prevAudioObj.pause();
                            prevAudioObj.currentTime = 0;
                        }
                    } else {
                        AppState.audioPlayer.pause();
                        AppState.audioPlayer.currentTime = 0;
                    }
                }
                
                // 开始播放新音乐
                AppState.playingMusic = musicId;
                AppState.remoteControl.isPlaying = true;
                
                if (music.fileType === 'local') {
                    // 播放本地音乐文件
                    const file = AppState.localMusicFiles.find(f => f.id === music.source);
                    if (file && file.file) {
                        // 如果文件对象存在（通过上传获取的File对象）
                        const audioUrl = URL.createObjectURL(file.file);
                        let audioObj = AppState.localAudioObjects[musicId];
                        
                        if (!audioObj) {
                            audioObj = new Audio();
                            audioObj.volume = AppState.remoteControl.volume;
                            AppState.localAudioObjects[musicId] = audioObj;
                            
                            // 设置事件监听
                            audioObj.addEventListener('timeupdate', function() {
                                updateLocalMusicProgress(musicId, audioObj);
                            });
                            
                            audioObj.addEventListener('ended', function() {
                                AppState.playingMusic = null;
                                AppState.remoteControl.isPlaying = false;
                                renderMusicLibrary();
                                renderSessionPlaylist();
                                renderSessionPlaylist('sessionPlaylist2');
                                updateRemoteControlButtons();
                            });
                        }
                        
                        audioObj.src = audioUrl;
                        audioObj.play().catch(e => {
                            console.error('播放本地音乐失败:', e);
                            alert('播放本地音乐失败，请确认文件格式正确');
                            AppState.playingMusic = null;
                            AppState.remoteControl.isPlaying = false;
                            renderMusicLibrary();
                            renderSessionPlaylist();
                            renderSessionPlaylist('sessionPlaylist2');
                            updateRemoteControlButtons();
                        });
                    } else {
                        // 文件对象不存在，显示提示
                        alert('本地音乐文件不存在或未正确加载。请重新上传文件。');
                        AppState.playingMusic = null;
                        AppState.remoteControl.isPlaying = false;
                    }
                } else {
                    // 播放在线音乐（使用示例音频）
                    AppState.audioPlayer.src = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
                    AppState.audioPlayer.play();
                }
            }
            
            // 更新UI
            renderMusicLibrary();
            renderSessionPlaylist();
            renderSessionPlaylist('sessionPlaylist2');
            updateRemoteControlButtons();
        };
        
        // 更新本地音乐播放进度
        function updateLocalMusicProgress(musicId, audioObj) {
            if (!AppState.playingMusic || AppState.playingMusic !== musicId) return;
            
            const currentTime = audioObj.currentTime;
            const duration = audioObj.duration;
            
            // 更新进度条
            const progressBar = document.getElementById(`progress-${musicId}`);
            const timeDisplay = document.getElementById(`time-${musicId}`);
            
            if (progressBar && timeDisplay) {
                const progressPercent = (currentTime / duration) * 100 || 0;
                progressBar.style.width = `${progressPercent}%`;
                
                // 格式化时间显示
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };
                
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                
                // 更新播放列表中的时间显示
                if (AppState.currentSession) {
                    const sessionTrack = document.querySelector(`.session-track[data-track-id="${musicId}"] .session-track-duration`);
                    if (sessionTrack) {
                        sessionTrack.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                    }
                }
            }
        }
        
        // 更新音乐播放进度（在线音乐）
        function updateMusicProgress() {
            if (!AppState.playingMusic) return;
            
            const music = AppState.music.find(m => m.id === AppState.playingMusic);
            if (!music || music.fileType === 'local') return;
            
            const currentTime = AppState.audioPlayer.currentTime;
            const duration = AppState.audioPlayer.duration;
            
            // 更新进度条
            const progressBar = document.getElementById(`progress-${AppState.playingMusic}`);
            const timeDisplay = document.getElementById(`time-${AppState.playingMusic}`);
            
            if (progressBar && timeDisplay) {
                const progressPercent = (currentTime / duration) * 100 || 0;
                progressBar.style.width = `${progressPercent}%`;
                
                // 格式化时间显示
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };
                
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                
                // 更新播放列表中的时间显示
                if (AppState.currentSession) {
                    const sessionTrack = document.querySelector(`.session-track[data-track-id="${AppState.playingMusic}"] .session-track-duration`);
                    if (sessionTrack) {
                        sessionTrack.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                    }
                }
            }
        }
        
        // 编辑音乐（全局函数，供按钮调用）
        window.editMusic = function(musicId) {
            openMusicModal(musicId);
        };
        
        // 删除音乐（全局函数，供按钮调用）
        window.deleteMusic = function(musicId) {
            if (confirm('确定要删除这首音乐吗？')) {
                // 从音乐库中删除
                AppState.music = AppState.music.filter(music => music.id !== musicId);
                
                // 从所有播放列表中删除
                AppState.musicSessions.forEach(session => {
                    if (session.tracks) {
                        session.tracks = session.tracks.filter(trackId => trackId !== musicId);
                    }
                });
                
                // 删除对应的音频对象
                delete AppState.localAudioObjects[musicId];
                
                saveData();
                renderMusicLibrary();
                renderSessionSelector();
                renderSessionPlaylist();
                renderSessionPlaylist('sessionPlaylist2');
            }
        };
        
        // 初始化遥控器控制
        function initRemoteControl() {
            // 设置键盘快捷键
            document.addEventListener('keydown', function(e) {
                // 只在音乐管理页面响应
                if (AppState.currentTab !== 'music') return;
                
                switch(e.key) {
                    case ' ': // 空格键 - 播放/暂停
                        e.preventDefault();
                        remotePlayPause();
                        break;
                    case 'ArrowLeft': // 左箭头 - 上一曲
                        e.preventDefault();
                        remotePrev();
                        break;
                    case 'ArrowRight': // 右箭头 - 下一曲
                        e.preventDefault();
                        remoteNext();
                        break;
                    case 's': // S键 - 停止
                    case 'S':
                        e.preventDefault();
                        remoteStop();
                        break;
                    case 'ArrowUp': // 上箭头 - 音量增大
                        e.preventDefault();
                        remoteVolumeUp();
                        break;
                    case 'ArrowDown': // 下箭头 - 音量减小
                        e.preventDefault();
                        remoteVolumeDown();
                        break;
                }
            });
        }
        
        // 设置遥控器控制
        function setupRemoteControl() {
            // 第一组遥控器按钮
            document.getElementById('remotePrevBtn').addEventListener('click', remotePrev);
            document.getElementById('remotePlayPauseBtn').addEventListener('click', remotePlayPause);
            document.getElementById('remoteNextBtn').addEventListener('click', remoteNext);
            document.getElementById('remoteStopBtn').addEventListener('click', remoteStop);
            document.getElementById('remoteVolumeUpBtn').addEventListener('click', remoteVolumeUp);
            document.getElementById('remoteVolumeDownBtn').addEventListener('click', remoteVolumeDown);
            
            // 第二组遥控器按钮
            document.getElementById('remotePrevBtn2').addEventListener('click', remotePrev);
            document.getElementById('remotePlayPauseBtn2').addEventListener('click', remotePlayPause);
            document.getElementById('remoteNextBtn2').addEventListener('click', remoteNext);
            document.getElementById('remoteStopBtn2').addEventListener('click', remoteStop);
            document.getElementById('remoteVolumeUpBtn2').addEventListener('click', remoteVolumeUp);
            document.getElementById('remoteVolumeDownBtn2').addEventListener('click', remoteVolumeDown);
            
            // 初始更新按钮状态
            updateRemoteControlButtons();
        }
        
        // 遥控器 - 上一曲
        function remotePrev() {
            if (!AppState.currentSession || !AppState.currentSession.tracks || AppState.currentSession.tracks.length === 0) {
                alert('请先选择播放列表');
                return;
            }
            
            if (AppState.sessionTrackIndex > 0) {
                AppState.sessionTrackIndex--;
                playSessionTrack(AppState.currentSession.id, AppState.sessionTrackIndex);
            } else {
                alert('已经是第一首了');
            }
        }
        
        // 遥控器 - 播放/暂停
        function remotePlayPause() {
            if (!AppState.currentSession || !AppState.currentSession.tracks || AppState.currentSession.tracks.length === 0) {
                alert('请先选择播放列表');
                return;
            }
            
            if (AppState.playingMusic) {
                // 当前有音乐在播放，暂停/继续
                const music = AppState.music.find(m => m.id === AppState.playingMusic);
                if (music) {
                    togglePlayMusic(AppState.playingMusic);
                }
            } else {
                // 没有音乐在播放，播放当前选中的音乐
                if (AppState.sessionTrackIndex >= 0 && AppState.sessionTrackIndex < AppState.currentSession.tracks.length) {
                    playSessionTrack(AppState.currentSession.id, AppState.sessionTrackIndex);
                } else {
                    // 从第一首开始播放
                    AppState.sessionTrackIndex = 0;
                    playSessionTrack(AppState.currentSession.id, AppState.sessionTrackIndex);
                }
            }
        }
        
        // 遥控器 - 下一曲
        function remoteNext() {
            if (!AppState.currentSession || !AppState.currentSession.tracks || AppState.currentSession.tracks.length === 0) {
                alert('请先选择播放列表');
                return;
            }
            
            if (AppState.sessionTrackIndex < AppState.currentSession.tracks.length - 1) {
                AppState.sessionTrackIndex++;
                playSessionTrack(AppState.currentSession.id, AppState.sessionTrackIndex);
            } else {
                alert('已经是最后一首了');
            }
        }
        
        // 遥控器 - 停止
        function remoteStop() {
            if (AppState.playingMusic) {
                const music = AppState.music.find(m => m.id === AppState.playingMusic);
                if (music) {
                    if (music.fileType === 'local') {
                        const audioObj = AppState.localAudioObjects[AppState.playingMusic];
                        if (audioObj) {
                            audioObj.pause();
                            audioObj.currentTime = 0;
                        }
                    } else {
                        AppState.audioPlayer.pause();
                        AppState.audioPlayer.currentTime = 0;
                    }
                    
                    AppState.playingMusic = null;
                    AppState.remoteControl.isPlaying = false;
                    
                    // 更新UI
                    renderMusicLibrary();
                    renderSessionPlaylist();
                    renderSessionPlaylist('sessionPlaylist2');
                    updateRemoteControlButtons();
                    
                    alert('播放已停止');
                }
            }
        }
        
        // 遥控器 - 音量增大
        function remoteVolumeUp() {
            if (AppState.remoteControl.volume < 1.0) {
                AppState.remoteControl.volume = Math.min(1.0, AppState.remoteControl.volume + 0.1);
                AppState.audioPlayer.volume = AppState.remoteControl.volume;
                
                // 更新所有本地音频对象的音量
                Object.values(AppState.localAudioObjects).forEach(audioObj => {
                    audioObj.volume = AppState.remoteControl.volume;
                });
                
                alert(`音量已增大: ${Math.round(AppState.remoteControl.volume * 100)}%`);
            } else {
                alert('音量已最大');
            }
        }
        
        // 遥控器 - 音量减小
        function remoteVolumeDown() {
            if (AppState.remoteControl.volume > 0.1) {
                AppState.remoteControl.volume = Math.max(0.1, AppState.remoteControl.volume - 0.1);
                AppState.audioPlayer.volume = AppState.remoteControl.volume;
                
                // 更新所有本地音频对象的音量
                Object.values(AppState.localAudioObjects).forEach(audioObj => {
                    audioObj.volume = AppState.remoteControl.volume;
                });
                
                alert(`音量已减小: ${Math.round(AppState.remoteControl.volume * 100)}%`);
            } else {
                alert('音量已最小');
            }
        }
        
        // 更新遥控器按钮状态
        function updateRemoteControlButtons() {
            const playPauseBtn = document.getElementById('remotePlayPauseBtn');
            const playPauseBtn2 = document.getElementById('remotePlayPauseBtn2');
            
            if (playPauseBtn) {
                const icon = playPauseBtn.querySelector('i');
                if (AppState.remoteControl.isPlaying) {
                    icon.className = 'fas fa-pause';
                    playPauseBtn.title = '暂停 (空格键)';
                } else {
                    icon.className = 'fas fa-play';
                    playPauseBtn.title = '播放 (空格键)';
                }
            }
            
            if (playPauseBtn2) {
                const icon = playPauseBtn2.querySelector('i');
                if (AppState.remoteControl.isPlaying) {
                    icon.className = 'fas fa-pause';
                    playPauseBtn2.title = '暂停 (空格键)';
                } else {
                    icon.className = 'fas fa-play';
                    playPauseBtn2.title = '播放 (空格键)';
                }
            }
        }
        
        // 设置文件上传
        function setupFileUpload() {
            const fileInput = document.getElementById('musicFileInput');
            const uploadArea = document.getElementById('fileUploadArea');
            
            // 点击上传区域触发文件选择
            uploadArea.addEventListener('click', function(e) {
                if (e.target !== fileInput) {
                    fileInput.click();
                }
            });
            
            // 拖放功能
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
            
            // 文件选择变化
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                handleFiles(files);
            });
        }
        
        // 处理上传的文件
        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                // 检查文件类型
                const validTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/x-m4a', 'audio/ogg'];
                if (!validTypes.includes(file.type)) {
                    alert(`文件 ${file.name} 不是支持的音频格式`);
                    return false;
                }
                
                // 检查文件大小（最大50MB）
                if (file.size > 50 * 1024 * 1024) {
                    alert(`文件 ${file.name} 太大，最大支持50MB`);
                    return false;
                }
                
                return true;
            });
            
            if (validFiles.length === 0) return;
            
            // 添加文件到列表
            validFiles.forEach(file => {
                const fileId = generateId();
                const fileData = {
                    id: fileId,
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type,
                    uploadDate: new Date().toISOString().split('T')[0],
                    file: file // 保存文件对象用于播放
                };
                
                AppState.localMusicFiles.push(fileData);
            });
            
            // 保存数据
            saveData();
            
            // 更新文件列表
            renderLocalFilesList();
            
            // 更新音乐模态框中的文件选择框
            updateLocalFileSelect();
            
            alert(`成功添加 ${validFiles.length} 个音乐文件`);
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // 渲染本地文件列表
        function renderLocalFilesList() {
            const filesList = document.getElementById('localFilesList');
            
            if (AppState.localMusicFiles.length === 0) {
                filesList.innerHTML = `
                    <li class="local-file-item">
                        <div class="local-file-info">
                            <i class="fas fa-music file-icon"></i>
                            <span>暂无本地音乐文件</span>
                        </div>
                    </li>
                `;
                return;
            }
            
            let html = '';
            
            AppState.localMusicFiles.forEach(file => {
                html += `
                    <li class="local-file-item">
                        <div class="local-file-info">
                            <i class="fas fa-music file-icon"></i>
                            <div>
                                <div>${file.name}</div>
                                <small style="color: var(--gray);">${file.size} | ${file.uploadDate}</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-small btn-secondary" onclick="playLocalFile('${file.id}')">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="deleteLocalFile('${file.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
            
            filesList.innerHTML = html;
        }
        
        // 播放本地文件（全局函数）
        window.playLocalFile = function(fileId) {
            const file = AppState.localMusicFiles.find(f => f.id === fileId);
            if (!file || !file.file) {
                alert('文件不存在或未正确加载');
                return;
            }
            
            // 创建临时音乐条目进行播放
            const tempMusicId = `temp-${fileId}`;
            const tempMusic = {
                id: tempMusicId,
                title: file.name,
                artist: '本地文件',
                category: 'other',
                source: fileId,
                notes: '本地音乐文件',
                fileType: 'local'
            };
            
            // 如果已经有相同ID的音乐，使用它
            const existingIndex = AppState.music.findIndex(m => m.fileType === 'local' && m.source === fileId);
            if (existingIndex >= 0) {
                togglePlayMusic(AppState.music[existingIndex].id);
            } else {
                // 临时添加到音乐列表并播放
                AppState.music.push(tempMusic);
                togglePlayMusic(tempMusicId);
                
                // 播放后移除临时条目
                setTimeout(() => {
                    AppState.music = AppState.music.filter(m => m.id !== tempMusicId);
                }, 100);
            }
        };
        
        // 删除本地文件（全局函数）
        window.deleteLocalFile = function(fileId) {
            if (confirm('确定要删除这个本地文件吗？')) {
                AppState.localMusicFiles = AppState.localMusicFiles.filter(file => file.id !== fileId);
                
                // 同时删除引用此文件的音乐记录
                AppState.music = AppState.music.filter(music => {
                    if (music.fileType === 'local' && music.source === fileId) {
                        return false;
                    }
                    return true;
                });
                
                // 从所有播放列表中删除
                AppState.musicSessions.forEach(session => {
                    if (session.tracks) {
                        session.tracks = session.tracks.filter(trackId => {
                            const music = AppState.music.find(m => m.id === trackId);
                            return !(music && music.fileType === 'local' && music.source === fileId);
                        });
                    }
                });
                
                // 删除对应的音频对象
                delete AppState.localAudioObjects[fileId];
                
                saveData();
                renderLocalFilesList();
                updateLocalFileSelect();
                renderMusicLibrary();
                renderSessionPlaylist();
                renderSessionPlaylist('sessionPlaylist2');
            }
        };
        
        // 数据备份与恢复功能
        function setupDataBackup() {
            // 备份数据按钮
            document.getElementById('backupBtn').addEventListener('click', function() {
                exportData();
            });
            
            // 导出数据按钮
            document.getElementById('exportDataBtn').addEventListener('click', function() {
                exportData();
            });
            
            // 恢复数据按钮
            document.getElementById('restoreBtn').addEventListener('click', function() {
                importData();
            });
            
            // 导出功能按钮
            document.getElementById('exportBtn').addEventListener('click', function() {
                const exportModal = document.getElementById('exportModal');
                if (exportModal) {
                    exportModal.classList.add('active');
                }
            });
            
            // 关闭导出模态框
            const closeExportModal = document.getElementById('closeExportModal');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const exportModal = document.getElementById('exportModal');
            
            function closeExportModalFunc() {
                if (exportModal) {
                    exportModal.classList.remove('active');
                }
            }
            
            if (closeExportModal) {
                closeExportModal.addEventListener('click', closeExportModalFunc);
            }
            
            if (cancelExportBtn) {
                cancelExportBtn.addEventListener('click', closeExportModalFunc);
            }
            
            // 导出当前页截图
            const exportScreenshotBtn = document.getElementById('exportScreenshotBtn');
            if (exportScreenshotBtn) {
                exportScreenshotBtn.addEventListener('click', function() {
                    exportScreenshot();
                    closeExportModalFunc();
                });
            }
            
            // 导出客户信息Excel按钮 - 打开选择模态框
            const openExportClientsModalBtn = document.getElementById('openExportClientsModalBtn');
            const exportClientsModal = document.getElementById('exportClientsModal');
            const closeExportClientsModal = document.getElementById('closeExportClientsModal');
            const cancelExportClientsBtn = document.getElementById('cancelExportClientsBtn');
            const confirmExportClientsBtn = document.getElementById('confirmExportClientsBtn');
            
            // 打开导出客户信息模态框
            if (openExportClientsModalBtn) {
                openExportClientsModalBtn.addEventListener('click', function() {
                    // 生成客户选择选项
                    generateClientExportOptions();
                    // 打开模态框
                    exportClientsModal.classList.add('active');
                    closeExportModalFunc();
                });
            }
            
            // 关闭导出客户信息模态框
            function closeExportClientsModalFunc() {
                exportClientsModal.classList.remove('active');
            }
            
            // 关闭按钮
            if (closeExportClientsModal) {
                closeExportClientsModal.addEventListener('click', closeExportClientsModalFunc);
            }
            
            // 取消按钮
            if (cancelExportClientsBtn) {
                cancelExportClientsBtn.addEventListener('click', closeExportClientsModalFunc);
            }
            
            // 生成客户选择选项
            function generateClientExportOptions(searchTerm = '') {
                const select = document.getElementById('exportClientSelect');
                if (!select) return;
                
                // 清空现有选项（保留"所有客户"）
                const allOption = select.querySelector('option[value="all"]');
                select.innerHTML = '';
                select.appendChild(allOption);
                
                // 筛选客户
                let filteredClients = AppState.clients;
                if (searchTerm.trim()) {
                    const term = searchTerm.toLowerCase();
                    filteredClients = AppState.clients.filter(client => {
                        const fullName = `${client.groomName || ''} ${client.brideName || ''}`.toLowerCase();
                        const weddingDate = (client.weddingDate || '').toLowerCase();
                        return fullName.includes(term) || weddingDate.includes(term);
                    });
                }
                
                // 添加客户选项
                filteredClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.groomName} & ${client.brideName} - ${client.weddingDate || '未指定日期'}`;
                    select.appendChild(option);
                });
            }
            
            // 添加搜索事件监听
            const exportClientSearch = document.getElementById('exportClientSearch');
            if (exportClientSearch) {
                exportClientSearch.addEventListener('input', function() {
                    generateClientExportOptions(this.value);
                });
            }
            
            // 确认导出客户信息
            if (confirmExportClientsBtn) {
                confirmExportClientsBtn.addEventListener('click', function() {
                    const clientId = document.getElementById('exportClientSelect').value;
                    const selectedFields = [];
                    
                    // 收集选中的字段
                    document.querySelectorAll('.export-field:checked').forEach(checkbox => {
                        selectedFields.push(checkbox.value);
                    });
                    
                    // 调用导出函数
                    exportClientsToExcel(clientId, selectedFields);
                    closeExportClientsModalFunc();
                });
            }
            
            // 导入数据按钮
            document.getElementById('importDataBtn').addEventListener('click', function() {
                importData();
            });
            
            // 清空数据按钮
            document.getElementById('clearDataBtn').addEventListener('click', function() {
                if (confirm('确定要清空所有数据吗？此操作不可撤销！')) {
                    localStorage.clear();
                    AppState.localAudioObjects = {};
                    initData();
                    renderCalendar();
                    renderEventsList();
                    renderClientsList();
                    renderMusicLibrary();
                    renderQuestionnaireTemplates();
                    renderCustomSteps();
                    renderSessionSelector();
                    renderSessionPlaylist();
                    renderSessionPlaylist('sessionPlaylist2');
                    updateDataStatus();
                    alert('所有数据已清空，已恢复为示例数据');
                }
            });
        }
        
        // 导出数据
        function exportData() {
            // 注意：File对象不能被JSON序列化，所以需要特殊处理
            const exportData = {
                events: AppState.events,
                clients: AppState.clients,
                music: AppState.music,
                templates: AppState.templates,
                customSteps: AppState.customSteps,
                localMusicFiles: AppState.localMusicFiles.map(file => {
                    // 移除File对象，只保留元数据
                    const { file: fileObj, ...fileData } = file;
                    return fileData;
                }),
                timelineSteps: AppState.timelineSteps,
                musicSessions: AppState.musicSessions,
                musicCategories: AppState.musicCategories,
                questionnaires: AppState.questionnaires,
                exportDate: new Date().toISOString(),
                appName: '婚礼主持管家高级版'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `婚礼主持管家备份_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('数据已成功导出为JSON文件，请妥善保存！\n注意：本地音乐文件需要重新上传。');
        }
        
        // 导出当前页截图
        function exportScreenshot() {
            try {
                // 显示加载提示
                const loadingDiv = document.createElement('div');
                loadingDiv.style.position = 'fixed';
                loadingDiv.style.top = '50%';
                loadingDiv.style.left = '50%';
                loadingDiv.style.transform = 'translate(-50%, -50%)';
                loadingDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                loadingDiv.style.color = 'white';
                loadingDiv.style.padding = '20px 30px';
                loadingDiv.style.borderRadius = '8px';
                loadingDiv.style.zIndex = '9999';
                loadingDiv.style.fontSize = '16px';
                loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在生成截图，请稍候...';
                document.body.appendChild(loadingDiv);
                
                // 获取要截图的元素
                const targetElement = document.querySelector('.main-content') || document.body;
                
                // 使用html2canvas生成真实截图
                html2canvas(targetElement, {
                    scale: 2, // 提高分辨率
                    useCORS: true, // 允许跨域图片
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: targetElement.scrollWidth,
                    height: targetElement.scrollHeight
                }).then(function(canvas) {
                    // 移除加载提示
                    document.body.removeChild(loadingDiv);
                    
                    // 将canvas转换为图片并下载
                    const dataURL = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = dataURL;
                    a.download = `婚礼主持管家截图_${new Date().toISOString().split('T')[0]}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    alert('截图已成功导出！');
                }).catch(function(error) {
                    // 移除加载提示
                    document.body.removeChild(loadingDiv);
                    
                    console.error('截图失败:', error);
                    alert('截图失败：' + error.message);
                });
            } catch (error) {
                console.error('截图初始化失败:', error);
                alert('截图初始化失败：' + error.message);
            }
        }
        
        // 导出客户信息Excel
        function exportClientsToExcel(clientId = 'all', selectedFields = ['basic', 'contact', 'wedding', 'notes']) {
            try {
                if (!AppState.clients || AppState.clients.length === 0) {
                    alert('暂无客户数据可导出');
                    return;
                }
                
                // 筛选要导出的客户
                let clientsToExport = AppState.clients;
                if (clientId !== 'all') {
                    clientsToExport = AppState.clients.filter(client => client.id === clientId);
                    if (clientsToExport.length === 0) {
                        alert('未找到指定客户');
                        return;
                    }
                }
                
                // 时间槽映射
                const timeSlotMap = {
                    morning: '上午',
                    noon: '中午',
                    afternoon: '下午',
                    evening: '晚上'
                };
                
                // 准备表头和数据映射
                let headers = [];
                let dataMap = {};
                
                // 根据选中的字段生成表头
                if (selectedFields.includes('basic')) {
                    headers.push('客户ID', '新郎姓名', '新娘姓名', '客户类型');
                    dataMap.basic = (client) => [
                        client.id,
                        client.groomName || '',
                        client.brideName || '',
                        client.clientType || '普通客户'
                    ];
                }
                
                if (selectedFields.includes('contact')) {
                    headers.push('新郎联系电话', '新郎微信', '新娘联系电话', '新娘微信', '联系地址');
                    dataMap.contact = (client) => [
                        client.groomPhone || '',
                        client.groomWechat || '',
                        client.bridePhone || '',
                        client.brideWechat || '',
                        client.address || ''
                    ];
                }
                
                if (selectedFields.includes('wedding')) {
                    headers.push('婚礼日期', '婚礼地点', '活动时间', '婚礼主题', '婚礼预算', '婚礼风格', '其他婚礼信息');
                    dataMap.wedding = (client) => [
                        client.weddingDate || '',
                        client.weddingLocation || '',
                        timeSlotMap[client.timeSlot] || '未指定',
                        client.weddingTheme || '',
                        client.budget || '',
                        client.weddingStyle || '',
                        client.weddingInfo || ''
                    ];
                }
                
                if (selectedFields.includes('partner')) {
                    headers.push('婚礼合作商名称', '合作商联系人', '合作商联系方式', '合作商服务内容');
                    dataMap.partner = (client) => [
                        client.partnerName || '',
                        client.partnerContact || '',
                        client.partnerPhone || '',
                        client.partnerService || ''
                    ];
                }
                
                if (selectedFields.includes('notes')) {
                    headers.push('备注', '创建日期', '更新日期');
                    dataMap.notes = (client) => [
                        client.notes || '',
                        client.createdAt ? new Date(client.createdAt).toLocaleString() : '',
                        client.updatedAt ? new Date(client.updatedAt).toLocaleString() : ''
                    ];
                }
                
                // 准备Excel内容（CSV格式，可直接用Excel打开）
                let csvContent = 'data:text/csv;charset=utf-8,';
                
                // 添加表头
                csvContent += headers.join(',') + '\n';
                
                // 添加客户数据
                clientsToExport.forEach(client => {
                    let row = [];
                    
                    // 收集选中字段的数据
                    for (const fieldType of selectedFields) {
                        if (dataMap[fieldType]) {
                            row = row.concat(dataMap[fieldType](client));
                        }
                    }
                    
                    // 转义CSV特殊字符
                    const escapedRow = row.map(cell => {
                        if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                            return '"' + cell.replace(/"/g, '""') + '"';
                        }
                        return cell;
                    });
                    
                    csvContent += escapedRow.join(',') + '\n';
                });
                
                // 创建下载链接
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                
                // 生成文件名
                let fileName = '';
                if (clientId === 'all') {
                    fileName = `所有客户信息_${new Date().toISOString().split('T')[0]}.csv`;
                } else {
                    const client = clientsToExport[0];
                    fileName = `${client.groomName}${client.brideName ? '&' + client.brideName : ''}_客户信息_${new Date().toISOString().split('T')[0]}.csv`;
                }
                
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                
                // 触发下载
                link.click();
                document.body.removeChild(link);
                
                alert(`成功导出 ${clientsToExport.length} 位客户的信息！`);
            } catch (error) {
                console.error('导出Excel失败:', error);
                alert('导出Excel失败：' + error.message);
            }
        }
        
        // 导入数据
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // 验证数据格式
                        if (!data.events || !data.clients || !data.music) {
                            throw new Error('数据格式不正确');
                        }
                        
                        // 确认导入
                        if (confirm(`即将导入 ${data.events.length} 个档期，${data.clients.length} 个客户，${data.music.length} 首音乐。是否继续？`)) {
                            AppState.events = data.events;
                            AppState.clients = data.clients;
                            AppState.music = data.music;
                            AppState.templates = data.templates || [];
                            AppState.customSteps = data.customSteps || [];
                            AppState.localMusicFiles = data.localMusicFiles || [];
                            AppState.timelineSteps = data.timelineSteps || [];
                            AppState.musicSessions = data.musicSessions || [];
                            AppState.musicCategories = data.musicCategories || AppState.musicCategories;
                            AppState.questionnaires = data.questionnaires || [];
                            AppState.localAudioObjects = {};
                            
                            saveData();
                            renderCalendar();
                            renderEventsList();
                            renderClientsList();
                            renderMusicLibrary();
                            renderQuestionnaireTemplates();
                            renderCustomSteps();
                            renderSessionSelector();
                            renderSessionPlaylist();
                            renderSessionPlaylist('sessionPlaylist2');
                            updateDataStatus();
                            updateClientStats();
                            
                            alert('数据导入成功！\n注意：本地音乐文件需要重新上传才能播放。');
                        }
                    } catch (error) {
                        alert('导入失败：数据文件格式不正确或已损坏');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // 跳转到规划页面
        window.goToPlanning = function(clientId) {
            // 切换到规划标签
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelector('.nav-item[data-tab="planning"]').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('planning-tab').classList.add('active');
            
            // 选择对应的客户
            const planClientSearchInput = document.getElementById('planClientSearchInput');
            const client = AppState.clients.find(c => c.id === clientId);
            
            if (client && planClientSearchInput) {
                planClientSearchInput.value = `${client.groomName} & ${client.brideName}`;
                
                // 加载该客户的环节规划
                loadClientPlanning(clientId);
            }
            
            AppState.currentTab = 'planning';
        };
        
        // 初始化应用
        function initApp() {
            // 初始化数据
            initData();
            
            // 初始化汉堡菜单
            const mobileNavToggle = document.getElementById('mobileNavToggle');
            const appNav = document.getElementById('appNav');
            const navItems = document.querySelectorAll('.nav-item');
            
            if (mobileNavToggle && appNav) {
                // 展开/收起菜单
                mobileNavToggle.addEventListener('click', function() {
                    appNav.classList.toggle('active');
                });
                
                // 点击导航项后关闭菜单
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        appNav.classList.remove('active');
                    });
                });
            }
            
            // 设置导航
            setupNavigation();
            
            // 设置视图切换
            setupViewToggle();
            
            // 设置年份切换
            setupYearToggle();
            
            // 设置日历功能
            setupCalendar();
            
            // 设置事件模态框
            setupEventModal();
            
            // 设置客户管理
            setupClientManagement();
            
            // 设置客户模态框
            setupClientModal();
            
            // 设置客户搜索
            setupClientSearch();
            
            // 设置问卷模板管理
            setupNewQuestionnaire();
            setupTemplateManagement();
            
            // 设置问卷导入导出
            setupQuestionnaireImport();
            setupImportQuestionnaireModal();
            
            // 设置环节规划
            setupPlanning();
            
            // 设置自定义环节模态框
            setupCustomStepModal();
            
            // 设置时间编辑模态框
            setupEditTimeModal();
            
            // 设置内容编辑模态框
            setupEditContentModal();
            
            // 设置音乐管理
            setupMusicManagement();
            
            // 设置音乐模态框
            setupMusicModal();
            
            // 设置音乐分类编辑
            setupEditCategoryModal();
            
            // 设置数据备份
            setupDataBackup();
            
            // 渲染问卷模板
            renderQuestionnaireTemplates();
            
            // 请求通知权限
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // 初始更新问卷操作按钮状态
            updateQuestionnaireActionButtons();
            
            // 设置主持人工具箱
            setupToolkit();
        }
        
        // 主持人工具箱功能
        function setupToolkit() {
            // 移除现有的事件监听器，防止重复绑定
            // 注意：这里使用事件委托来避免重复绑定问题
            
            // 设置工具箱导航切换
            const toolkitNav = document.querySelector('.toolkit-nav');
            if (toolkitNav) {
                // 移除现有的事件监听器
                toolkitNav.removeEventListener('click', handleToolkitNavClick);
                // 添加新的事件监听器
                toolkitNav.addEventListener('click', handleToolkitNavClick);
            }
            
            // 设置台词分类按钮事件
            const addLineCategoryBtn = document.getElementById('addLineCategoryBtn');
            if (addLineCategoryBtn) {
                addLineCategoryBtn.removeEventListener('click', addLineCategory);
                addLineCategoryBtn.addEventListener('click', addLineCategory);
            }
            
            const editLineCategoryBtn = document.getElementById('editLineCategoryBtn');
            if (editLineCategoryBtn) {
                editLineCategoryBtn.removeEventListener('click', editLineCategory);
                editLineCategoryBtn.addEventListener('click', editLineCategory);
            }
            
            // 设置文件导入按钮事件
            const importLineFileBtn = document.getElementById('importLineFileBtn');
            if (importLineFileBtn) {
                importLineFileBtn.removeEventListener('click', toggleImportSection);
                importLineFileBtn.addEventListener('click', toggleImportSection);
            }
            
            // 设置取消导入按钮事件
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            if (cancelImportBtn) {
                cancelImportBtn.removeEventListener('click', toggleImportSection);
                cancelImportBtn.addEventListener('click', toggleImportSection);
            }
            
            // 设置文件输入事件
            const lineFileInput = document.getElementById('lineFileInput');
            if (lineFileInput) {
                lineFileInput.removeEventListener('change', handleLineFileImport);
                lineFileInput.addEventListener('change', handleLineFileImport);
            }
            
            // 设置添加目录按钮事件
            const addDirectoryBtn = document.getElementById('addDirectoryBtn');
            if (addDirectoryBtn) {
                addDirectoryBtn.removeEventListener('click', addDirectory);
                addDirectoryBtn.addEventListener('click', addDirectory);
            }
            
            // 设置合同按钮事件
            const addContractBtn = document.getElementById('addContractBtn');
            if (addContractBtn) {
                addContractBtn.removeEventListener('click', addContract);
                addContractBtn.addEventListener('click', addContract);
            }
            
            const editContractBtn = document.getElementById('editContractBtn');
            if (editContractBtn) {
                editContractBtn.removeEventListener('click', editContract);
                editContractBtn.addEventListener('click', editContract);
            }
            
            // 设置游戏按钮事件
            const addGameBtn = document.getElementById('addGameBtn');
            if (addGameBtn) {
                addGameBtn.removeEventListener('click', addGame);
                addGameBtn.addEventListener('click', addGame);
            }
            
            const editGameBtn = document.getElementById('editGameBtn');
            if (editGameBtn) {
                editGameBtn.removeEventListener('click', editGame);
                editGameBtn.addEventListener('click', editGame);
            }
            
            // 设置发言稿按钮事件
            const addSpeechBtn = document.getElementById('addSpeechBtn');
            if (addSpeechBtn) {
                addSpeechBtn.removeEventListener('click', addSpeech);
                addSpeechBtn.addEventListener('click', addSpeech);
            }
            
            const editSpeechBtn = document.getElementById('editSpeechBtn');
            if (editSpeechBtn) {
                editSpeechBtn.removeEventListener('click', editSpeech);
                editSpeechBtn.addEventListener('click', editSpeech);
            }
            
            // 初始渲染台词分类
            renderLineCategories();
        }
        
        // 工具箱导航点击处理函数
        function handleToolkitNavClick(e) {
            const btn = e.target.closest('button[data-toolkit-section]');
            if (!btn) return;
            
            const section = btn.dataset.toolkitSection;
            
            // 更新导航按钮状态
            const toolkitNavBtns = document.querySelectorAll('.toolkit-nav button[data-toolkit-section]');
            toolkitNavBtns.forEach(b => {
                b.classList.remove('btn-primary', 'active');
                b.classList.add('btn-secondary');
            });
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary', 'active');
            
            // 显示对应的内容区域
            const sections = document.querySelectorAll('.toolkit-section');
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById(`${section}-section`).classList.add('active');
            
            // 渲染对应内容
            if (section === 'lines') {
                renderLineCategories();
            } else if (section === 'contracts') {
                renderContracts();
            } else if (section === 'games') {
                renderGames();
            } else if (section === 'speeches') {
                renderSpeeches();
            }
        }
        
        // 切换文件导入区域显示/隐藏
        window.toggleImportSection = function() {
            const importSection = document.querySelector('.file-import-section');
            if (importSection) {
                importSection.style.display = importSection.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // 处理台词文件导入
        window.handleLineFileImport = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const importProgress = document.getElementById('importProgress');
            const importProgressBar = document.getElementById('importProgressBar');
            
            if (importProgress) {
                importProgress.style.display = 'block';
            }
            if (importProgressBar) {
                importProgressBar.style.width = '0%';
            }
            
            // 模拟进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                if (progress <= 100 && importProgressBar) {
                    importProgressBar.style.width = `${progress}%`;
                } else {
                    clearInterval(progressInterval);
                }
            }, 200);
            
            // 检查是否已经选择了分类
            const targetCategoryId = e.target.dataset.targetCategoryId;
            let targetCategory = null;
            if (targetCategoryId) {
                targetCategory = AppState.lineCategories.find(c => c.id === targetCategoryId);
            }
            
            // 检查文件类型
            if (file.name.endsWith('.txt')) {
                // 处理文本文件
                const reader = new FileReader();
                reader.onload = function(event) {
                    const content = event.target.result;
                    // 解析文本内容
                    const lines = parseTextContent(content);
                    
                    if (targetCategory) {
                        // 如果已经选择了分类，直接添加
                        addLinesToCategory(targetCategory.name, lines);
                    } else {
                        // 询问用户选择分类
                        const category = prompt('请输入要添加到的分类名称：');
                        if (category) {
                            addLinesToCategory(category, lines);
                        }
                    }
                    
                    // 隐藏进度条
                    if (importProgress) {
                        importProgress.style.display = 'none';
                    }
                    
                    // 清空文件输入和目标分类ID
                    e.target.value = '';
                    delete e.target.dataset.targetCategoryId;
                    
                    // 重新渲染分类
                    renderLineCategories();
                };
                reader.readAsText(file, 'utf-8');
            } else if (file.name.endsWith('.docx')) {
                // 处理Word文件（简化处理，实际需要更复杂的解析）
                alert('Word文件导入功能将在后续版本实现，当前版本仅支持文本文件导入');
                
                // 隐藏进度条
                if (importProgress) {
                    importProgress.style.display = 'none';
                }
                
                // 清空文件输入和目标分类ID
                e.target.value = '';
                delete e.target.dataset.targetCategoryId;
            } else {
                // 不支持的文件类型
                alert('仅支持.txt格式文件导入');
                
                // 隐藏进度条
                if (importProgress) {
                    importProgress.style.display = 'none';
                }
                
                // 清空文件输入和目标分类ID
                e.target.value = '';
                delete e.target.dataset.targetCategoryId;
            }
        }
        
        // 解析文本内容
        function parseTextContent(content) {
            // 简单的文本解析，按标题和内容分割
            const lines = [];
            const paragraphs = content.split('\n\n');
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    // 简单处理：如果段落以数字或标题标记开头，作为标题
                    const trimmed = paragraph.trim();
                    if (trimmed.match(/^\d+\.|^#|^【|^\[|^\(|^\{/)) {
                        // 作为标题，下一段作为内容
                        const nextParagraph = paragraphs[paragraphs.indexOf(paragraph) + 1];
                        if (nextParagraph && !nextParagraph.trim().match(/^\d+\.|^#|^【|^\[|^\(|^\{/)) {
                            lines.push({
                                title: trimmed,
                                content: nextParagraph.trim()
                            });
                        } else {
                            // 只有标题没有内容
                            lines.push({
                                title: trimmed,
                                content: ''
                            });
                        }
                    } else {
                        // 作为普通内容
                        lines.push({
                            title: `台词${lines.length + 1}`,
                            content: trimmed
                        });
                    }
                }
            });
            
            return lines;
        }
        
        // 将台词添加到分类
        function addLinesToCategory(categoryName, lines) {
            let category = AppState.lineCategories.find(c => c.name === categoryName);
            
            if (!category) {
                // 如果分类不存在，创建新分类
                const description = prompt(`请输入"${categoryName}"分类的描述：`);
                category = {
                    id: Date.now().toString(),
                    name: categoryName,
                    description: description || `${categoryName}描述`,
                    items: []
                };
                AppState.lineCategories.push(category);
            }
            
            // 添加台词
            lines.forEach(line => {
                const newItem = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    title: line.title,
                    content: line.content,
                    createdAt: new Date().toISOString()
                };
                category.items.push(newItem);
            });
            
            saveData();
            renderLineCategories();
            alert(`成功添加${lines.length}条台词到"${categoryName}"分类`);
        }
        
        // 添加目录
        function addDirectory() {
            const directoryName = prompt('请输入目录名称：');
            if (!directoryName) return;
            
            const category = prompt('请输入要添加到的分类名称：');
            if (!category) return;
            
            const targetCategory = AppState.lineCategories.find(c => c.name === category);
            if (!targetCategory) {
                alert(`分类"${category}"不存在`);
                return;
            }
            
            // 检查分类是否已有目录结构，如果没有则添加
            if (!targetCategory.directories) {
                targetCategory.directories = [];
            }
            
            const newDirectory = {
                id: Date.now().toString(),
                name: directoryName,
                items: []
            };
            
            targetCategory.directories.push(newDirectory);
            saveData();
            renderLineCategories();
            alert(`成功添加目录"${directoryName}"到"${category}"分类`);
        }
        
        // 渲染台词分类
        function renderLineCategories() {
            const container = document.querySelector('.lines-categories');
            if (!container) return;
            
            container.innerHTML = AppState.lineCategories.map(category => `
                <div class="category-card" data-category-id="${category.id}">
                    <div class="category-title">
                        <span>${category.name}</span>
                        <span class="category-count">${category.items.length}</span>
                        ${category.directories && category.directories.length > 0 ? `<span class="category-count" style="background: var(--info);">${category.directories.length}个目录</span>` : ''}
                    </div>
                    <div class="category-desc">${category.description}</div>
                    
                    <!-- 目录列表 -->
                    ${category.directories && category.directories.length > 0 ? `
                        <div class="directories-list" style="margin: 10px 0; padding-left: 20px;">
                            <h5 style="margin-bottom: 5px; color: var(--dark);">目录：</h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${category.directories.map(dir => `
                                    <li style="margin: 5px 0; padding: 5px; background: #f9f9f9; border-radius: 4px;">
                                        <i class="fas fa-folder"></i> ${dir.name} (${dir.items.length}条内容)
                                        <button class="btn btn-small btn-primary" style="margin-left: 10px;" onclick="addItemToDirectory('${category.id}', '${dir.id}')">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                        <button class="btn btn-small btn-secondary" onclick="viewCategoryItems('${category.id}')">
                            <i class="fas fa-eye"></i> 查看所有内容
                        </button>
                        <button class="btn btn-small btn-primary" onclick="addCategoryItem('${category.id}')">
                            <i class="fas fa-plus"></i> 添加内容
                        </button>
                        <button class="btn btn-small btn-info" onclick="importLinesToCategory('${category.id}')">
                            <i class="fas fa-file-import"></i> 导入内容
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // 向目录添加内容
        window.addItemToDirectory = function(categoryId, directoryId) {
            const category = AppState.lineCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            const directory = category.directories.find(d => d.id === directoryId);
            if (!directory) return;
            
            // 使用模态框添加内容
            const addContentTitle = document.getElementById('addContentTitle');
            const contentTitle = document.getElementById('contentTitle');
            const contentText = document.getElementById('contentText');
            const contentCategory = document.getElementById('contentCategory');
            const contentDirectory = document.getElementById('contentDirectory');
            const directorySelectGroup = document.getElementById('directorySelectGroup');
            
            if (!addContentTitle || !contentTitle || !contentText || !contentCategory || !contentDirectory || !directorySelectGroup) return;
            
            // 设置标题
            addContentTitle.textContent = `添加内容到 "${category.name} - ${directory.name}"`;
            
            // 清空表单
            contentTitle.value = '';
            contentText.value = '';
            
            // 设置分类选项
            contentCategory.innerHTML = '';
            AppState.lineCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (cat.id === category.id) {
                    option.selected = true;
                }
                contentCategory.appendChild(option);
            });
            
            // 更新分类选择事件
            contentCategory.addEventListener('change', function() {
                const selectedCategoryId = this.value;
                const selectedCategory = AppState.lineCategories.find(c => c.id === selectedCategoryId);
                
                // 更新目录选项
                if (selectedCategory && selectedCategory.directories && selectedCategory.directories.length > 0) {
                    directorySelectGroup.style.display = 'block';
                    contentDirectory.innerHTML = '<option value="">不选择目录</option>';
                    selectedCategory.directories.forEach(dir => {
                        const option = document.createElement('option');
                        option.value = dir.id;
                        option.textContent = dir.name;
                        if (dir.id === directory.id) {
                            option.selected = true;
                        }
                        contentDirectory.appendChild(option);
                    });
                } else {
                    directorySelectGroup.style.display = 'none';
                    contentDirectory.innerHTML = '<option value="">不选择目录</option>';
                }
            });
            
            // 触发一次change事件，更新目录选项
            contentCategory.dispatchEvent(new Event('change'));
            
            // 打开模态框
            openModal('addContentModal');
        }
        
        // 向分类导入内容
        window.importLinesToCategory = function(categoryId) {
            const category = AppState.lineCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            // 触发文件输入
            const fileInput = document.getElementById('lineFileInput');
            if (fileInput) {
                // 保存当前分类ID到文件输入元素
                fileInput.dataset.targetCategoryId = categoryId;
                fileInput.click();
            }
        }
        
        // 关闭模态框
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // 打开模态框
        window.openModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        // 删除内容项函数
        window.deleteContentItem = function(categoryId, directoryName, index) {
            if (!confirm('确定要删除这个内容项吗？删除后将无法恢复。')) {
                return;
            }
            
            // 找到对应的分类
            const category = AppState.lineCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            let updated = false;
            
            if (directoryName) {
                // 删除目录内的内容
                const directory = category.directories.find(dir => dir.id === directoryName);
                if (directory && directory.items && directory.items[index]) {
                    directory.items.splice(index, 1);
                    updated = true;
                }
            } else {
                // 删除直接内容
                if (category.items && category.items[index]) {
                    category.items.splice(index, 1);
                    updated = true;
                }
            }
            
            if (updated) {
                // 保存数据到本地存储
                localStorage.setItem('lineCategories', JSON.stringify(AppState.lineCategories));
                // 重新渲染内容
                viewCategoryItems(categoryId);
                // 重新渲染分类列表
                renderLineCategories();
            }
        }
        
        // 重写查看内容函数，显示具体内容
        window.viewCategoryItems = function(categoryId) {
            const category = AppState.lineCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            const contentViewArea = document.getElementById('contentViewArea');
            const contentViewTitle = document.getElementById('contentViewTitle');
            const contentViewToc = document.getElementById('contentViewToc');
            const contentViewTocList = document.getElementById('contentViewTocList');
            const contentSearchInput = document.getElementById('contentSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (!contentViewArea || !contentViewTitle || !contentSearchInput || !clearSearchBtn) return;
            
            // 设置标题
            contentViewTitle.textContent = `${category.name} - 内容查看`;
            
            // 生成内容HTML和原始内容数据
            let contentHtml = '';
            let tocHtml = '';
            let hasItems = false;
            
            // 存储原始内容，用于搜索
            const originalContent = {
                directItems: category.items || [],
                directories: category.directories || []
            };
            
            // 生成完整内容HTML
            function generateContentHtml(items, directoryName = null) {
                let html = '';
                let toc = '';
                
                items.forEach((item, index) => {
                    const id = directoryName ? `dir-item-${directoryName}-${index}` : `content-item-${index}`;
                    html += `
                        <div class="content-item" data-item-id="${id}" data-title="${item.title}" data-content="${item.content}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 id="${id}" style="margin: 0; color: var(--primary);">${item.title}</h4>
                                <button class="btn btn-small btn-danger" onclick="deleteContentItem('${category.id}', '${directoryName || ''}', ${index})" title="删除内容">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div style="line-height: 1.8; color: var(--dark); white-space: pre-wrap;">${item.content}</div>
                            <div style="margin-top: 10px; font-size: 0.8rem; color: var(--gray);">
                                添加时间: ${new Date(item.createdAt).toLocaleString()}
                            </div>
                        </div>
                    `;
                    
                    // 添加目录项
                    toc += `<li><a href="#${id}" style="color: var(--primary); text-decoration: none;">${item.title}</a></li>`;
                });
                
                return { html, toc };
            }
            
            // 显示分类下的所有内容
            if (originalContent.directItems.length > 0) {
                hasItems = true;
                contentHtml += '<h3>直接内容</h3>';
                const directContent = generateContentHtml(originalContent.directItems);
                contentHtml += directContent.html;
                tocHtml += directContent.toc;
            }
            
            // 显示目录下的内容
            if (originalContent.directories.length > 0) {
                originalContent.directories.forEach(dir => {
                    if (dir.items && dir.items.length > 0) {
                        hasItems = true;
                        contentHtml += `<h3>${dir.name}</h3>`;
                        const dirContent = generateContentHtml(dir.items, dir.id);
                        contentHtml += dirContent.html;
                        tocHtml += `<li style="margin-left: 15px;"><ul>${dirContent.toc}</ul></li>`;
                    }
                });
            }
            
            // 如果没有内容
            if (!hasItems) {
                contentHtml = '<div style="text-align: center; color: var(--gray); padding: 50px 0;"><i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 10px;"></i><p>暂无内容</p></div>';
                contentViewToc.style.display = 'none';
            } else {
                // 更新目录
                contentViewTocList.innerHTML = tocHtml;
                contentViewToc.style.display = 'block';
            }
            
            // 保存原始HTML内容
            const fullContentHtml = contentHtml;
            
            // 设置内容
            contentViewArea.innerHTML = fullContentHtml;
            
            // 显示搜索功能
            contentSearchInput.style.display = 'block';
            clearSearchBtn.style.display = 'block';
            
            // 实现搜索功能
            function performSearch(keyword) {
                if (!keyword.trim()) {
                    // 如果关键词为空，显示完整内容
                    contentViewArea.innerHTML = fullContentHtml;
                    return;
                }
                
                let searchResultsHtml = '';
                let hasResults = false;
                
                // 高亮关键词函数
                function highlightText(text, keyword) {
                    if (!keyword) return text;
                    const regex = new RegExp(`(${keyword})`, 'gi');
                    return text.replace(regex, '<span style="background-color: #ffff00; color: #000;">$1</span>');
                }
                
                // 搜索直接内容
                if (originalContent.directItems.length > 0) {
                    const matchingDirectItems = originalContent.directItems.filter(item => 
                        item.title.toLowerCase().includes(keyword.toLowerCase()) || 
                        item.content.toLowerCase().includes(keyword.toLowerCase())
                    );
                    
                    if (matchingDirectItems.length > 0) {
                        hasResults = true;
                        searchResultsHtml += '<h3>直接内容 (匹配: ' + matchingDirectItems.length + ')</h3>';
                        matchingDirectItems.forEach((item, index) => {
                            // 找到原始索引
                            const originalIndex = originalContent.directItems.findIndex(i => i.title === item.title && i.content === item.content);
                            searchResultsHtml += `
                                <div class="content-item" data-item-id="content-item-${index}">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h4 id="content-item-${index}" style="margin: 0; color: var(--primary);">${highlightText(item.title, keyword)}</h4>
                                        <button class="btn btn-small btn-danger" onclick="deleteContentItem('${category.id}', '', ${originalIndex})" title="删除内容">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div style="line-height: 1.8; color: var(--dark); white-space: pre-wrap;">${highlightText(item.content, keyword)}</div>
                                    <div style="margin-top: 10px; font-size: 0.8rem; color: var(--gray);">
                                        添加时间: ${new Date(item.createdAt).toLocaleString()}
                                    </div>
                                </div>
                            `;
                        });
                    }
                }
                
                // 搜索目录内容
                originalContent.directories.forEach(dir => {
                    if (dir.items && dir.items.length > 0) {
                        const matchingDirItems = dir.items.filter(item => 
                            item.title.toLowerCase().includes(keyword.toLowerCase()) || 
                            item.content.toLowerCase().includes(keyword.toLowerCase())
                        );
                        
                        if (matchingDirItems.length > 0) {
                            hasResults = true;
                            searchResultsHtml += `<h3>${dir.name} (匹配: ${matchingDirItems.length})</h3>`;
                            matchingDirItems.forEach((item, index) => {
                                // 找到原始索引
                                const originalIndex = dir.items.findIndex(i => i.title === item.title && i.content === item.content);
                                searchResultsHtml += `
                                    <div class="content-item" data-item-id="dir-item-${dir.id}-${index}">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <h4 id="dir-item-${dir.id}-${index}" style="margin: 0; color: var(--primary);">${highlightText(item.title, keyword)}</h4>
                                            <button class="btn btn-small btn-danger" onclick="deleteContentItem('${category.id}', '${dir.id}', ${originalIndex})" title="删除内容">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div style="line-height: 1.8; color: var(--dark); white-space: pre-wrap;">${highlightText(item.content, keyword)}</div>
                                        <div style="margin-top: 10px; font-size: 0.8rem; color: var(--gray);">
                                            添加时间: ${new Date(item.createdAt).toLocaleString()}
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    }
                });
                
                // 显示搜索结果
                if (!hasResults) {
                    contentViewArea.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 50px 0;"><i class="fas fa-search" style="font-size: 3rem; margin-bottom: 10px;"></i><p>未找到匹配内容</p></div>';
                } else {
                    contentViewArea.innerHTML = searchResultsHtml;
                }
            }
            
            // 清空搜索
            function clearSearch() {
                contentSearchInput.value = '';
                contentViewArea.innerHTML = fullContentHtml;
            }
            
            // 添加搜索事件监听器
            contentSearchInput.addEventListener('input', function() {
                performSearch(this.value);
            });
            
            // 添加清空搜索按钮事件
            clearSearchBtn.addEventListener('click', clearSearch);
            
            // 清空之前的搜索
            clearSearch();
            
            // 保存当前查看的分类和原始内容
            window.currentViewingCategory = category;
            window.currentViewingContent = originalContent;
            
            // 打开模态框
            openModal('contentViewModal');
        }
        
        // 重写添加内容函数，使用模态框
        window.addCategoryItem = function(categoryId) {
            const category = AppState.lineCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            const addContentTitle = document.getElementById('addContentTitle');
            const contentTitle = document.getElementById('contentTitle');
            const contentText = document.getElementById('contentText');
            const contentCategory = document.getElementById('contentCategory');
            const contentDirectory = document.getElementById('contentDirectory');
            const directorySelectGroup = document.getElementById('directorySelectGroup');
            
            if (!addContentTitle || !contentTitle || !contentText || !contentCategory || !contentDirectory || !directorySelectGroup) return;
            
            // 设置标题
            addContentTitle.textContent = `添加内容到 "${category.name}"`;
            
            // 清空表单
            contentTitle.value = '';
            contentText.value = '';
            
            // 设置分类选项
            contentCategory.innerHTML = '';
            AppState.lineCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (cat.id === category.id) {
                    option.selected = true;
                }
                contentCategory.appendChild(option);
            });
            
            // 更新分类选择事件
            contentCategory.addEventListener('change', function() {
                const selectedCategoryId = this.value;
                const selectedCategory = AppState.lineCategories.find(c => c.id === selectedCategoryId);
                
                // 更新目录选项
                if (selectedCategory && selectedCategory.directories && selectedCategory.directories.length > 0) {
                    directorySelectGroup.style.display = 'block';
                    contentDirectory.innerHTML = '<option value="">不选择目录</option>';
                    selectedCategory.directories.forEach(dir => {
                        const option = document.createElement('option');
                        option.value = dir.id;
                        option.textContent = dir.name;
                        contentDirectory.appendChild(option);
                    });
                } else {
                    directorySelectGroup.style.display = 'none';
                    contentDirectory.innerHTML = '<option value="">不选择目录</option>';
                }
            });
            
            // 触发一次change事件，更新目录选项
            contentCategory.dispatchEvent(new Event('change'));
            
            // 保存当前分类ID
            window.currentAddingCategoryId = categoryId;
            
            // 打开模态框
            openModal('addContentModal');
        }
        
        // 保存内容
        function saveContent() {
            const contentTitle = document.getElementById('contentTitle');
            const contentText = document.getElementById('contentText');
            const contentCategory = document.getElementById('contentCategory');
            const contentDirectory = document.getElementById('contentDirectory');
            
            if (!contentTitle || !contentText || !contentCategory || !contentDirectory) return;
            
            const title = contentTitle.value.trim();
            const content = contentText.value.trim();
            const categoryId = contentCategory.value;
            const directoryId = contentDirectory.value;
            
            if (!title || !content) {
                alert('请填写完整的标题和内容');
                return;
            }
            
            const category = AppState.lineCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            const newItem = {
                id: Date.now().toString(),
                title,
                content,
                createdAt: new Date().toISOString()
            };
            
            if (directoryId) {
                // 添加到目录
                const directory = category.directories.find(d => d.id === directoryId);
                if (directory) {
                    directory.items.push(newItem);
                }
            } else {
                // 直接添加到分类
                category.items.push(newItem);
            }
            
            // 保存数据
            saveData();
            
            // 重新渲染
            renderLineCategories();
            
            // 关闭模态框
            closeModal('addContentModal');
            
            // 清空表单
            contentTitle.value = '';
            contentText.value = '';
        }
        
        // 导出当前查看的内容
        function exportCurrentContent() {
            if (!window.currentViewingCategory) return;
            
            const category = window.currentViewingCategory;
            
            // 生成HTML内容用于Word文档
            let htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>${category.name}</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', SimSun, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 20px;
        }
        
        /* 选中卡片样式 */
        .content-card.active {
            border: 2px solid var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.2) !important;
            background-color: rgba(233, 30, 99, 0.05) !important;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }
        .content-section {
            margin-bottom: 30px;
        }
        .content-item {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .item-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .item-content {
            white-space: pre-wrap;
        }
        .item-meta {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>${category.name}</h1>
`;
            
            // 添加直接内容
            if (category.items && category.items.length > 0) {
                htmlContent += `
    <h2>直接内容</h2>
`;
                category.items.forEach(item => {
                    htmlContent += `
    <div class="content-item">
        <div class="item-title">${item.title}</div>
        <div class="item-content">${item.content}</div>
        <div class="item-meta">添加时间: ${new Date(item.createdAt).toLocaleString()}</div>
    </div>
`;
                });
            }
            
            // 添加目录内容
            if (category.directories && category.directories.length > 0) {
                category.directories.forEach(dir => {
                    if (dir.items && dir.items.length > 0) {
                        htmlContent += `
    <h2>${dir.name}</h2>
`;
                        dir.items.forEach(item => {
                            htmlContent += `
    <div class="content-item">
        <div class="item-title">${item.title}</div>
        <div class="item-content">${item.content}</div>
        <div class="item-meta">添加时间: ${new Date(item.createdAt).toLocaleString()}</div>
    </div>
`;
                        });
                    }
                });
            }
            
            htmlContent += `
</body>
</html>
`;
            
            // 下载为Word文档
            const blob = new Blob([htmlContent], { type: 'application/msword;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${category.name}_内容.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 渲染活动合同
        function renderContracts() {
            const container = document.querySelector('.contracts-list');
            if (!container) return;
            
            container.innerHTML = AppState.contracts.map(contract => `
                <div class="content-card" data-contract-id="${contract.id}" onclick="selectCard(this, 'contract')">
                    <div class="content-title">${contract.name}</div>
                    <div class="content-meta">
                        <span class="badge badge-${contract.type === 'wedding' ? 'primary' : 'info'}">
                            ${contract.type === 'wedding' ? '婚礼合同' : '商务合同'}
                        </span>
                    </div>
                    <div class="content-preview">${contract.content.substring(0, 100)}...</div>
                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); viewContract('${contract.id}')">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); editContract('${contract.id}')">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // 渲染互动游戏
        function renderGames() {
            const container = document.querySelector('.games-list');
            if (!container) return;
            
            container.innerHTML = AppState.games.map(game => `
                <div class="content-card" data-game-id="${game.id}" onclick="selectCard(this, 'game')">
                    <div class="content-title">${game.name}</div>
                    <div class="content-desc">${game.description}</div>
                    <div class="content-preview">${game.instructions.substring(0, 100)}...</div>
                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); viewGame('${game.id}')">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); editGame('${game.id}')">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // 渲染婚礼发言稿
        function renderSpeeches() {
            const container = document.querySelector('.speeches-list');
            if (!container) return;
            
            container.innerHTML = AppState.speeches.map(speech => `
                <div class="content-card" data-speech-id="${speech.id}" onclick="selectCard(this, 'speech')">
                    <div class="content-title">${speech.name}</div>
                    <div class="content-meta">
                        <span class="badge badge-primary">${speech.role}</span>
                    </div>
                    <div class="content-preview">${speech.content.substring(0, 100)}...</div>
                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); viewSpeech('${speech.id}')">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); editSpeech('${speech.id}')">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // 卡片选择函数
        window.selectCard = function(card, type) {
            // 移除同类型所有卡片的选中状态
            const cards = document.querySelectorAll(`.${type}s-list .content-card`);
            cards.forEach(c => c.classList.remove('active'));
            
            // 添加当前卡片的选中状态
            card.classList.add('active');
        }
        
        // 台词分类相关函数
        function addLineCategory() {
            const name = prompt('请输入分类名称：');
            if (!name) return;
            
            const description = prompt('请输入分类描述：');
            if (!description) return;
            
            const newCategory = {
                id: Date.now().toString(),
                name,
                description,
                items: []
            };
            
            AppState.lineCategories.push(newCategory);
            saveData();
            renderLineCategories();
        }
        
        function editLineCategory() {
            // 这里可以实现编辑分类功能
            alert('编辑分类功能将在后续版本实现');
        }
        

        
        function addCategoryItem(categoryId) {
            const category = AppState.lineCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            const title = prompt('请输入内容标题：');
            if (!title) return;
            
            const content = prompt('请输入内容：');
            if (!content) return;
            
            const newItem = {
                id: Date.now().toString(),
                title,
                content,
                createdAt: new Date().toISOString()
            };
            
            category.items.push(newItem);
            saveData();
            renderLineCategories();
        }
        
        // 合同相关函数
        // 添加合同函数
        window.addContract = function() {
            // 清空表单
            document.getElementById('addContractName').value = '';
            document.querySelector('input[name="addContractType"][value="wedding"]').checked = true;
            document.getElementById('addContractContent').value = '';
            
            // 打开模态框
            openModal('addContractModal');
        }
        
        // 保存添加的合同
        window.saveAddContract = function() {
            // 获取表单数据
            const addContractName = document.getElementById('addContractName');
            const addContractType = document.querySelector('input[name="addContractType"]:checked');
            const addContractContent = document.getElementById('addContractContent');
            
            if (!addContractName || !addContractType || !addContractContent) return;
            
            const name = addContractName.value.trim();
            const type = addContractType.value;
            const content = addContractContent.value.trim();
            
            // 验证数据
            if (!name || !content) {
                alert('请填写完整的合同信息');
                return;
            }
            
            // 创建新合同
            const newContract = {
                id: Date.now().toString(),
                name,
                type,
                content
            };
            
            // 保存数据并刷新
            AppState.contracts.push(newContract);
            saveData();
            renderContracts();
            
            // 关闭模态框
            closeModal('addContractModal');
        }
        
        // 编辑合同函数
        window.editContract = function(contractId) {
            let contract;
            if (typeof contractId === 'string') {
                contract = AppState.contracts.find(c => c.id === contractId);
            } else {
                // 如果是点击编辑按钮，找到选中的合同
                const activeCard = document.querySelector('.contracts-list .content-card.active');
                if (!activeCard) {
                    alert('请先选择一个合同');
                    return;
                }
                contract = AppState.contracts.find(c => c.id === activeCard.dataset.contractId);
            }
            
            if (!contract) return;
            
            // 获取模态框元素
            const editContractName = document.getElementById('editContractName');
            const editContractTypeWedding = document.querySelector('input[name="editContractType"][value="wedding"]');
            const editContractTypeBusiness = document.querySelector('input[name="editContractType"][value="business"]');
            const editContractContent = document.getElementById('editContractContent');
            
            if (!editContractName || !editContractTypeWedding || !editContractTypeBusiness || !editContractContent) return;
            
            // 填充表单数据
            editContractName.value = contract.name;
            if (contract.type === 'wedding') {
                editContractTypeWedding.checked = true;
            } else {
                editContractTypeBusiness.checked = true;
            }
            editContractContent.value = contract.content;
            
            // 保存当前编辑的合同
            window.currentEditingContract = contract;
            
            // 打开模态框
            openModal('editContractModal');
        }
        
        // 保存编辑后的合同
        window.saveEditContract = function() {
            if (!window.currentEditingContract) return;
            
            const contract = window.currentEditingContract;
            
            // 获取表单数据
            const editContractName = document.getElementById('editContractName');
            const editContractType = document.querySelector('input[name="editContractType"]:checked');
            const editContractContent = document.getElementById('editContractContent');
            
            if (!editContractName || !editContractType || !editContractContent) return;
            
            // 更新合同数据
            contract.name = editContractName.value.trim();
            contract.type = editContractType.value;
            contract.content = editContractContent.value.trim();
            
            // 验证数据
            if (!contract.name || !contract.content) {
                alert('请填写完整的合同名称和内容');
                return;
            }
            
            // 保存数据并刷新
            saveData();
            renderContracts();
            
            // 关闭模态框
            closeModal('editContractModal');
            
            // 清除当前编辑的合同
            window.currentEditingContract = null;
        }
        
        window.viewContract = function(contractId) {
            const contract = AppState.contracts.find(c => c.id === contractId);
            if (!contract) return;
            
            const contentViewArea = document.getElementById('contentViewArea');
            const contentViewTitle = document.getElementById('contentViewTitle');
            const contentViewToc = document.getElementById('contentViewToc');
            const contentSearchInput = document.getElementById('contentSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (!contentViewArea || !contentViewTitle) return;
            
            // 设置标题
            contentViewTitle.textContent = `${contract.name} - 合同查看`;
            
            // 生成内容HTML
            const contentHtml = `
                <div class="contract-content">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${contract.name}</h3>
                    <div class="contract-type" style="margin-bottom: 20px;">
                        <span class="badge badge-${contract.type === 'wedding' ? 'primary' : 'info'}">
                            ${contract.type === 'wedding' ? '婚礼合同' : '商务合同'}
                        </span>
                    </div>
                    <div style="line-height: 1.8; color: var(--dark); white-space: pre-wrap; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        ${contract.content}
                    </div>
                </div>
            `;
            
            // 设置内容
            contentViewArea.innerHTML = contentHtml;
            
            // 隐藏目录和搜索功能
            if (contentViewToc) {
                contentViewToc.style.display = 'none';
            }
            if (contentSearchInput) {
                contentSearchInput.style.display = 'none';
            }
            if (clearSearchBtn) {
                clearSearchBtn.style.display = 'none';
            }
            
            // 保存当前查看的内容
            window.currentViewingContent = contract;
            
            // 打开模态框
            openModal('contentViewModal');
        }
        
        // 游戏相关函数
        // 添加游戏函数
        window.addGame = function() {
            // 清空表单
            document.getElementById('addGameName').value = '';
            document.getElementById('addGameDescription').value = '';
            document.getElementById('addGameInstructions').value = '';
            
            // 打开模态框
            openModal('addGameModal');
        }
        
        // 保存添加的游戏
        window.saveAddGame = function() {
            // 获取表单数据
            const addGameName = document.getElementById('addGameName');
            const addGameDescription = document.getElementById('addGameDescription');
            const addGameInstructions = document.getElementById('addGameInstructions');
            
            if (!addGameName || !addGameDescription || !addGameInstructions) return;
            
            const name = addGameName.value.trim();
            const description = addGameDescription.value.trim();
            const instructions = addGameInstructions.value.trim();
            
            // 验证数据
            if (!name || !description || !instructions) {
                alert('请填写完整的游戏信息');
                return;
            }
            
            // 创建新游戏
            const newGame = {
                id: Date.now().toString(),
                name,
                description,
                instructions
            };
            
            // 保存数据并刷新
            AppState.games.push(newGame);
            saveData();
            renderGames();
            
            // 关闭模态框
            closeModal('addGameModal');
        }
        
        // 编辑游戏函数
        window.editGame = function(gameId) {
            let game;
            if (typeof gameId === 'string') {
                game = AppState.games.find(g => g.id === gameId);
            } else {
                // 如果是点击编辑按钮，找到选中的游戏
                const activeCard = document.querySelector('.games-list .content-card.active');
                if (!activeCard) {
                    alert('请先选择一个游戏');
                    return;
                }
                game = AppState.games.find(g => g.id === activeCard.dataset.gameId);
            }
            
            if (!game) return;
            
            // 获取模态框元素
            const editGameName = document.getElementById('editGameName');
            const editGameDescription = document.getElementById('editGameDescription');
            const editGameInstructions = document.getElementById('editGameInstructions');
            
            if (!editGameName || !editGameDescription || !editGameInstructions) return;
            
            // 填充表单数据
            editGameName.value = game.name;
            editGameDescription.value = game.description;
            editGameInstructions.value = game.instructions;
            
            // 保存当前编辑的游戏
            window.currentEditingGame = game;
            
            // 打开模态框
            openModal('editGameModal');
        }
        
        // 保存编辑后的游戏
        window.saveEditGame = function() {
            if (!window.currentEditingGame) return;
            
            const game = window.currentEditingGame;
            
            // 获取表单数据
            const editGameName = document.getElementById('editGameName');
            const editGameDescription = document.getElementById('editGameDescription');
            const editGameInstructions = document.getElementById('editGameInstructions');
            
            if (!editGameName || !editGameDescription || !editGameInstructions) return;
            
            // 更新游戏数据
            game.name = editGameName.value.trim();
            game.description = editGameDescription.value.trim();
            game.instructions = editGameInstructions.value.trim();
            
            // 验证数据
            if (!game.name || !game.description || !game.instructions) {
                alert('请填写完整的游戏信息');
                return;
            }
            
            // 保存数据并刷新
            saveData();
            renderGames();
            
            // 关闭模态框
            closeModal('editGameModal');
            
            // 清除当前编辑的游戏
            window.currentEditingGame = null;
        }
        
        window.viewGame = function(gameId) {
            const game = AppState.games.find(g => g.id === gameId);
            if (!game) return;
            
            const contentViewArea = document.getElementById('contentViewArea');
            const contentViewTitle = document.getElementById('contentViewTitle');
            const contentViewToc = document.getElementById('contentViewToc');
            const contentSearchInput = document.getElementById('contentSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (!contentViewArea || !contentViewTitle) return;
            
            // 设置标题
            contentViewTitle.textContent = `${game.name} - 游戏查看`;
            
            // 生成内容HTML
            const contentHtml = `
                <div class="game-content">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${game.name}</h3>
                    <div class="game-description" style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                        <strong>游戏描述：</strong>
                        <p style="margin: 10px 0 0 0;">${game.description}</p>
                    </div>
                    <div class="game-instructions" style="margin-bottom: 20px;">
                        <h4 style="color: var(--dark); margin-bottom: 10px;">游戏规则：</h4>
                        <div style="line-height: 1.8; color: var(--dark); white-space: pre-wrap; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ${game.instructions}
                        </div>
                    </div>
                </div>
            `;
            
            // 设置内容
            contentViewArea.innerHTML = contentHtml;
            
            // 隐藏目录和搜索功能
            if (contentViewToc) {
                contentViewToc.style.display = 'none';
            }
            if (contentSearchInput) {
                contentSearchInput.style.display = 'none';
            }
            if (clearSearchBtn) {
                clearSearchBtn.style.display = 'none';
            }
            
            // 保存当前查看的内容
            window.currentViewingContent = game;
            
            // 打开模态框
            openModal('contentViewModal');
        }
        
        // 发言稿相关函数
        // 添加发言稿函数
        window.addSpeech = function() {
            // 清空表单
            document.getElementById('addSpeechName').value = '';
            document.getElementById('addSpeechRole').value = '';
            document.getElementById('addSpeechContent').value = '';
            
            // 打开模态框
            openModal('addSpeechModal');
        }
        
        // 保存添加的发言稿
        window.saveAddSpeech = function() {
            // 获取表单数据
            const addSpeechName = document.getElementById('addSpeechName');
            const addSpeechRole = document.getElementById('addSpeechRole');
            const addSpeechContent = document.getElementById('addSpeechContent');
            
            if (!addSpeechName || !addSpeechRole || !addSpeechContent) return;
            
            const name = addSpeechName.value.trim();
            const role = addSpeechRole.value.trim();
            const content = addSpeechContent.value.trim();
            
            // 验证数据
            if (!name || !role || !content) {
                alert('请填写完整的发言稿信息');
                return;
            }
            
            // 创建新发言稿
            const newSpeech = {
                id: Date.now().toString(),
                name,
                role,
                content
            };
            
            // 保存数据并刷新
            AppState.speeches.push(newSpeech);
            saveData();
            renderSpeeches();
            
            // 关闭模态框
            closeModal('addSpeechModal');
        }
        
        // 编辑发言稿函数
        window.editSpeech = function(speechId) {
            let speech;
            if (typeof speechId === 'string') {
                speech = AppState.speeches.find(s => s.id === speechId);
            } else {
                // 如果是点击编辑按钮，找到选中的发言稿
                const activeCard = document.querySelector('.speeches-list .content-card.active');
                if (!activeCard) {
                    alert('请先选择一个发言稿');
                    return;
                }
                speech = AppState.speeches.find(s => s.id === activeCard.dataset.speechId);
            }
            
            if (!speech) return;
            
            // 获取模态框元素
            const editSpeechName = document.getElementById('editSpeechName');
            const editSpeechRole = document.getElementById('editSpeechRole');
            const editSpeechContent = document.getElementById('editSpeechContent');
            
            if (!editSpeechName || !editSpeechRole || !editSpeechContent) return;
            
            // 填充表单数据
            editSpeechName.value = speech.name;
            editSpeechRole.value = speech.role;
            editSpeechContent.value = speech.content;
            
            // 保存当前编辑的发言稿
            window.currentEditingSpeech = speech;
            
            // 打开模态框
            openModal('editSpeechModal');
        }
        
        // 保存编辑后的发言稿
        window.saveEditSpeech = function() {
            if (!window.currentEditingSpeech) return;
            
            const speech = window.currentEditingSpeech;
            
            // 获取表单数据
            const editSpeechName = document.getElementById('editSpeechName');
            const editSpeechRole = document.getElementById('editSpeechRole');
            const editSpeechContent = document.getElementById('editSpeechContent');
            
            if (!editSpeechName || !editSpeechRole || !editSpeechContent) return;
            
            // 更新发言稿数据
            speech.name = editSpeechName.value.trim();
            speech.role = editSpeechRole.value.trim();
            speech.content = editSpeechContent.value.trim();
            
            // 验证数据
            if (!speech.name || !speech.role || !speech.content) {
                alert('请填写完整的发言稿信息');
                return;
            }
            
            // 保存数据并刷新
            saveData();
            renderSpeeches();
            
            // 关闭模态框
            closeModal('editSpeechModal');
            
            // 清除当前编辑的发言稿
            window.currentEditingSpeech = null;
        }
        
        window.viewSpeech = function(speechId) {
            const speech = AppState.speeches.find(s => s.id === speechId);
            if (!speech) return;
            
            const contentViewArea = document.getElementById('contentViewArea');
            const contentViewTitle = document.getElementById('contentViewTitle');
            const contentViewToc = document.getElementById('contentViewToc');
            const contentSearchInput = document.getElementById('contentSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (!contentViewArea || !contentViewTitle) return;
            
            // 设置标题
            contentViewTitle.textContent = `${speech.name} - 发言稿查看`;
            
            // 生成内容HTML
            const contentHtml = `
                <div class="speech-content">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${speech.name}</h3>
                    <div class="speech-role" style="margin-bottom: 20px;">
                        <span class="badge badge-primary">${speech.role}</span>
                    </div>
                    <div style="line-height: 1.8; color: var(--dark); white-space: pre-wrap; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        ${speech.content}
                    </div>
                </div>
            `;
            
            // 设置内容
            contentViewArea.innerHTML = contentHtml;
            
            // 隐藏目录和搜索功能
            if (contentViewToc) {
                contentViewToc.style.display = 'none';
            }
            if (contentSearchInput) {
                contentSearchInput.style.display = 'none';
            }
            if (clearSearchBtn) {
                clearSearchBtn.style.display = 'none';
            }
            
            // 保存当前查看的内容
            window.currentViewingContent = speech;
            
            // 打开模态框
            openModal('contentViewModal');
        }
        
        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
    
    <!-- 添加html2canvas库用于截图功能 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 手机模拟功能HTML -->
    <button class="toggle-phone-mockup" id="togglePhoneMockup" title="模拟手机UI">
        <i class="fas fa-mobile-alt"></i>
    </button>
    
    <div class="phone-mockup" id="phoneMockup">
        <button class="close-phone-mockup" id="closePhoneMockup">&times;</button>
        <div class="phone-header">
            主持人管家
        </div>
        <div class="phone-content">
            <div class="app-container">
                <!-- 这里会复制整个应用内容 -->
            </div>
        </div>
    </div>
    
    <!-- 移动端导航遮罩 -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
    
    <script>
        // 手机模拟功能
        function setupPhoneMockup() {
            const toggleBtn = document.getElementById('togglePhoneMockup');
            const phoneMockup = document.getElementById('phoneMockup');
            const closeBtn = document.getElementById('closePhoneMockup');
            const phoneContent = phoneMockup.querySelector('.app-container');
            const appContainer = document.querySelector('.app-container');
            
            if (toggleBtn && phoneMockup && closeBtn && phoneContent && appContainer) {
                // 切换手机模拟模式
                toggleBtn.addEventListener('click', function() {
                    phoneMockup.classList.toggle('active');
                    if (phoneMockup.classList.contains('active')) {
                        // 复制应用内容到手机模拟容器
                        phoneContent.innerHTML = appContainer.innerHTML;
                        // 重新初始化事件（简单实现，实际可能需要更复杂的处理）
                        setTimeout(() => {
                            // 重新绑定事件
                            setupNavigation();
                            setupViewToggle();
                            setupYearToggle();
                        }, 100);
                    }
                });
                
                // 关闭手机模拟模式
                closeBtn.addEventListener('click', function() {
                    phoneMockup.classList.remove('active');
                });
                
                // 点击模拟手机外部关闭
                phoneMockup.addEventListener('click', function(e) {
                    if (e.target === phoneMockup) {
                        phoneMockup.classList.remove('active');
                    }
                });
            }
        }
        
        // 优化移动端导航
        function optimizeMobileNavigation() {
            const mobileNavToggle = document.getElementById('mobileNavToggle');
            const appNav = document.getElementById('appNav');
            const mobileNavOverlay = document.getElementById('mobileNavOverlay');
            
            if (mobileNavToggle && appNav && mobileNavOverlay) {
                // 展开/收起菜单
                mobileNavToggle.addEventListener('click', function() {
                    appNav.classList.toggle('active');
                    mobileNavOverlay.classList.toggle('active');
                });
                
                // 点击遮罩关闭菜单
                mobileNavOverlay.addEventListener('click', function() {
                    appNav.classList.remove('active');
                    mobileNavOverlay.classList.remove('active');
                });
                
                // 点击导航项后关闭菜单
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        appNav.classList.remove('active');
                        mobileNavOverlay.classList.remove('active');
                    });
                });
            }
        }
        
        // 在页面加载完成后初始化手机模拟功能
        document.addEventListener('DOMContentLoaded', function() {
            setupPhoneMockup();
            optimizeMobileNavigation();
        });
    </script>
</body>
</html>